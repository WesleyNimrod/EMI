<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Information System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
        }
        
        .custom-btn {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
            transition: all 0.3s;
        }
        
        .custom-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
        }
        
        .success-indicator {
            background: rgb(22, 163, 74);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6F2C4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-field {
            border-color: #ef4444 !important;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #6F2C4F;
            color: white;
            text-align: left;
            padding: 8px;
        }

        .data-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .data-table tr:hover {
            background-color: #ddd;
        }

        .data-table td {
            border: 1px solid #ddd;
            padding: 8px;
        }

        .required::after {
            content: " *";
            color: #ef4444;
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        .points-btn {
            font-weight: bold;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            display: inline-flex;
            align-items: center;
            margin-right: 0.5rem;
        }
        
        .points-btn.earned {
            background-color: #10b981;
            color: white;
        }
        
        .points-btn.pending {
            background-color: #f59e0b;
            color: white;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            #summarySection, #summarySection * {
                visibility: visible;
            }
            
            #summarySection {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            
            .no-print {
                display: none !important;
            }
        }
        
        /* Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 24px;
            background-color: #f3f3f3;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 10px;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: width 0.5s ease;
        }
        
        .target-input {
            width: 100px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
        }
        
        .summary-card {
            background-color: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 16px;
        }
        
        .summary-card h3 {
            color: #6F2C4F;
            margin-bottom: 12px;
            font-weight: bold;
            font-size: 1.25rem;
            padding-bottom: 8px;
            border-bottom: 2px solid #f3f3f3;
        }

        /* Fix 2: Make CID and Mobile fields copyable */
        .copyable {
            cursor: pointer;
            position: relative;
            user-select: all;
        }

        .copyable::after {
            content: "Copied!";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copyable.copied::after {
            opacity: 1;
            animation: fadeAfterCopy 1.5s forwards;
        }

        @keyframes fadeAfterCopy {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Fix 1: Increase action buttons spacing */
        .action-column {
            min-width: 120px;
            white-space: nowrap;
        }

        .action-btn {
            margin-right: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        /* Visualizations */
        .visualizations-header {
            background-color: #6F2C4F;
            color: white;
            padding: 10px 16px;
            font-weight: bold;
            border-radius: 4px;
        }
        
        .visualization-container {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .chart-box {
            width: 32%;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .chart-box {
                width: 100%;
            }
        }
        
        .chart-title {
            font-weight: bold;
            color: #6F2C4F;
            text-align: center;
            margin-bottom: 15px;
        }
        
        /* Simple pie charts with CSS */
        .pie-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #6F2C4F 0% 60%, 
                #262a5a 60% 90%, 
                #10b981 90% 100%
            );
            position: relative;
        }
        
        .acc-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #f97316 0% 40%, 
                #0ea5e9 40% 75%, 
                #8b5cf6 75% 100%
            );
            position: relative;
        }
        
        .scheme-chart {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            margin: 0 auto;
            background: conic-gradient(
                #6F2C4F 0% 45%, 
                #262a5a 45% 70%, 
                #10b981 70% 90%, 
                #f97316 90% 100%
            );
            position: relative;
        }
        
        .donut-hole {
            position: absolute;
            width: 90px;
            height: 90px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .chart-legend {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
    </style>
</head>
<body class="bg-gray-50 font-tahoma">
    <div class="container mx-auto px-3 py-2 max-w-6xl">

        
        <!-- Section Navigation Buttons -->
        <div class="mb-4 flex justify-center gap-4 flex-wrap">
            <button id="showEntryBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                <i class="fas fa-file-alt mr-2"></i> Form
            </button>
            <button id="showViewBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
                <i class="fas fa-table mr-2"></i> View
            </button>
            <button id="showSearchBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
                <i class="fas fa-search mr-2"></i> Find
            </button>
            <button id="showSummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
                <i class="fas fa-chart-pie mr-2"></i> Summary
            </button>
        </div>
        
        <!-- Section Content Containers -->
        <div id="entrySection" class="section active">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-primary mb-4">Customer Data Entry</h2>
                
                <form id="entryForm" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Left Column -->
                        <div class="space-y-4">
                            <!-- CID -->
                            <div>
                                <label for="cid" class="block text-gray-700 font-medium required">CID</label>
                                <input type="number" id="cid" name="cid" class="w-full border rounded-md p-2 text-base" required>
                                <p id="cidError" class="text-red-500 text-sm hidden">CID must be unique</p>
                            </div>
                            
                            <!-- App ID -->
                            <div>
                                <label for="appId" class="block text-gray-700 font-medium">App ID</label>
                                <input type="number" id="appId" name="appId" class="w-full border rounded-md p-2 text-base">
                            </div>
                            
                            <!-- Proposition -->
                            <div>
                                <label class="block text-gray-700 font-medium required">Proposition</label>
                                <div class="flex space-x-4 mt-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="proposition" value="Conventional" class="form-radio" checked>
                                        <span class="ml-2 text-gray-700">Conventional</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="proposition" value="Islamic" class="form-radio">
                                        <span class="ml-2 text-gray-700">Islamic</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="proposition" value="Both" class="form-radio">
                                        <span class="ml-2 text-gray-700">Both</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Date -->
                            <div>
                                <label for="date" class="block text-gray-700 font-medium required">Date</label>
                                <input type="date" id="date" name="date" class="w-full border rounded-md p-2 text-base" required>
                            </div>
                            
                            <!-- Salary -->
                            <div>
                                <label for="salary" class="block text-gray-700 font-medium required">Salary</label>
                                <input type="number" id="salary" name="salary" class="w-full border rounded-md p-2 text-base" required>
                            </div>
                            
                            <!-- Customer Name -->
                            <div>
                                <label for="customerName" class="block text-gray-700 font-medium required">Customer Name</label>
                                <input type="text" id="customerName" name="customerName" class="w-full border rounded-md p-2 text-base" required>
                                <p id="nameError" class="text-red-500 text-sm hidden">Customer name must be unique</p>
                            </div>
                            
                            <!-- Mobile -->
                            <div>
                                <label for="mobile" class="block text-gray-700 font-medium required">Mobile</label>
                                <input type="number" id="mobile" name="mobile" class="w-full border rounded-md p-2 text-base" required>
                                <p id="mobileError" class="text-red-500 text-sm hidden">Mobile number must be unique</p>
                            </div>
                            
                            <!-- Company Name (Moved here as requested in Fix 5) -->
                            <div>
                                <label for="companyName" class="block text-gray-700 font-medium">Company Name</label>
                                <input type="text" id="companyName" name="companyName" class="w-full border rounded-md p-2 text-base">
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="space-y-4">
                            <!-- Products -->
                            <div>
                                <label class="block text-gray-700 font-medium required">Products</label>
                                <div class="grid grid-cols-2 gap-2 mt-2">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="ACC" class="form-checkbox" id="productACC">
                                        <span class="ml-2 text-gray-700">ACC</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="STL" class="form-checkbox" id="productSTL" disabled>
                                        <span class="ml-2 text-gray-700">STL</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="CC" class="form-checkbox" id="productCC">
                                        <span class="ml-2 text-gray-700">CC</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="2ndCC" class="form-checkbox" id="product2ndCC">
                                        <span class="ml-2 text-gray-700">2nd CC</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="BT/CCL" class="form-checkbox" id="productBTCCL">
                                        <span class="ml-2 text-gray-700">BT/CCL</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="products" value="PL" class="form-checkbox" id="productPL">
                                        <span class="ml-2 text-gray-700">PL</span>
                                    </label>
                                </div>
                                <p id="productsError" class="text-red-500 text-sm hidden">Please select at least one product</p>
                            </div>
                            
                            <!-- Product Options Container -->
                            <div id="productOptionsContainer" class="space-y-3">
                                <!-- Product-specific dropdown sections will be added here dynamically -->
                            </div>
                            
                            <!-- Loan Amount (Only shown for PL) -->
                            <div id="loanAmountSection" class="hidden">
                                <label for="loanAmount" class="block text-gray-700 font-medium">Loan Amount</label>
                                <input type="number" id="loanAmount" name="loanAmount" class="w-full border rounded-md p-2 text-base">
                            </div>
                            
                            <!-- Banking -->
                            <div>
                                <label for="banking" class="block text-gray-700 font-medium">Banking</label>
                                <select id="banking" name="banking" class="w-full border rounded-md p-2 text-base">
                                    <option value="SELECT">SELECT</option>
                                    <option value="ADCB">ADCB</option>
                                    <option value="ENBD">ENBD</option>
                                    <option value="EIB">EIB</option>
                                    <option value="FAB">FAB</option>
                                    <option value="DIB">DIB</option>
                                    <option value="MASHREQ">MASHREQ</option>
                                    <option value="ADIB">ADIB</option>
                                    <option value="RAK">RAK</option>
                                    <option value="CBD">CBD</option>
                                    <option value="HSBC">HSBC</option>
                                    <option value="CITI">CITI</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div id="otherBankingSection" class="mt-2 hidden">
                                    <input type="text" id="otherBanking" name="otherBanking" placeholder="Specify bank" class="w-full border rounded-md p-2 text-base">
                                </div>
                            </div>
                            
                            <!-- Scheme -->
                            <div>
                                <label class="block text-gray-700 font-medium required">Scheme</label>
                                <div class="flex flex-wrap gap-4 mt-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="scheme" value="TML ALL" class="form-radio" checked>
                                        <span class="ml-2 text-gray-700">TML ALL</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="scheme" value="TML CC" class="form-radio">
                                        <span class="ml-2 text-gray-700">TML CC</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="scheme" value="TM SELECT" class="form-radio">
                                        <span class="ml-2 text-gray-700">TM SELECT</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="scheme" value="NTML" class="form-radio">
                                        <span class="ml-2 text-gray-700">NTML</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Status -->
                            <div>
                                <label for="status" class="block text-gray-700 font-medium required">Status</label>
                                <select id="status" name="status" class="w-full border rounded-md p-2 text-base" required>
                                    <option value="">Select Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Under Review">Under Review</option>
                                    <option value="Completed">Completed</option>
                                    <option value="HR CPV">HR CPV</option>
                                    <option value="Compliance">Compliance</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div id="otherStatusSection" class="mt-2 hidden">
                                    <input type="text" id="otherStatus" name="otherStatus" placeholder="Specify status" class="w-full border rounded-md p-2 text-base">
                                </div>
                            </div>
                            
                            <!-- Activation -->
                            <div>
                                <label class="block text-gray-700 font-medium required">Activation</label>
                                <div class="flex space-x-4 mt-2">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="activation" value="Non Activated" class="form-radio" checked>
                                        <span class="ml-2 text-gray-700">Non Activated</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="activation" value="Activated" class="form-radio">
                                        <span class="ml-2 text-gray-700">Activated</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Points (System Generated) -->
                            <div>
                                <label for="points" class="block text-gray-700 font-medium">Points (System Generated)</label>
                                <input type="text" id="points" name="points" class="w-full border rounded-md p-2 text-base bg-gray-100" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Form Action Buttons -->
                    <div class="flex justify-center gap-4 mt-6">
                        <button type="submit" id="submitBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                            <i class="fas fa-save mr-2"></i> Save Data
                        </button>
                        <button type="button" id="updateBtn" class="custom-btn bg-blue-600 text-white py-2 px-6 rounded-md flex items-center hidden">
                            <i class="fas fa-edit mr-2"></i> Update Data
                        </button>
                        <button type="button" id="deleteBtn" class="bg-red-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-red-700 hidden">
                            <i class="fas fa-trash-alt mr-2"></i> Delete Data
                        </button>
                        <button type="button" id="resetBtn" class="bg-gray-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-gray-700">
                            <i class="fas fa-redo-alt mr-2"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- View Data Section -->
        <div id="viewSection" class="section">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex flex-wrap justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-primary">View All Records</h2>
                    <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                        <button id="earnPointsBtn" class="points-btn earned">
                            <i class="fas fa-check-circle mr-2"></i> Earned ♔ <span id="earnedPointsTotal">0</span>
                        </button>
                        <button id="pendingPointsBtn" class="points-btn pending">
                            <i class="fas fa-hourglass-half mr-2"></i> Pending ✭ <span id="pendingPointsTotal">0</span>
                        </button>
                        <button id="refreshDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table id="dataTable" class="data-table">
                        <thead>
                            <tr>
                                <th>CID</th>
                                <th>App ID</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th class="w-36">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                    <!-- Fix 3: Show All button -->
                    <div id="showMoreContainer" class="mt-4 text-center hidden">
                        <button id="showAllRecordsBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                            <i class="fas fa-list mr-2"></i> Show All Records
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Search Section -->
        <div id="searchSection" class="section">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <h2 class="text-xl font-bold text-primary mb-4">Search Records</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="searchCID" class="block text-gray-700 font-medium mb-2">Search by CID</label>
                        <input type="number" id="searchCID" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div>
                        <label for="searchName" class="block text-gray-700 font-medium mb-2">Search by Customer Name</label>
                        <input type="text" id="searchName" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div>
                        <label for="searchMobile" class="block text-gray-700 font-medium mb-2">Search by Mobile</label>
                        <input type="number" id="searchMobile" class="w-full border rounded-md p-2 text-base">
                    </div>
                </div>
                
                <div class="flex justify-center mb-6">
                    <button id="searchBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                        <i class="fas fa-search mr-2"></i> Search
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>CID</th>
                                <th>App ID</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Points</th>
                                <th class="w-36">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <!-- Search results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Summary Section -->
        <div id="summarySection" class="section">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-[#6F2C4F]">Summary Dashboard</h2>
                    <button id="printSummaryBtn" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 no-print">
                        <i class="fas fa-print"></i>
                    </button>
                </div>
                
                <!-- Points Summary Card -->
                <div class="summary-card">
                    <h3>Points</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <p class="font-medium text-gray-600">Earned Points:</p>
                            <p class="text-2xl font-bold text-green-600" id="summaryEarnedPoints">0</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-600">Pending Points:</p>
                            <p class="text-2xl font-bold text-amber-600" id="summaryPendingPoints">0</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-600">Total Points:</p>
                            <p class="text-2xl font-bold text-blue-600" id="summaryTotalPoints">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- In Progress Card -->
                <div class="summary-card">
                    <h3>In Progress</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="font-medium text-gray-600">Credit Cards:</p>
                            <p class="text-xl font-bold text-purple-600" id="summaryInProgressCC">0</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-600">Personal Loans:</p>
                            <p class="text-xl font-bold text-purple-600" id="summaryInProgressPL">AED 0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Completed Card -->
                <div class="summary-card">
                    <h3>Completed</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="font-medium text-gray-600">Credit Cards:</p>
                            <p class="text-xl font-bold text-green-600" id="summaryCompletedCC">0</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-600">Personal Loans:</p>
                            <p class="text-xl font-bold text-green-600" id="summaryCompletedPL">AED 0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Effort Card -->
                <div class="summary-card">
                    <h3>Effort</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <p class="font-medium text-gray-600">Credit Cards:</p>
                            <p class="text-xl font-bold text-blue-600" id="summaryTotalCC">15</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-600">Personal Loans:</p>
                            <p class="text-xl font-bold text-blue-600" id="summaryTotalPL">AED 170,000</p>
                        </div>
                    </div>
                </div>
                
                <!-- Target Card -->
                <div class="summary-card">
                    <h3>Target</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <p class="font-medium text-gray-600">Credit Cards:</p>
                                <input type="number" id="targetCC" class="target-input" value="20" min="0" placeholder="20">
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-500">Remaining:</p>
                                <p class="font-bold text-blue-600" id="remainingCC">12</p>
                            </div>
                            <div class="progress-bar mt-2">
                                <div class="progress-fill bg-blue-500" id="progressCC" style="width: 40%">40%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <p class="font-medium text-gray-600">Personal Loans:</p>
                                <input type="number" id="targetPL" class="target-input" value="500000" min="0" placeholder="500000">
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-500">Remaining:</p>
                                <p class="font-bold text-blue-600" id="remainingPL">500,000</p>
                            </div>
                            <div class="progress-bar mt-2">
                                <div class="progress-fill bg-green-500" id="progressPL" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-2">
                                <p class="font-medium text-gray-600">Accounts:</p>
                                <input type="number" id="targetACC" class="target-input" value="10" min="0" placeholder="10">
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-sm text-gray-500">Remaining:</p>
                                <p class="font-bold text-blue-600" id="remainingACC">8</p>
                            </div>
                            <div class="progress-bar mt-2">
                                <div class="progress-fill bg-purple-500" id="progressACC" style="width: 20%">20%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Visualizations Section -->
                <div class="border rounded-lg mb-4">
                    <div class="visualizations-header">
                        Visualizations
                    </div>
                    
                    <div class="visualization-container p-3">
                        <!-- Proposition Distribution Chart -->
                        <div class="chart-box">
                            <div class="chart-title">Proposition Distribution</div>
                            <div class="pie-chart">
                                <div class="donut-hole"></div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #6F2C4F;"></div>
                                    <span>Conventional</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #262a5a;"></div>
                                    <span>Islamic</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #10b981;"></div>
                                    <span>Both</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Account Types Chart -->
                        <div class="chart-box">
                            <div class="chart-title">Account Types</div>
                            <div class="acc-chart">
                                <div class="donut-hole"></div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f97316;"></div>
                                    <span>Aspire</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #0ea5e9;"></div>
                                    <span>Privilege</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #8b5cf6;"></div>
                                    <span>MDSA</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scheme Distribution Chart -->
                        <div class="chart-box">
                            <div class="chart-title">Scheme Distribution (Completed)</div>
                            <div class="scheme-chart">
                                <div class="donut-hole"></div>
                            </div>
                            <div class="chart-legend">
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #6F2C4F;"></div>
                                    <span>TML ALL</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #262a5a;"></div>
                                    <span>TML CC</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #10b981;"></div>
                                    <span>TM SELECT</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-color" style="background-color: #f97316;"></div>
                                    <span>NTML</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Indicator -->
    <div id="successIndicator" class="success-indicator hidden">
        <span id="successMessage">Operation successful!</span>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-indicator hidden">
        <div class="spinner"></div>
    </div>

    <script>
        // ==========================================
        // THEME AND UI FUNCTIONALITY
        // ==========================================

        // Section navigation
        const showEntryBtn = document.getElementById('showEntryBtn');
        const showViewBtn = document.getElementById('showViewBtn');
        const showSearchBtn = document.getElementById('showSearchBtn');
        const showSummaryBtn = document.getElementById('showSummaryBtn');
        
        const entrySection = document.getElementById('entrySection');
        const viewSection = document.getElementById('viewSection');
        const searchSection = document.getElementById('searchSection');
        const summarySection = document.getElementById('summarySection');
        
        // Fix 3: Track displayed records
        let allRecordsData = [];
        let isShowingAllRecords = false;
        const maxInitialRecords = 10;
        
        function showSection(section) {
            // Hide all sections
            entrySection.classList.remove('active');
            viewSection.classList.remove('active');
            searchSection.classList.remove('active');
            summarySection.classList.remove('active');
            
            // Reset button styles
            showEntryBtn.classList.remove('custom-btn');
            showViewBtn.classList.remove('custom-btn');
            showSearchBtn.classList.remove('custom-btn');
            showSummaryBtn.classList.remove('custom-btn');
            
            showEntryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            showViewBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            showSearchBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            showSummaryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
            
            // Show selected section and highlight button
            if (section === 'entry') {
                entrySection.classList.add('active');
                showEntryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                showEntryBtn.classList.add('custom-btn');
            } else if (section === 'view') {
                viewSection.classList.add('active');
                showViewBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                showViewBtn.classList.add('custom-btn');
                fetchAllData();
            } else if (section === 'search') {
                searchSection.classList.add('active');
                showSearchBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                showSearchBtn.classList.add('custom-btn');
            } else if (section === 'summary') {
                summarySection.classList.add('active');
                showSummaryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                showSummaryBtn.classList.add('custom-btn');
                fetchAllDataForSummary();
            }
        }
        
        showEntryBtn.addEventListener('click', () => showSection('entry'));
        showViewBtn.addEventListener('click', () => showSection('view'));
        showSearchBtn.addEventListener('click', () => showSection('search'));
        showSummaryBtn.addEventListener('click', () => showSection('summary'));

        // Show success indicator
        function showSuccess(message) {
            const indicator = document.getElementById('successIndicator');
            const messageEl = document.getElementById('successMessage');
            
            messageEl.textContent = message;
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }

        // Show loading indicator
        function showLoading() {
            document.getElementById('loadingIndicator').classList.remove('hidden');
        }

        // Hide loading indicator
        function hideLoading() {
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        // ==========================================
        // FORM HANDLING AND VALIDATION
        // ==========================================

        // Get all form elements
        const entryForm = document.getElementById('entryForm');
        const cidInput = document.getElementById('cid');
        const appIdInput = document.getElementById('appId');
        const dateInput = document.getElementById('date');
        const salaryInput = document.getElementById('salary');
        const customerNameInput = document.getElementById('customerName');
        const mobileInput = document.getElementById('mobile');
        const bankingSelect = document.getElementById('banking');
        const otherBankingSection = document.getElementById('otherBankingSection');
        const otherBankingInput = document.getElementById('otherBanking');
        const companyNameInput = document.getElementById('companyName');
        const statusSelect = document.getElementById('status');
        const otherStatusSection = document.getElementById('otherStatusSection');
        const otherStatusInput = document.getElementById('otherStatus');
        const pointsInput = document.getElementById('points');
        const productACC = document.getElementById('productACC');
        const productSTL = document.getElementById('productSTL');
        const productCC = document.getElementById('productCC');
        const product2ndCC = document.getElementById('product2ndCC');
        const productBTCCL = document.getElementById('productBTCCL');
        const productPL = document.getElementById('productPL');
        const loanAmountSection = document.getElementById('loanAmountSection');
        const loanAmountInput = document.getElementById('loanAmount');
        const productOptionsContainer = document.getElementById('productOptionsContainer');
        
        // Reset button
        document.getElementById('resetBtn').addEventListener('click', function() {
            resetForm();
        });

        // Form reset function
        function resetForm() {
            entryForm.reset();
            productOptionsContainer.innerHTML = '';
            loanAmountSection.classList.add('hidden');
            otherBankingSection.classList.add('hidden');
            otherStatusSection.classList.add('hidden');
            
            // Reset validation error messages
            document.getElementById('cidError').classList.add('hidden');
            document.getElementById('nameError').classList.add('hidden');
            document.getElementById('mobileError').classList.add('hidden');
            document.getElementById('productsError').classList.add('hidden');

            // Hide update and delete buttons, show submit button
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('updateBtn').classList.add('hidden');
            document.getElementById('deleteBtn').classList.add('hidden');

            // Clear points
            pointsInput.value = '';
            
            // Disable dependent checkboxes
            productSTL.disabled = true;
            product2ndCC.disabled = true;
            
            // Enable CID input for new records
            cidInput.readOnly = false;
            
            // Clear any error styling
            document.querySelectorAll('.error-field').forEach(field => {
                field.classList.remove('error-field');
            });
            
            // Clear stored product selections
            currentSelections = {
                ACC: '',
                CC: '',
                CCOption2: '',
                PL: ''
            };
            
            // Clear editing data
            editingData = null;
            
            // Clear raw product string
            editingProductString = "";
        }

        // Banking select change event
        bankingSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                otherBankingSection.classList.remove('hidden');
            } else {
                otherBankingSection.classList.add('hidden');
            }
        });

        // Status select change event
        statusSelect.addEventListener('change', function() {
            if (this.value === 'Other') {
                otherStatusSection.classList.remove('hidden');
            } else {
                otherStatusSection.classList.add('hidden');
            }
        });

        // Product checkbox change events
        productACC.addEventListener('change', function() {
            // Enable/disable STL checkbox based on ACC checkbox
            productSTL.disabled = !this.checked;
            if (!this.checked) {
                productSTL.checked = false;
            }
            updateProductOptions();
        });

        productSTL.addEventListener('change', function() {
            calculateTotalPoints();
        });

        productPL.addEventListener('change', function() {
            if (this.checked) {
                loanAmountSection.classList.remove('hidden');
            } else {
                loanAmountSection.classList.add('hidden');
                loanAmountInput.value = '';
            }
            updateProductOptions();
        });

        productCC.addEventListener('change', function() {
            updateProductOptions();
            // Enable/disable 2nd CC checkbox based on CC checkbox
            product2ndCC.disabled = !this.checked;
            if (!this.checked) {
                product2ndCC.checked = false;
            }
        });

        product2ndCC.addEventListener('change', function() {
            updateProductOptions();
        });

        productBTCCL.addEventListener('change', function() {
            calculateTotalPoints();
        });

        // Proposition radio button change event
        document.querySelectorAll('input[name="proposition"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateProductOptions();
            });
        });

        // Salary input change event
        salaryInput.addEventListener('input', function() {
            updateProductOptions();
        });

        // Set today's date as the default date
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            dateInput.value = today;
            
            // Disable 2nd CC and STL initially
            product2ndCC.disabled = true;
            productSTL.disabled = true;
        });

        // ==========================================
        // PRODUCT OPTIONS AND POINTS CALCULATION
        // ==========================================

        // Store current selections for dropdowns
        let currentSelections = {
            ACC: '',
            CC: '',
            CCOption2: '',
            PL: ''
        };
        
        // Store raw editing data
        let editingData = null;
        let editingProductString = "";
        
        // Function to initialize product option dropdowns based on edit data
        function initializeProductOptions() {
            if (!editingData) return;
            
            console.log("Initializing product options for editing data:", editingData);
            
            // If we're editing a record with product data
            const proposition = document.querySelector('input[name="proposition"]:checked').value;
            const salary = parseFloat(salaryInput.value) || 0;
            
            // Check what products should be shown based on the product string
            if (productACC.checked) {
                console.log("ACC is checked, adding ACC options");
                const accOptions = getACCOptions(proposition, salary);
                
                if (accOptions.length > 0) {
                    const accDiv = createProductOptionDiv('ACC', accOptions);
                    productOptionsContainer.appendChild(accDiv);
                    
                    const accSelect = document.getElementById('ACCSelect');
                    if (accSelect) {
                        console.log("Setting ACC select change event");
                        accSelect.addEventListener('change', function() {
                            // Check if selected option disables STL
                            const selectedOption = this.options[this.selectedIndex];
                            const disableSTL = selectedOption.dataset.disablestl === "true";
                            
                            // Enable/disable STL based on selected option
                            if (disableSTL) {
                                productSTL.disabled = true;
                                productSTL.checked = false;
                            } else {
                                productSTL.disabled = false;
                            }
                            
                            calculateTotalPoints();
                        });
                        
                        // Try to set the correct value
                        setAccDropdownValue(accSelect, editingData, salary);
                    }
                }
            }
            
            // Create CC dropdown if needed
            if (productCC.checked) {
                console.log("CC is checked, adding CC options");
                const ccOptions = getCCOptions(proposition);
                
                if (ccOptions.length > 0) {
                    const ccDiv = createProductOptionDiv('CC', ccOptions);
                    productOptionsContainer.appendChild(ccDiv);
                    
                    const ccSelect = document.getElementById('CCSelect');
                    if (ccSelect) {
                        console.log("Setting CC select change event");
                        ccSelect.addEventListener('change', calculateTotalPoints);
                        
                        // Try to set the correct value
                        setCcDropdownValue(ccSelect, editingData);
                    }
                }
                
                // Add 2nd CC options if checked
                if (product2ndCC.checked) {
                    console.log("2nd CC is checked, adding 2nd CC options");
                    const ccOptions = getCCOptions(proposition);
                    
                    if (ccOptions.length > 0) {
                        const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                        productOptionsContainer.appendChild(cc2Div);
                        
                        const cc2Select = document.getElementById('CCSelect2');
                        if (cc2Select) {
                            console.log("Setting 2nd CC select change event");
                            cc2Select.addEventListener('change', calculateTotalPoints);
                            
                            // Try to set the correct value for 2nd CC
                            setCc2DropdownValue(cc2Select, editingData, editingProductString);
                        }
                    }
                }
            }
            
            // Create PL dropdown if needed
            if (productPL.checked) {
                console.log("PL is checked, adding PL options");
                const plOptions = getPLOptions(proposition);
                
                if (plOptions.length > 0) {
                    const plDiv = createProductOptionDiv('PL', plOptions);
                    productOptionsContainer.appendChild(plDiv);
                    
                    const plSelect = document.getElementById('PLSelect');
                    if (plSelect) {
                        console.log("Setting PL select change event");
                        plSelect.addEventListener('change', calculateTotalPoints);
                        
                        // Try to set the correct value
                        setPlDropdownValue(plSelect, editingData);
                    }
                    
                    // Add change event to loan amount input
                    loanAmountInput.addEventListener('input', calculateTotalPoints);
                }
            }
            
            // Calculate points
            calculateTotalPoints();
        }
        
        // Helper functions to set dropdown values correctly
        function setAccDropdownValue(accSelect, data, salary) {
            if (!accSelect) return;
            
            console.log("Trying to set ACC dropdown value");
            
            // First check if we have explicit accOption from the server
            if (data.accOption) {
                console.log("Using explicit accOption from server:", data.accOption);
                // Find the option that matches
                for (let i = 0; i < accSelect.options.length; i++) {
                    if (accSelect.options[i].value === data.accOption) {
                        accSelect.selectedIndex = i;
                        console.log("Found matching ACC option at index", i);
                        return;
                    }
                }
            }
            
            // If no explicit option or not found, try to match from product string
            if (editingProductString) {
                console.log("Checking product string for ACC option:", editingProductString);
                // Check for specific ACC product names
                if (editingProductString.includes("MDSA")) {
                    selectOptionByText(accSelect, "MDSA");
                } else if (editingProductString.includes("Privilege 20K-30K")) {
                    selectOptionByText(accSelect, "Privilege 20K-30K");
                } else if (editingProductString.includes("Privilege 30K-75K")) {
                    selectOptionByText(accSelect, "Privilege 30K-75K");
                } else if (editingProductString.includes("Privilege 75K")) {
                    selectOptionByText(accSelect, "Privilege 75K");
                } else if (editingProductString.includes("Aspire 5K-10K")) {
                    selectOptionByText(accSelect, "Aspire 5K-10K");
                } else if (editingProductString.includes("Aspire 10K-20K")) {
                    selectOptionByText(accSelect, "Aspire 10K-20K");
                }
            }
            
            // If still no match, try to match based on salary
            if (accSelect.selectedIndex === 0) {
                console.log("No match found, trying to set based on salary:", salary);
                // Find the best option based on salary range
                for (let i = 1; i < accSelect.options.length; i++) {
                    const option = accSelect.options[i];
                    const minSalary = parseInt(option.dataset.minsalary) || 0;
                    const maxSalary = parseInt(option.dataset.maxsalary) || Infinity;
                    
                    if (salary >= minSalary && salary <= maxSalary) {
                        accSelect.selectedIndex = i;
                        console.log("Found salary-matching ACC option at index", i);
                        break;
                    }
                }
            }
        }
        
        function setCcDropdownValue(ccSelect, data) {
            if (!ccSelect) return;
            
            console.log("Trying to set CC dropdown value");
            
            // First check if we have explicit ccOption from the server
            if (data.ccOption) {
                console.log("Using explicit ccOption from server:", data.ccOption);
                // Find the option that matches
                for (let i = 0; i < ccSelect.options.length; i++) {
                    if (ccSelect.options[i].value === data.ccOption) {
                        ccSelect.selectedIndex = i;
                        console.log("Found matching CC option at index", i);
                        return;
                    }
                }
            }
            
            // If no explicit option or not found, try to match from product string
            if (editingProductString) {
                console.log("Checking product string for CC option:", editingProductString);
                
                // Extract CC product names from the string
                const products = editingProductString.split(',').map(p => p.trim());
                const ccProductsInSheet = products.filter(p => 
                    p.includes("Touchpoints") || 
                    p.includes("Cashback") ||
                    p.includes("Talabat") ||
                    p.includes("Visa") ||
                    p.includes("MC")
                );
                
                // If we found CC products, use the first one
                if (ccProductsInSheet.length > 0) {
                    console.log("Found CC product in sheet:", ccProductsInSheet[0]);
                    selectOptionByText(ccSelect, ccProductsInSheet[0]);
                }
            }
        }
        
        function setCc2DropdownValue(cc2Select, data, productString) {
            if (!cc2Select) return;
            
            console.log("Trying to set 2nd CC dropdown value");
            
            // First check if we have explicit ccOption2 from the server
            if (data.ccOption2) {
                console.log("Using explicit ccOption2 from server:", data.ccOption2);
                // Find the option that matches
                for (let i = 0; i < cc2Select.options.length; i++) {
                    if (cc2Select.options[i].value === data.ccOption2) {
                        cc2Select.selectedIndex = i;
                        console.log("Found matching 2nd CC option at index", i);
                        return;
                    }
                }
            }
            
            // If no explicit option or not found, try to match from product string
            if (productString) {
                console.log("Checking product string for 2nd CC option:", productString);
                
                // Extract CC product names from the string
                const products = productString.split(',').map(p => p.trim());
                const ccProductsInSheet = products.filter(p => 
                    p.includes("Touchpoints") || 
                    p.includes("Cashback") ||
                    p.includes("Talabat") ||
                    p.includes("Visa") ||
                    p.includes("MC")
                );
                
                // If we found more than one CC product, use the second one
                if (ccProductsInSheet.length > 1) {
                    console.log("Found 2nd CC product in sheet:", ccProductsInSheet[1]);
                    selectOptionByText(cc2Select, ccProductsInSheet[1]);
                }
            }
        }
        
        function setPlDropdownValue(plSelect, data) {
            if (!plSelect) return;
            
            console.log("Trying to set PL dropdown value");
            
            // First check if we have explicit plOption from the server
            if (data.plOption) {
                console.log("Using explicit plOption from server:", data.plOption);
                // Find the option that matches
                for (let i = 0; i < plSelect.options.length; i++) {
                    if (plSelect.options[i].value === data.plOption) {
                        plSelect.selectedIndex = i;
                        console.log("Found matching PL option at index", i);
                        return;
                    }
                }
            }
            
            // If no explicit option or not found, try to match from product string
            if (editingProductString) {
                console.log("Checking product string for PL option:", editingProductString);
                
                // Check for specific PL product names
                if (editingProductString.includes("Asipire Cat A & B")) {
                    selectOptionByText(plSelect, "Asipire Cat A & B");
                } else if (editingProductString.includes("Privilege Cat A & B")) {
                    selectOptionByText(plSelect, "Privilege Cat A & B");
                } else if (editingProductString.includes("Aspire Cat C & Below")) {
                    selectOptionByText(plSelect, "Aspire Cat C & Below");
                } else if (editingProductString.includes("Privilege Cat C & Below")) {
                    selectOptionByText(plSelect, "Privilege Cat C & Below");
                }
            }
        }
        
        // Helper function to select an option by its display text
        function selectOptionByText(selectElement, searchText) {
            if (!selectElement) return false;
            
            console.log(`Searching for option with text "${searchText}" in`, selectElement);
            
            for (let i = 0; i < selectElement.options.length; i++) {
                const optionText = selectElement.options[i].text;
                
                // Try exact match first
                if (optionText === searchText) {
                    selectElement.selectedIndex = i;
                    console.log(`Found exact match at index ${i}: ${optionText}`);
                    return true;
                }
                
                // Then try contains match
                if (optionText.includes(searchText) || searchText.includes(optionText)) {
                    selectElement.selectedIndex = i;
                    console.log(`Found partial match at index ${i}: ${optionText}`);
                    return true;
                }
                
                // Try without parentheses (e.g., "Aspire 5K-10K (Salary: 5000-9999)" -> "Aspire 5K-10K")
                const baseOptionText = optionText.split(' (')[0];
                if (baseOptionText === searchText || searchText.includes(baseOptionText) || baseOptionText.includes(searchText)) {
                    selectElement.selectedIndex = i;
                    console.log(`Found base text match at index ${i}: ${baseOptionText}`);
                    return true;
                }
            }
            
            console.log(`No matching option found for "${searchText}"`);
            return false;
        }

        // Initialize product options when proposition or products change
        function updateProductOptions() {
            // Save current dropdown selections before updating
            const accSelect = document.getElementById('ACCSelect');
            const ccSelect = document.getElementById('CCSelect');
            const ccSelect2 = document.getElementById('CCSelect2');
            const plSelect = document.getElementById('PLSelect');
            
            if (accSelect) currentSelections.ACC = accSelect.value;
            if (ccSelect) currentSelections.CC = ccSelect.value;
            if (ccSelect2) currentSelections.CCOption2 = ccSelect2.value;
            if (plSelect) currentSelections.PL = plSelect.value;
            
            // Clear existing dropdowns
            productOptionsContainer.innerHTML = '';
            
            // Check if we're in edit mode with data
            if (editingData) {
                console.log("Updating product options with editing data");
                initializeProductOptions();
                return;
            }
            
            const proposition = document.querySelector('input[name="proposition"]:checked').value;
            const salary = parseFloat(salaryInput.value) || 0;
            
            // Process ACC product
            if (productACC.checked) {
                const accOptions = getACCOptions(proposition, salary);
                if (accOptions.length > 0) {
                    const accDiv = createProductOptionDiv('ACC', accOptions);
                    productOptionsContainer.appendChild(accDiv);
                    
                    // Add change event to ACC select
                    const newAccSelect = accDiv.querySelector('select');
                    newAccSelect.addEventListener('change', function() {
                        // Check if selected option disables STL
                        const selectedOption = newAccSelect.options[newAccSelect.selectedIndex];
                        const disableSTL = selectedOption.dataset.disablestl === "true";
                        
                        // Enable/disable STL based on selected option
                        if (disableSTL) {
                            productSTL.disabled = true;
                            productSTL.checked = false;
                        } else {
                            productSTL.disabled = false;
                        }
                        
                        calculateTotalPoints();
                    });
                    
                    // Restore previous selection if it exists
                    if (currentSelections.ACC && newAccSelect.querySelector(`option[value="${currentSelections.ACC}"]`)) {
                        newAccSelect.value = currentSelections.ACC;
                        
                        // Check if selected option disables STL
                        const selectedOption = newAccSelect.options[newAccSelect.selectedIndex];
                        if (selectedOption.dataset.disablestl === "true") {
                            productSTL.disabled = true;
                            productSTL.checked = false;
                        }
                    }
                }
            }
            
            // Process CC product
            if (productCC.checked) {
                const ccOptions = getCCOptions(proposition);
                if (ccOptions.length > 0) {
                    const ccDiv = createProductOptionDiv('CC', ccOptions);
                    productOptionsContainer.appendChild(ccDiv);
                    
                    // Add change event to CC select
                    const newCcSelect = ccDiv.querySelector('select');
                    newCcSelect.addEventListener('change', calculateTotalPoints);
                    
                    // Restore previous selection if it exists
                    if (currentSelections.CC && newCcSelect.querySelector(`option[value="${currentSelections.CC}"]`)) {
                        newCcSelect.value = currentSelections.CC;
                    }
                }
                
                // Process 2nd CC product (only when CC is checked and 2ndCC is checked)
                if (product2ndCC.checked) {
                    const ccOptions = getCCOptions(proposition);
                    if (ccOptions.length > 0) {
                        const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                        productOptionsContainer.appendChild(cc2Div);
                        
                        // Add change event to 2nd CC select
                        const newCc2Select = cc2Div.querySelector('select');
                        newCc2Select.addEventListener('change', calculateTotalPoints);
                        
                        // Restore previous selection if it exists
                        if (currentSelections.CCOption2 && newCc2Select.querySelector(`option[value="${currentSelections.CCOption2}"]`)) {
                            newCc2Select.value = currentSelections.CCOption2;
                        }
                    }
                }
            }
            
            // Process PL product
            if (productPL.checked) {
                const plOptions = getPLOptions(proposition);
                if (plOptions.length > 0) {
                    const plDiv = createProductOptionDiv('PL', plOptions);
                    productOptionsContainer.appendChild(plDiv);
                    
                    // Add change event to PL select
                    const newPlSelect = plDiv.querySelector('select');
                    newPlSelect.addEventListener('change', calculateTotalPoints);
                    
                    // Restore previous selection if it exists
                    if (currentSelections.PL && newPlSelect.querySelector(`option[value="${currentSelections.PL}"]`)) {
                        newPlSelect.value = currentSelections.PL;
                    }
                    
                    // Add change event to Loan Amount input
                    loanAmountInput.addEventListener('input', calculateTotalPoints);
                }
            }
            
            // Calculate total points
            calculateTotalPoints();
        }

        // Create a product option div with dropdown
        function createProductOptionDiv(productType, options, customLabel) {
            const div = document.createElement('div');
            const label = customLabel || productType + ' Option';
            const id = productType === 'CC2' ? 'CCSelect2' : `${productType}Select`;
            
            let optionsHtml = '<option value="">Select ' + label + '</option>';
            
            options.forEach(option => {
                const extraAttributes = [];
                
                if (option.points) {
                    extraAttributes.push(`data-points="${option.points}"`);
                }
                
                if (option.paid !== undefined) {
                    extraAttributes.push(`data-paid="${option.paid}"`);
                }
                
                if (option.disableSTL !== undefined) {
                    extraAttributes.push(`data-disablestl="${option.disableSTL}"`);
                }
                
                if (option.minSalary !== undefined) {
                    extraAttributes.push(`data-minsalary="${option.minSalary}"`);
                }
                
                if (option.maxSalary !== undefined) {
                    extraAttributes.push(`data-maxsalary="${option.maxSalary}"`);
                }
                
                optionsHtml += `<option value="${option.value}" ${extraAttributes.join(' ')}>${option.text}</option>`;
            });
            
            div.innerHTML = `
                <label for="${id}" class="block text-gray-700 font-medium">${label}</label>
                <select id="${id}" class="w-full border rounded-md p-2 text-base" data-product="${productType}">
                    ${optionsHtml}
                </select>
            `;
            return div;
        }

        // Get ACC options based on proposition and salary
        function getACCOptions(proposition, salary) {
            const options = [];
            
            // Add all options regardless of salary, but annotate with requirements
            options.push({ value: "Aspire5K-10K", text: "Aspire 5K-10K (Salary: 5000-9999)", points: 75, minSalary: 5000, maxSalary: 9999, disableSTL: false });
            options.push({ value: "Aspire10K-20K", text: "Aspire 10K-20K (Salary: 10000-19999)", points: 175, minSalary: 10000, maxSalary: 19999, disableSTL: false });
            options.push({ value: "Privilege20K-30K", text: "Privilege 20K-30K (Salary: 20000-29999)", points: 450, minSalary: 20000, maxSalary: 29999, disableSTL: true });
            options.push({ value: "Privilege30K-75K", text: "Privilege 30K-75K (Salary: 30000-74999)", points: 750, minSalary: 30000, maxSalary: 74999, disableSTL: true });
            options.push({ value: "Privilege75K+", text: "Privilege 75K & Above (Salary: 75000+)", points: 1300, minSalary: 75000, maxSalary: Infinity, disableSTL: true });
            
            // Add Islamic-specific option
            if (proposition === "Islamic" || proposition === "Both") {
                options.push({ 
                    value: "MDSA", 
                    text: "MDSA", 
                    points: salary >= 75000 ? 1300 : 
                           salary >= 30000 ? 750 : 
                           salary >= 20000 ? 450 : 
                           salary >= 10000 ? 175 : 75,
                    minSalary: 5000,
                    maxSalary: Infinity,
                    disableSTL: salary >= 20000 // Disable STL for salary >= 20000
                });
            }
            
            return options;
        }

        // Get CC options based on proposition
        function getCCOptions(proposition) {
            if (proposition === "Conventional") {
                return [
                    { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 250, paid: false },
                    { value: "TouchpointsTitaniumMC", text: "Touchpoints Titanium MC", points: 250, paid: false },
                    { value: "EssientialCashbackMC", text: "Essiential Cashback MC", points: 250, paid: false },
                    { value: "TalabatMC", text: "Talabat MC", points: 250, paid: false },
                    { value: "LuluTitaniumMC", text: "Lulu Titanium MC", points: 250, paid: false },
                    { value: "LuluPlatinumMC", text: "Lulu Platinum MC", points: 250, paid: false },
                    { value: "TouchpointsPlatinumMC", text: "Touchpoints Platinum MC", points: 400, paid: true },
                    { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                    { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 500, paid: true },
                    { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                    { value: "AllSignatureVisa", text: "All Signature Visa", points: 750, paid: true },
                    { value: "AllInfiniteVisa", text: "All Infinite Visa", points: 750, paid: true },
                    { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 750, paid: true },
                    { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                    { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 750, paid: true },
                    { value: "TravellerMCWorldElite", text: "Traveller MC World Elite", points: 750, paid: true },
                    { value: "BetaqtiMCWorldElite", text: "Betaqti MC World Elite", points: 1000, paid: true }
                ];
            } else if (proposition === "Islamic") {
                return [
                    { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 250, paid: false },
                    { value: "TalabatMC", text: "Talabat MC", points: 250, paid: false },
                    { value: "TouchpointsPlatinumVisa", text: "Touchpoints Platinum Visa", points: 500, paid: true },
                    { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                    { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 500, paid: true },
                    { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                    { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 750, paid: true },
                    { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 750, paid: true },
                    { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                    { value: "EmiratiIslamicInfiniteVisa", text: "Emirati Islamic Infinite Visa", points: 750, paid: true }
                ];
            } else if (proposition === "Both") {
                // Combine both lists and remove duplicates
                const conventional = getCCOptions("Conventional");
                const islamic = getCCOptions("Islamic");
                const combinedOptions = [...conventional];
                
                // Add Islamic options that don't exist in conventional
                islamic.forEach(islamicOption => {
                    if (!conventional.some(convOption => convOption.value === islamicOption.value)) {
                        combinedOptions.push(islamicOption);
                    }
                });
                
                return combinedOptions;
            }
            
            return [];
        }

        // Get PL options based on proposition
        function getPLOptions(proposition) {
            // Same options for all propositions
            return [
                { value: "AspireCatAB", text: "Asipire Cat A & B", points: "0.50%" },
                { value: "PrivilegeCatAB", text: "Privilege Cat A & B", points: "0.50%" },
                { value: "AspireCatCBelow", text: "Aspire Cat C & Below", points: "0.25%" },
                { value: "PrivilegeCatCBelow", text: "Privilege Cat C & Below", points: "0.25%" }
            ];
        }

        // Calculate total points based on selected options
        function calculateTotalPoints() {
            let totalPoints = 0;
            
            // Calculate points for ACC
            if (productACC.checked) {
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect && accSelect.value) {
                    const selectedOption = accSelect.options[accSelect.selectedIndex];
                    const accPoints = parseInt(selectedOption.dataset.points) || 0;
                    totalPoints += accPoints;
                    
                    // Add points for STL if checked (same as ACC), but only if not disabled
                    if (productSTL.checked && !productSTL.disabled) {
                        totalPoints += accPoints;
                    }
                }
            }
            
            // Calculate points for CC
            if (productCC.checked) {
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect && ccSelect.value) {
                    const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                    totalPoints += parseInt(selectedOption.dataset.points) || 0;
                    
                    // Check for 2nd CC
                    if (product2ndCC.checked) {
                        const cc2Select = document.getElementById('CCSelect2');
                        if (cc2Select && cc2Select.value) {
                            const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                            const isPaid = selectedOption2.dataset.paid === "true";
                            // Apply different points based on whether it's a paid or free card
                            totalPoints += isPaid ? 250 : 125;
                        }
                    }
                }
            }
            
            // Add points for BT/CCL
            if (productBTCCL.checked) {
                totalPoints += 100;
            }
            
            // Calculate points for PL
            if (productPL.checked) {
                const plSelect = document.getElementById('PLSelect');
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                
                if (plSelect && plSelect.value && loanAmount > 0) {
                    const selectedOption = plSelect.options[plSelect.selectedIndex];
                    const pointsPercentage = selectedOption.dataset.points;
                    
                    if (pointsPercentage === "0.50%") {
                        totalPoints += loanAmount * 0.005;
                    } else if (pointsPercentage === "0.25%") {
                        totalPoints += loanAmount * 0.0025;
                    }
                }
            }
            
            // Update points input
            pointsInput.value = totalPoints.toFixed(2);
        }

        // ==========================================
        // GOOGLE SHEETS INTEGRATION
        // ==========================================

        // Google Apps Script Web App URL
        const scriptURL = 'https://script.google.com/macros/s/AKfycbznPCS1h9sLrnGOFy5Ps0JeinCHQ6JEV0jzZViiDKnT3MO4hJzn2BdIGQyrS2Pu32pCLQ/exec';

        // Fetch all data from Google Sheets
        async function fetchAllData() {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=getAll`);
                const data = await response.json();
                
                if (data.success) {
                    // Store all data for "Show All" functionality
                    allRecordsData = data.data;
                    
                    // Fix 3: Display only last 10 records initially
                    isShowingAllRecords = false;
                    const displayData = allRecordsData.slice(-maxInitialRecords); // Get last 10 records
                    displayDataInTable(displayData, 'dataTableBody');
                    calculatePointsTotals(allRecordsData);
                    
                    // Show or hide the "Show All" button based on data length
                    const showMoreContainer = document.getElementById('showMoreContainer');
                    if (allRecordsData.length > maxInitialRecords) {
                        showMoreContainer.classList.remove('hidden');
                    } else {
                        showMoreContainer.classList.add('hidden');
                    }
                } else {
                    showSuccess(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showSuccess('Error fetching data from server');
            } finally {
                hideLoading();
            }
        }

        // Fix 3: Show All Records button event handler
        document.getElementById('showAllRecordsBtn').addEventListener('click', function() {
            if (!isShowingAllRecords && allRecordsData.length > 0) {
                displayDataInTable(allRecordsData, 'dataTableBody');
                isShowingAllRecords = true;
                this.innerHTML = '<i class="fas fa-list-alt mr-2"></i> Show Last 10 Records';
            } else {
                const displayData = allRecordsData.slice(-maxInitialRecords);
                displayDataInTable(displayData, 'dataTableBody');
                isShowingAllRecords = false;
                this.innerHTML = '<i class="fas fa-list mr-2"></i> Show All Records';
            }
        });

        // Calculate and display point totals
        function calculatePointsTotals(data) {
            let earnedPoints = 0;
            let pendingPoints = 0;
            
            data.forEach(record => {
                const points = parseFloat(record.Points) || 0;
                if (record.Status === 'Completed') {
                    earnedPoints += points;
                } else {
                    pendingPoints += points;
                }
            });
            
            document.getElementById('earnedPointsTotal').textContent = earnedPoints.toFixed(2);
            document.getElementById('pendingPointsTotal').textContent = pendingPoints.toFixed(2);
        }

        // Fetch all data for the summary page
        async function fetchAllDataForSummary() {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=getAll`);
                const data = await response.json();
                
                if (data.success) {
                    populateSummaryData(data.data);
                } else {
                    showSuccess(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error fetching data for summary:', error);
                showSuccess('Error fetching data from server');
            } finally {
                hideLoading();
            }
        }

        // Populate the summary data
        function populateSummaryData(data) {
            if (!data || data.length === 0) {
                // Use default values if no data
                document.getElementById('summaryEarnedPoints').textContent = "0";
                document.getElementById('summaryPendingPoints').textContent = "0";
                document.getElementById('summaryTotalPoints').textContent = "0";
                
                document.getElementById('summaryInProgressCC').textContent = "0";
                document.getElementById('summaryInProgressPL').textContent = "AED 0";
                
                document.getElementById('summaryCompletedCC').textContent = "0";
                document.getElementById('summaryCompletedPL').textContent = "AED 0";
                return;
            }
            
            // Initialize counters
            let earnedPoints = 0;
            let pendingPoints = 0;
            let totalPoints = 0;
            
            let inProgressCC = 0;
            let completedCC = 0;
            let totalCC = 0;
            
            let inProgressLoanAmount = 0;
            let completedLoanAmount = 0;
            let totalLoanAmount = 0;
            
            let totalAccounts = 0;
            let completedAccounts = 0;
            
            // Process each record
            data.forEach(record => {
                const points = parseFloat(record.Points) || 0;
                const isCompleted = record.Status === 'Completed';
                const productString = record.Product || '';
                const proposition = record.Proposition || '';
                const scheme = record.Scheme || '';
                const loanAmount = parseFloat(record['Loan Amount']) || 0;
                
                // Accumulate points
                totalPoints += points;
                if (isCompleted) {
                    earnedPoints += points;
                } else {
                    pendingPoints += points;
                }
                
                // Count cards
                if (productString.includes('CC') || 
                    productString.includes('Touchpoints') || 
                    productString.includes('Cashback') ||
                    productString.includes('Talabat') ||
                    productString.includes('2ndCC')) {
                    
                    totalCC++;
                    if (isCompleted) {
                        completedCC++;
                    } else {
                        inProgressCC++;
                    }
                }
                
                // Count loans
                if (productString.includes('PL') || 
                    productString.includes('Cat A & B') || 
                    productString.includes('Cat C & Below')) {
                    
                    if (loanAmount > 0) {
                        totalLoanAmount += loanAmount;
                        if (isCompleted) {
                            completedLoanAmount += loanAmount;
                        } else {
                            inProgressLoanAmount += loanAmount;
                        }
                    }
                }
                
                // Count accounts
                if (productString.includes('ACC') || 
                    productString.includes('Aspire') || 
                    productString.includes('Privilege') ||
                    productString.includes('MDSA')) {
                    
                    totalAccounts++;
                    if (isCompleted) {
                        completedAccounts++;
                    }
                }
            });
            
            // Format loan amounts
            function formatCurrency(amount) {
                return 'AED ' + amount.toLocaleString('en-US');
            }
            
            // Update summary data
            document.getElementById('summaryEarnedPoints').textContent = earnedPoints.toFixed(2);
            document.getElementById('summaryPendingPoints').textContent = pendingPoints.toFixed(2);
            document.getElementById('summaryTotalPoints').textContent = totalPoints.toFixed(2);
            
            document.getElementById('summaryInProgressCC').textContent = inProgressCC;
            document.getElementById('summaryInProgressPL').textContent = formatCurrency(inProgressLoanAmount);
            
            document.getElementById('summaryCompletedCC').textContent = completedCC;
            document.getElementById('summaryCompletedPL').textContent = formatCurrency(completedLoanAmount);
            
            document.getElementById('summaryTotalCC').textContent = totalCC || "15";
            document.getElementById('summaryTotalPL').textContent = formatCurrency(totalLoanAmount || 170000);
            
            // Update target progress
            updateTargetProgress('CC', completedCC);
            updateTargetProgress('PL', completedLoanAmount);
            updateTargetProgress('ACC', completedAccounts);
        }
        
        // Update progress bars
        function updateTargetProgress(type, completed) {
            const targetInput = document.getElementById(`target${type}`);
            const remainingEl = document.getElementById(`remaining${type}`);
            const progressEl = document.getElementById(`progress${type}`);
            
            const target = parseInt(targetInput.value) || 0;
            const remaining = Math.max(0, target - completed);
            const percentage = target > 0 ? Math.min(100, Math.round((completed / target) * 100)) : 0;
            
            remainingEl.textContent = type === 'PL' ? remaining.toLocaleString('en-US') : remaining;
            progressEl.style.width = `${percentage}%`;
            progressEl.textContent = `${percentage}%`;
            
            targetInput.addEventListener('change', function() {
                updateTargetProgress(type, completed);
            });
        }
        
        // Print summary page
        document.getElementById('printSummaryBtn').addEventListener('click', function() {
            window.print();
        });

        // Search for data
        async function searchData() {
            const cid = document.getElementById('searchCID').value;
            const name = document.getElementById('searchName').value;
            const mobile = document.getElementById('searchMobile').value;
            
            if (!cid && !name && !mobile) {
                showSuccess('Please enter at least one search criteria');
                return;
            }
            
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=search&cid=${cid}&name=${encodeURIComponent(name)}&mobile=${mobile}`);
                const data = await response.json();
                
                if (data.success) {
                    displayDataInTable(data.data, 'searchResultsBody');
                } else {
                    showSuccess(`Error: ${data.error}`);
                    document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="8" class="text-center py-4">No matching records found</td></tr>';
                }
            } catch (error) {
                console.error('Error searching data:', error);
                showSuccess('Error searching data');
            } finally {
                hideLoading();
            }
        }

        // Fix 2: Copy to clipboard function
        function copyToClipboard(text) {
            // Create a temporary input element
            const input = document.createElement('input');
            input.style.position = 'fixed';
            input.style.opacity = 0;
            input.value = text;
            document.body.appendChild(input);
            input.select();
            
            try {
                // Execute the copy command
                document.execCommand('copy');
                return true;
            } catch (err) {
                console.error('Failed to copy text: ', err);
                return false;
            } finally {
                document.body.removeChild(input);
            }
        }

        // Fix 1 & 2: Updated function with improved action button layout and copy functionality
        function displayDataInTable(data, targetTableId) {
            const tableBody = document.getElementById(targetTableId);
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-4">No records found</td></tr>';
                return;
            }
            
            data.forEach(row => {
                const tr = document.createElement('tr');
                const mobileNumber = row.Mobile || '';
                const cidValue = row.CID || '';
                
                tr.innerHTML = `
                    <td class="copyable" data-value="${cidValue}">${cidValue}</td>
                    <td>${row['App ID'] || ''}</td>
                    <td>${row['Customer Name'] || ''}</td>
                    <td class="copyable" data-value="${mobileNumber}">${mobileNumber}</td>
                    <td>${row.Product || ''}</td>
                    <td>${row.Status || ''}</td>
                    <td>${row.Points || ''}</td>
                    <td class="action-column">
                        <a href="tel:+${mobileNumber}" class="action-btn bg-green-600 text-white p-1 rounded inline-block" title="Call ${row['Customer Name']}" role="button">
                            <i class="fas fa-phone"></i>
                        </a>
                        <button class="edit-btn action-btn bg-blue-600 text-white p-1 rounded" data-cid="${row.CID}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn action-btn bg-red-600 text-white p-1 rounded" data-cid="${row.CID}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
            
            // Add event listeners to edit and delete buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cid = this.getAttribute('data-cid');
                    editRecord(cid);
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const cid = this.getAttribute('data-cid');
                    if (confirm('Are you sure you want to delete this record?')) {
                        deleteRecord(cid);
                    }
                });
            });
            
            // Fix 2: Add event listeners for copyable fields
            document.querySelectorAll('.copyable').forEach(element => {
                element.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    if (copyToClipboard(value)) {
                        this.classList.add('copied');
                        setTimeout(() => {
                            this.classList.remove('copied');
                        }, 1500);
                    }
                });
            });
        }

        // Submit form data
        async function submitFormData(formData) {
            showLoading();
            
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: formData
                });
                
                console.log("Response status:", response.status);
                const responseText = await response.text();
                console.log("Raw response:", responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log("Parsed response:", data);
                } catch (parseError) {
                    console.error("Error parsing response:", parseError);
                    showSuccess('Error: Could not parse server response');
                    hideLoading();
                    return;
                }
                
                if (data.success) {
                    showSuccess('Data submitted successfully!');
                    resetForm();
                    fetchAllData(); // Refresh data table
                } else {
                    showSuccess(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error submitting form:', error);
                showSuccess('Error submitting data: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Update existing record
        async function updateRecord(formData) {
            showLoading();
            try {
                formData.append('action', 'update');
                
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('Record updated successfully!');
                    resetForm();
                    fetchAllData(); // Refresh data table
                } else {
                    showSuccess(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error updating record:', error);
                showSuccess('Error updating record');
            } finally {
                hideLoading();
            }
        }

        // Delete record
        async function deleteRecord(cid) {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=delete&cid=${cid}`, {
                    method: 'GET'
                });
                
                const data = await response.json();
                if (data.success) {
                    showSuccess('Record deleted successfully!');
                    resetForm();
                    fetchAllData(); // Refresh data table
                } else {
                    showSuccess(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error deleting record:', error);
                showSuccess('Error deleting record');
            } finally {
                hideLoading();
            }
        }

        // Edit record (fetch and populate form)
        async function editRecord(cid) {
            showLoading();
            try {
                const response = await fetch(`${scriptURL}?action=getById&cid=${cid}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    // Save the raw data for later use
                    editingData = data.data;
                    editingProductString = data.data.Product || "";
                    
                    console.log("Got data for editing:", editingData);
                    console.log("Product string:", editingProductString);
                    
                    // Clear any existing selections
                    currentSelections = {
                        ACC: '',
                        CC: '',
                        CCOption2: '',
                        PL: ''
                    };
                    
                    // Save the product options from the server if they exist
                    if (data.data.accOption) currentSelections.ACC = data.data.accOption;
                    if (data.data.ccOption) currentSelections.CC = data.data.ccOption;
                    if (data.data.ccOption2) currentSelections.CCOption2 = data.data.ccOption2;
                    if (data.data.plOption) currentSelections.PL = data.data.plOption;
                    
                    // Now populate the form - this will trigger updateProductOptions
                    populateForm(data.data);
                    
                    // Switch to entry section
                    showSection('entry');
                    
                    // Show update and delete buttons, hide submit button
                    document.getElementById('submitBtn').classList.add('hidden');
                    document.getElementById('updateBtn').classList.remove('hidden');
                    document.getElementById('deleteBtn').classList.remove('hidden');
                } else {
                    showSuccess(`Error: ${data.error || 'Record not found'}`);
                }
            } catch (error) {
                console.error('Error fetching record:', error);
                showSuccess('Error fetching record data');
            } finally {
                hideLoading();
            }
        }

        // Function to parse a product string into individual items
        function parseProductString(productString) {
            if (!productString) return [];
            
            // Split by comma and trim each item
            return productString.split(',').map(p => p.trim());
        }

        // Function to check if a product string contains a specific product
        function productStringContains(productString, product) {
            const products = parseProductString(productString);
            return products.some(p => p === product || p.includes(product));
        }

        // Helper function to format date for input field
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            
            // Try to parse the date string
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                // If parsing fails, return the original string
                return dateString;
            }
            
            // Format as YYYY-MM-DD
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }

        // Populate form with record data
        function populateForm(data) {
            console.log("Populating form with data:", data);
            
            // Clear form first
            resetForm();
            
            // Save the editing data again (resetForm clears it)
            editingData = data;
            editingProductString = data.Product || "";
            
            // Populate basic fields
            cidInput.value = data.CID || '';
            cidInput.readOnly = true; // CID should not be editable during update
            appIdInput.value = data['App ID'] || '';
            
            // Set date with proper formatting
            if (data.Date) {
                dateInput.value = formatDateForInput(data.Date);
            }
            
            salaryInput.value = data.Salary || '';
            customerNameInput.value = data['Customer Name'] || '';
            mobileInput.value = data.Mobile || '';
            companyNameInput.value = data['Company Name'] || '';
            
            // Parse the product column to determine which checkboxes should be checked
            const productString = data.Product || '';
            const products = parseProductString(productString);
            console.log("Parsed products:", products);
            
            // Save the raw product options for later use
            if (data.accOption) currentSelections.ACC = data.accOption;
            if (data.ccOption) currentSelections.CC = data.ccOption;
            if (data.ccOption2) currentSelections.CCOption2 = data.ccOption2;
            if (data.plOption) currentSelections.PL = data.plOption;
            
            // Determine which product checkboxes to check based on the product string
            productACC.checked = productStringContains(productString, 'MDSA') || 
                                productStringContains(productString, 'Aspire') ||
                                productStringContains(productString, 'Privilege') ||
                                productStringContains(productString, 'ACC');
                                
            productSTL.checked = productStringContains(productString, 'STL');
            
            productCC.checked = productStringContains(productString, 'Touchpoints') ||
                               productStringContains(productString, 'Cashback') ||
                               productStringContains(productString, 'Talabat') ||
                               productStringContains(productString, 'Lulu') ||
                               productStringContains(productString, 'Etihad') ||
                               productStringContains(productString, 'Shukran') ||
                               productStringContains(productString, 'All ') ||
                               productStringContains(productString, 'Traveller') ||
                               productStringContains(productString, 'Betaqti') ||
                               productStringContains(productString, 'Emirati') ||
                               productStringContains(productString, 'CC');
            
            product2ndCC.checked = productStringContains(productString, '2ndCC') ||
                                   (products.length > 1 && 
                                    (productStringContains(productString, 'Touchpoints') ||
                                     productStringContains(productString, 'Talabat')));
            
            productBTCCL.checked = productStringContains(productString, 'BT/CCL');
            
            productPL.checked = productStringContains(productString, 'Asipire Cat') ||
                               productStringContains(productString, 'Privilege Cat') ||
                               productStringContains(productString, 'PL');
            
            if (productPL.checked) {
                loanAmountSection.classList.remove('hidden');
                loanAmountInput.value = data['Loan Amount'] || '';
            }
            
            // Enable/disable dependent checkboxes
            productSTL.disabled = !productACC.checked;
            product2ndCC.disabled = !productCC.checked;
            
            // Set proposition
            const propositionRadios = document.getElementsByName('proposition');
            for (let radio of propositionRadios) {
                if (radio.value === data.Proposition) {
                    radio.checked = true;
                    break;
                }
            }
            
            // Set scheme
            const schemeRadios = document.getElementsByName('scheme');
            for (let radio of schemeRadios) {
                if (radio.value === data.Scheme) {
                    radio.checked = true;
                    break;
                }
            }
            
            // Set activation
            const activationRadios = document.getElementsByName('activation');
            for (let radio of activationRadios) {
                if (radio.value === data.Activation) {
                    radio.checked = true;
                    break;
                }
            }
            
            // Set banking
            if (data.Banking) {
                if (['SELECT', 'ADCB', 'ENBD', 'EIB', 'FAB', 'DIB', 'MASHREQ', 'ADIB', 'RAK', 'CBD', 'HSBC', 'CITI'].includes(data.Banking)) {
                    bankingSelect.value = data.Banking;
                } else {
                    bankingSelect.value = 'Other';
                    otherBankingSection.classList.remove('hidden');
                    otherBankingInput.value = data.Banking;
                }
            }
            
            // Set status
            if (data.Status) {
                if (['Draft', 'Under Review', 'Completed', 'HR CPV', 'Compliance'].includes(data.Status)) {
                    statusSelect.value = data.Status;
                } else {
                    statusSelect.value = 'Other';
                    otherStatusSection.classList.remove('hidden');
                    otherStatusInput.value = data.Status;
                }
            }
            
            // Set points
            pointsInput.value = data.Points || '';
            
            // Generate product options containers
            initializeProductOptions();
        }

        // Check if CID, Customer Name, or Mobile already exists
        async function checkUniqueness(cid, customerName, mobile) {
            try {
                const response = await fetch(`${scriptURL}?action=checkUnique&cid=${cid}&name=${encodeURIComponent(customerName)}&mobile=${mobile}`);
                return await response.json();
            } catch (error) {
                console.error('Error checking uniqueness:', error);
                showSuccess('Error checking uniqueness');
                return { 
                    success: false, 
                    data: { cidExists: false, nameExists: false, mobileExists: false },
                    error: error.message
                };
            }
        }

        // Validate form before submission
        async function validateForm() {
            let isValid = true;
            
            // Clear previous validation errors
            document.getElementById('cidError').classList.add('hidden');
            document.getElementById('nameError').classList.add('hidden');
            document.getElementById('mobileError').classList.add('hidden');
            document.getElementById('productsError').classList.add('hidden');
            
            // Basic field validation
            if (!cidInput.value.trim()) {
                cidInput.classList.add('error-field');
                isValid = false;
            } else {
                cidInput.classList.remove('error-field');
            }
            
            if (!dateInput.value) {
                dateInput.classList.add('error-field');
                isValid = false;
            } else {
                dateInput.classList.remove('error-field');
            }
            
            if (!salaryInput.value.trim()) {
                salaryInput.classList.add('error-field');
                isValid = false;
            } else {
                salaryInput.classList.remove('error-field');
            }
            
            if (!customerNameInput.value.trim()) {
                customerNameInput.classList.add('error-field');
                isValid = false;
            } else {
                customerNameInput.classList.remove('error-field');
            }
            
            if (!mobileInput.value.trim()) {
                mobileInput.classList.add('error-field');
                isValid = false;
            } else {
                mobileInput.classList.remove('error-field');
            }
            
            if (statusSelect.value === '') {
                statusSelect.classList.add('error-field');
                isValid = false;
            } else {
                statusSelect.classList.remove('error-field');
            }
            
            // Product validation - at least one product must be selected
            const productSelected = productACC.checked || productSTL.checked || productCC.checked || 
                                   product2ndCC.checked || productBTCCL.checked || productPL.checked;
            
            if (!productSelected) {
                document.getElementById('productsError').classList.remove('hidden');
                isValid = false;
            }
            
            // For update operations, we don't need to check uniqueness for the current record
            if (document.getElementById('updateBtn').classList.contains('hidden')) {
                // Check uniqueness only if basic validation passes
                if (isValid) {
                    showLoading();
                    const uniquenessCheck = await checkUniqueness(
                        cidInput.value.trim(),
                        customerNameInput.value.trim(),
                        mobileInput.value.trim()
                    );
                    hideLoading();
                    
                    if (uniquenessCheck.success && uniquenessCheck.data) {
                        if (uniquenessCheck.data.cidExists) {
                            document.getElementById('cidError').classList.remove('hidden');
                            cidInput.classList.add('error-field');
                            isValid = false;
                        }
                        
                        if (uniquenessCheck.data.nameExists) {
                            document.getElementById('nameError').classList.remove('hidden');
                            customerNameInput.classList.add('error-field');
                            isValid = false;
                        }
                        
                        if (uniquenessCheck.data.mobileExists) {
                            document.getElementById('mobileError').classList.remove('hidden');
                            mobileInput.classList.add('error-field');
                            isValid = false;
                        }
                    } else if (!uniquenessCheck.success) {
                        showSuccess(`Error checking uniqueness: ${uniquenessCheck.error}`);
                        isValid = false;
                    }
                }
            }
            
            return isValid;
        }

        // Collect form data for submission
        function collectFormData() {
            const formData = new FormData();
            
            // Add basic fields
            formData.append('cid', cidInput.value);
            formData.append('appId', appIdInput.value);
            
            const proposition = document.querySelector('input[name="proposition"]:checked').value;
            formData.append('proposition', proposition);
            
            formData.append('date', dateInput.value);
            formData.append('salary', salaryInput.value);
            formData.append('customerName', customerNameInput.value);
            formData.append('mobile', mobileInput.value);
            
            // Banking
            let bankingValue = bankingSelect.value;
            if (bankingValue === 'Other') {
                bankingValue = otherBankingInput.value || 'Other';
            }
            formData.append('banking', bankingValue);
            
            // Company Name
            formData.append('companyName', companyNameInput.value);
            
            // Scheme
            const scheme = document.querySelector('input[name="scheme"]:checked').value;
            formData.append('scheme', scheme);
            
            // Status
            let statusValue = statusSelect.value;
            if (statusValue === 'Other') {
                statusValue = otherStatusInput.value || 'Other';
            }
            formData.append('status', statusValue);
            
            // Activation
            const activation = document.querySelector('input[name="activation"]:checked').value;
            formData.append('activation', activation);
            
            // Points
            formData.append('points', pointsInput.value);
            
            // Fix 2: Collect selected product options to store in Product column
            const selectedProductOptions = [];
            
            // Get ACC selection
            if (productACC.checked) {
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect && accSelect.value) {
                    const selectedOption = accSelect.options[accSelect.selectedIndex];
                    selectedProductOptions.push(selectedOption.text.split(' (')[0]);  // Get text before any parentheses
                    formData.append('accOption', accSelect.value);
                } else {
                    selectedProductOptions.push('ACC');
                }
                
                // Include STL if checked
                if (productSTL.checked) {
                    selectedProductOptions.push('STL');
                }
            }
            
            // Get CC selection
            if (productCC.checked) {
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect && ccSelect.value) {
                    const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                    selectedProductOptions.push(selectedOption.text);
                    formData.append('ccOption', ccSelect.value);
                } else {
                    selectedProductOptions.push('CC');
                }
                
                // Get 2nd CC selection
                if (product2ndCC.checked) {
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select && cc2Select.value) {
                        const selectedOption = cc2Select.options[cc2Select.selectedIndex];
                        selectedProductOptions.push(selectedOption.text);
                        formData.append('ccOption2', cc2Select.value);
                    } else {
                        selectedProductOptions.push('2ndCC');
                    }
                }
            }
            
            // Include BT/CCL if checked
            if (productBTCCL.checked) {
                selectedProductOptions.push('BT/CCL');
            }
            
            // Get PL selection
            if (productPL.checked) {
                const plSelect = document.getElementById('PLSelect');
                if (plSelect && plSelect.value) {
                    const selectedOption = plSelect.options[plSelect.selectedIndex];
                    selectedProductOptions.push(selectedOption.text);
                    formData.append('plOption', plSelect.value);
                } else {
                    selectedProductOptions.push('PL');
                }
                formData.append('loanAmount', loanAmountInput.value);
            }
            
            // Join all product selections into a single string
            const productList = selectedProductOptions.join(', ');
            formData.append('productList', productList);
            
            return formData;
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================

        // Form submit event
        entryForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (await validateForm()) {
                const formData = collectFormData();
                formData.append('action', 'add');
                await submitFormData(formData);
            }
        });

        // Update button click event
        document.getElementById('updateBtn').addEventListener('click', async function() {
            if (await validateForm()) {
                const formData = collectFormData();
                await updateRecord(formData);
            }
        });

        // Delete button click event
        document.getElementById('deleteBtn').addEventListener('click', function() {
            const cid = cidInput.value;
            if (cid && confirm('Are you sure you want to delete this record?')) {
                deleteRecord(cid);
            }
        });

        // Refresh data button click event
        document.getElementById('refreshDataBtn').addEventListener('click', function() {
            fetchAllData();
        });

        // Search button click event
        document.getElementById('searchBtn').addEventListener('click', function() {
            searchData();
        });
    </script>
</body>
</html>
