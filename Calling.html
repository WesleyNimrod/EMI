<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calling System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
        }
        
        .custom-btn {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
            transition: all 0.3s;
        }
        
        .custom-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #6F2C4F 0%, #262a5a 100%);
        }
        
        .success-indicator {
            background: rgb(22, 163, 74);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }

        .loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6F2C4F;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Table styling */
        .calling-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        .calling-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .calling-table tr:hover {
            background-color: #ddd;
        }

        .calling-table td {
            padding: 8px;
            position: relative;
        }

        /* Editable cell styling */
        .editable {
            position: relative;
            cursor: text;
            transition: background-color 0.2s;
        }

        .editable:hover {
            background-color: rgba(111, 44, 79, 0.1);
        }

        .editable.active {
            background-color: rgba(111, 44, 79, 0.15);
            outline: 2px solid #6F2C4F;
        }

        /* Copyable cell styling */
        .copyable {
            cursor: pointer;
            position: relative;
            user-select: all;
        }

        .copyable::after {
            content: "Copied!";
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .copyable.copied::after {
            opacity: 1;
            animation: fadeAfterCopy 1.5s forwards;
        }

        @keyframes fadeAfterCopy {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Filter inputs */
        .filter-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-item {
            flex: 1;
            min-width: 150px;
        }

        /* Scrollable table container */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        /* Call buttons */
        .call-btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            color: white;
            margin-right: 8px;
            transition: transform 0.2s;
        }
        
        .call-btn:hover {
            transform: scale(1.1);
        }

        .direct-call {
            background-color: #16a34a;
        }
        
        .teams-call {
            background-color: #4f46e5;
        }
        
        .whatsapp-call {
            background-color: #25D366;
        }
        
        .comment-btn {
            background-color: #eab308;
        }

        /* Result dropdown styling */
        .result-dropdown {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Table header */
        .calling-table th {
            background-color: #6F2C4F;
            color: white;
            text-align: left;
            padding: 10px 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Error message */
        .error-message {
            color: #ef4444;
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ef4444;
            border-radius: 4px;
            background-color: rgba(239, 68, 68, 0.1);
        }
        
        /* Placeholder content for empty table */
        .table-placeholder {
            padding: 30px;
            text-align: center;
            color: #6b7280;
        }
        
        /* Semi-transparent section background */
        .section-header {
            background-color: rgba(111, 44, 79, 0.08);
            border-left: 4px solid #6F2C4F;
            padding: 10px 15px;
            border-radius: 0 4px 4px 0;
        }
        
        /* Undo indicator */
        .undo-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .undo-btn {
            background: white;
            color: black;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .undo-btn:hover {
            background: #eee;
        }
        
        /* Tooltip */
        .tooltip {
            position: relative;
        }
        
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Comment Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .modal-close {
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .modal-close:hover {
            color: black;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .comment-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-size: 16px;
        }

        /* Comment toggle */
        .comment-mode-toggle {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        /* Call Counter */
        .call-counter {
            display: inline-flex;
            align-items: center;
            background-color: #6F2C4F;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .call-counter i {
            margin-right: 5px;
        }
        
        /* Editable cells */
        .editable-cell {
            position: relative;
            cursor: pointer;
        }
        
        .editable-cell.editing {
            padding: 0;
        }
        
        .editable-cell input {
            width: 100%;
            padding: 8px;
            border: 1px solid #6F2C4F;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-50 font-tahoma">
    <div class="container mx-auto px-3 py-4 w-full">
        
        <div class="bg-white p-4 rounded-lg shadow-md mb-4">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <div class="section-header flex items-center">
                    <h2 class="text-xl font-bold text-[#6F2C4F]">Calling List</h2>
                    <div class="call-counter ml-3">
                        <i class="fas fa-phone-volume"></i>
                        <span id="callCounter">0</span> calls today
                    </div>
                    <p class="text-gray-600 text-sm ml-4" id="recordsInfo">Showing 0 records</p>
                </div>
                <div class="flex gap-2">
                    <button id="refreshBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                    </button>
                    <a href="https://docs.google.com/spreadsheets/d/1VfEPU_2EvNqB6g2ldAzD05fvwFigL1yN3L0wLOwZP4o/edit?gid=276425933#gid=276425933" target="_blank" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-file-excel mr-2"></i> Sheet
                    </a>
                    <button id="undoBtn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 flex items-center tooltip">
                        <i class="fas fa-undo mr-2"></i> Undo
                        <span class="tooltip-text">Undo last change</span>
                    </button>
                    <button id="showMoreBtn" class="bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 flex items-center hidden">
                        <i class="fas fa-expand-alt mr-2"></i> Show More
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <div class="flex justify-between items-center">
                    <h3 class="font-semibold text-lg mb-2 text-[#6F2C4F]">Filters</h3>
                    <button id="clearFiltersBtn" class="text-sm text-blue-600">Clear All</button>
                </div>
                <div class="filter-container">
                    <div class="filter-item">
                        <select id="resultFilter" class="w-full border rounded-md p-2 text-base">
                            <option value="">All Results</option>
                            <option value="To Call">To Call</option>
                            <option value="No Answer">No Answer</option>
                            <option value="Busy">Busy</option>
                            <option value="Not Interested">Not Interested</option>
                            <option value="Interested">Interested</option>
                            <option value="ROI Inquired">ROI Inquired</option>
                            <option value="Call back">Call back</option>
                            <option value="On Hold">On Hold</option>
                            <option value="In Future, Shared details">In Future, Shared details</option>
                            <option value="Switched off">Switched off</option>
                            <option value="Referal">Referal</option>
                            <option value="Completed">Completed</option>
                            <option value="Rejected">Rejected</option>
                            <option value="Option 1">Option 1</option>
                            <option value="Option 2">Option 2</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <input type="text" id="nameFilter" placeholder="Filter by name" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="companyFilter" placeholder="Filter by company" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="schemeFilter" placeholder="Filter by scheme" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="text" id="bankFilter" placeholder="Filter by bank" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div class="filter-item">
                        <input type="number" id="salaryFilter" placeholder="Min salary" class="w-full border rounded-md p-2 text-base">
                    </div>
                </div>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow-md">
            <div class="table-container">
                <table id="callingTable" class="calling-table" style="border-spacing: 0;">
                    <thead>
                        <tr>
                            <th style="width: 110px;">Actions</th>
                            <th style="width: 150px;">Result</th>
                            <th style="width: 120px;">Mobile</th>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Scheme</th>
                            <th>Bank</th>
                            <th style="width: 100px;">Salary</th>
                        </tr>
                    </thead>
                    <tbody id="callingTableBody">
                        <tr>
                            <td colspan="8" class="table-placeholder">
                                <div class="py-8">
                                    <i class="fas fa-spinner fa-spin text-3xl mb-4 text-[#6F2C4F]"></i>
                                    <p>Loading data, please wait...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="errorContainer" class="hidden error-message">
                <i class="fas fa-exclamation-triangle mr-2"></i> <span id="errorMessage">Error loading data</span>
            </div>
        </div>
    </div>

    <div id="successIndicator" class="success-indicator hidden">
        <span id="successMessage">Operation successful!</span>
    </div>

    <div id="loadingIndicator" class="loading-indicator hidden">
        <div class="spinner"></div>
    </div>

    <div id="undoNotification" class="undo-indicator hidden">
        <span id="undoMessage">Change saved!</span>
        <button id="undoChangeBtn" class="undo-btn">Undo</button>
    </div>

    <div id="commentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-lg font-semibold">Add Comment</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <p class="mb-2">Enter your comment for <span id="commentName" class="font-semibold"></span></p>
                <textarea id="commentText" class="comment-textarea" placeholder="Type your comment here..."></textarea>
                <input type="hidden" id="commentRowIndex">
                <input type="hidden" id="commentColumn">
                <div class="comment-mode-toggle">
                    <label class="flex items-center">
                        <input type="radio" name="commentType" value="sheet" checked>
                        <span class="ml-2">Add sheet comment (yellow triangle)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="commentType" value="value">
                        <span class="ml-2">Update result value</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button id="cancelCommentBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="saveCommentBtn" class="custom-btn text-white py-2 px-4 rounded-md">Save Comment</button>
            </div>
        </div>
    </div>

    <script>
        // *** IMPORTANT: Replace 'YOUR_WEB_APP_URL_HERE' with your actual Google Apps Script Web App URL ***
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwngb8Ka97Re88mDNaT60W-b_Ts4VQTf0DKSrJVUXra1Za8OtdNbG4gmrWIwfSSXaz9Rg/exec'; 
        const BATCH_SIZE = 50; // Number of records to load initially / per "Show More" click
        let allData = [];
        let displayedData = [];
        let currentIndex = 0;
        let lastUndoAction = null;
        const columnNames = ["Actions", "Result", "Mobile", "Name", "Company", "Scheme", "Bank", "Salary"]; // Added "Actions" for the first column
        let callCount = 0;
        let longPressTimer;
        let priorityResultOptions = ["To Call", "No Answer", "Interested", "Busy"];
        let changedRows = {}; // Track which rows have been changed today

        document.addEventListener('DOMContentLoaded', function() {
            // Load call count and changed rows from localStorage if available
            loadCallData();
            
            // Check if we need to reset the call counter (new day)
            checkAndResetDailyCounter();
            
            // Initial data load
            fetchCallingData();

            // Event Listeners
            document.getElementById('refreshBtn').addEventListener('click', fetchCallingData);
            document.getElementById('showMoreBtn').addEventListener('click', loadMoreData);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
            document.getElementById('undoBtn').addEventListener('click', undoLastChange);
            document.getElementById('saveCommentBtn').addEventListener('click', saveComment);
            document.getElementById('cancelCommentBtn').addEventListener('click', hideCommentModal);
            document.querySelector('.modal-close').addEventListener('click', hideCommentModal);

            // Filter listeners
            document.getElementById('resultFilter').addEventListener('change', applyFilters);
            document.getElementById('nameFilter').addEventListener('input', applyFilters);
            document.getElementById('companyFilter').addEventListener('input', applyFilters);
            document.getElementById('schemeFilter').addEventListener('input', applyFilters);
            document.getElementById('bankFilter').addEventListener('input', applyFilters);
            document.getElementById('salaryFilter').addEventListener('input', applyFilters);

            // Format phone number with country code
            function formatPhoneWithCountryCode(phone) {
                if (!phone) return '';
                
                // Remove any non-digit characters
                const digits = phone.toString().replace(/\D/g, '');
                
                // If it already starts with 971, don't add it again
                if (digits.startsWith('971')) {
                    return digits;
                }
                
                // If it starts with 0, remove the 0 before adding 971
                if (digits.startsWith('0')) {
                    return '971' + digits.substring(1);
                }
                
                // Otherwise, just add 971 as prefix
                return '971' + digits;
            }

            // Fetch data from Google Sheet
            async function fetchCallingData() {
                showLoadingIndicator();
                hideError();
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=getCallingData`);
                    const result = await response.json();

                    if (result.success) {
                        allData = result.data;
                        applyFilters(); // Apply filters to the newly fetched data
                        showSuccessIndicator('Data refreshed!');
                    } else {
                        showError(result.error || 'Failed to fetch data.');
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                    showError('Network error or invalid Apps Script URL. Check console for details.');
                } finally {
                    hideLoadingIndicator();
                }
            }

            // Apply filters and populate table
            function applyFilters() {
                const resultFilter = document.getElementById('resultFilter').value.toLowerCase();
                const nameFilter = document.getElementById('nameFilter').value.toLowerCase();
                const companyFilter = document.getElementById('companyFilter').value.toLowerCase();
                const schemeFilter = document.getElementById('schemeFilter').value.toLowerCase();
                const bankFilter = document.getElementById('bankFilter').value.toLowerCase();
                const salaryFilter = parseFloat(document.getElementById('salaryFilter').value);

                // Filter data, excluding DNCR results
                const filteredData = allData.filter(record => {
                    // Skip any record with DNCR as result
                    if (record.Result === "DNCR") {
                        return false;
                    }
                    
                    const matchesResult = resultFilter === "" || record.Result.toLowerCase().includes(resultFilter);
                    const matchesName = nameFilter === "" || record.Name.toLowerCase().includes(nameFilter);
                    const matchesCompany = companyFilter === "" || record.Company.toLowerCase().includes(companyFilter);
                    const matchesScheme = schemeFilter === "" || record.Scheme.toLowerCase().includes(schemeFilter);
                    const matchesBank = bankFilter === "" || record.Bank.toLowerCase().includes(bankFilter);
                    const matchesSalary = isNaN(salaryFilter) || parseFloat(record.Salary) >= salaryFilter;
                    
                    return matchesResult && matchesName && matchesCompany && matchesScheme && matchesBank && matchesSalary;
                });

                // Sort data by Result value according to priority
                const sortedData = filteredData.sort((a, b) => {
                    // Helper function to get priority index
                    const getPriorityIndex = (result) => {
                        const index = priorityResultOptions.indexOf(result);
                        return index === -1 ? priorityResultOptions.length : index;
                    };
                    
                    // Get priority indexes for comparison
                    const aPriority = getPriorityIndex(a.Result);
                    const bPriority = getPriorityIndex(b.Result);
                    
                    // Sort by priority
                    return aPriority - bPriority;
                });

                displayedData = sortedData;
                currentIndex = 0; // Reset index for new filtered data
                populateTable(true); // Clear and repopulate
            }

            // Populate table with data
            function populateTable(clearExisting = false) {
                const tableBody = document.getElementById('callingTableBody');
                if (clearExisting) {
                    tableBody.innerHTML = '';
                }

                if (displayedData.length === 0 && clearExisting) {
                    tableBody.innerHTML = `<tr><td colspan="${columnNames.length}" class="table-placeholder">No records found.</td></tr>`;
                    document.getElementById('showMoreBtn').classList.add('hidden');
                    document.getElementById('recordsInfo').textContent = `Showing 0 records`;
                    return;
                }

                const fragment = document.createDocumentFragment();
                const endIndex = Math.min(currentIndex + BATCH_SIZE, displayedData.length);

                for (let i = currentIndex; i < endIndex; i++) {
                    const record = displayedData[i];
                    const row = document.createElement('tr');
                    
                    // Actions column
                    const actionsCell = document.createElement('td');
                    actionsCell.style.width = '110px';
                    
                    // Format the mobile number with country code
                    const formattedMobile = formatPhoneWithCountryCode(record.Mobile || '');
                    
                    // Direct call button
                    const directCallBtn = document.createElement('a');
                    directCallBtn.href = `tel:+${formattedMobile}`;
                    directCallBtn.classList.add('call-btn', 'direct-call', 'tooltip');
                    directCallBtn.title = `Call ${record.Name || 'Unknown'}`;
                    directCallBtn.innerHTML = '<i class="fas fa-phone"></i><span class="tooltip-text">Call</span>';
                    
                    // Teams call button
                    const teamsBtn = document.createElement('a');
                    teamsBtn.href = `https://teams.microsoft.com/l/call/0/0?users=4:+971${formattedMobile}`;
                    teamsBtn.target = "_blank";
                    teamsBtn.classList.add('call-btn', 'teams-call', 'tooltip');
                    teamsBtn.title = `Teams Call ${record.Name || 'Unknown'}`;
                    teamsBtn.innerHTML = '<i class="fas fa-users"></i><span class="tooltip-text">Teams</span>';
                    
                    // WhatsApp button
                    const whatsappBtn = document.createElement('a');
                    whatsappBtn.href = `https://wa.me/${formattedMobile}?text=Hello ${encodeURIComponent(record.Name || '')},`;
                    whatsappBtn.target = "_blank";
                    whatsappBtn.classList.add('call-btn', 'whatsapp-call', 'tooltip');
                    whatsappBtn.title = `WhatsApp ${record.Name || 'Unknown'}`;
                    whatsappBtn.innerHTML = '<i class="fab fa-whatsapp"></i><span class="tooltip-text">WhatsApp</span>';
                    
                    // Comment button
                    const commentBtn = document.createElement('button');
                    commentBtn.classList.add('call-btn', 'comment-btn', 'tooltip');
                    commentBtn.dataset.rowIndex = record.rowIndex;
                    commentBtn.dataset.columnName = 'Result';
                    commentBtn.innerHTML = '<i class="fas fa-comment"></i><span class="tooltip-text">Add Comment</span>';
                    
                    actionsCell.appendChild(directCallBtn);
                    actionsCell.appendChild(teamsBtn);
                    actionsCell.appendChild(whatsappBtn);
                    actionsCell.appendChild(commentBtn);
                    row.appendChild(actionsCell);

                    // Data columns
                    columnNames.slice(1).forEach(colName => {
                        const cell = document.createElement('td');
                        const value = record[colName] || '';
                        
                        if (colName === 'Result') {
                            // Result dropdown with actual values from Google Sheet
                            const select = document.createElement('select');
                            select.className = 'result-dropdown';
                            
                            // Create empty option first
                            const emptyOption = document.createElement('option');
                            emptyOption.value = '';
                            emptyOption.textContent = 'Select Result';
                            select.appendChild(emptyOption);
                            
                            // All possible result options including DNCR
                            const resultOptions = [
                                'To Call', 'No Answer', 'Busy', 'DNCR', 'Not Interested', 
                                'Interested', 'ROI Inquired', 'Call back', 'On Hold', 
                                'In Future, Shared details', 'Switched off', 'Referal',
                                'Completed', 'Rejected', 'Option 1', 'Option 2'
                            ];
                            
                            // Add all result options
                            resultOptions.forEach(option => {
                                const optionEl = document.createElement('option');
                                optionEl.value = option;
                                optionEl.textContent = option;
                                if (value === option) {
                                    optionEl.selected = true;
                                }
                                select.appendChild(optionEl);
                            });
                            
                            // Add change event listener
                            select.addEventListener('change', function() {
                                const oldValue = value;
                                const newValue = this.value;
                                updateCell(record.rowIndex, colName, newValue, oldValue);
                                // Track this row as changed and maybe increment counter
                                trackRowChange(record.rowIndex);
                            });
                            cell.appendChild(select);
                        } else if (colName === 'Mobile') {
                            cell.textContent = value;
                            cell.classList.add('copyable');
                            cell.addEventListener('click', function() {
                                copyToClipboard(this.textContent, this);
                            });
                        } else {
                            // Make all other columns editable on long press
                            cell.textContent = value;
                            cell.classList.add('editable-cell');
                            
                            // Set up long press handling
                            cell.addEventListener('mousedown', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                }, 1000); // 1000ms = 1 second
                            });
                            
                            cell.addEventListener('mouseup', function() {
                                clearTimeout(longPressTimer);
                            });
                            
                            cell.addEventListener('mouseleave', function() {
                                clearTimeout(longPressTimer);
                            });
                            
                            // For touch devices
                            cell.addEventListener('touchstart', function(e) {
                                const element = this;
                                longPressTimer = setTimeout(function() {
                                    makeEditable(element, record.rowIndex, colName, value);
                                }, 1000);
                            });
                            
                            cell.addEventListener('touchend', function() {
                                clearTimeout(longPressTimer);
                            });
                            
                            cell.addEventListener('touchcancel', function() {
                                clearTimeout(longPressTimer);
                            });
                        }
                        row.appendChild(cell);
                    });
                    fragment.appendChild(row);
                }

                tableBody.appendChild(fragment);
                currentIndex = endIndex;

                // Attach event listeners for dynamically added buttons
                attachButtonListeners(tableBody);

                updateRecordsInfo();
            }

            // Make a cell editable
            function makeEditable(cell, rowIndex, columnName, currentValue) {
                cell.classList.add('editing');
                cell.innerHTML = '';
                
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentValue;
                input.classList.add('edit-input');
                
                cell.appendChild(input);
                input.focus();
                
                // Handle saving on blur or Enter key
                input.addEventListener('blur', function() {
                    saveEditedCell(cell, rowIndex, columnName, this.value, currentValue);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        saveEditedCell(cell, rowIndex, columnName, this.value, currentValue);
                    } else if (e.key === 'Escape') {
                        cell.innerHTML = currentValue;
                        cell.classList.remove('editing');
                    }
                });
            }
            
            // Save edited cell value
            function saveEditedCell(cell, rowIndex, columnName, newValue, oldValue) {
                if (newValue !== oldValue) {
                    updateCell(rowIndex, columnName, newValue, oldValue);
                }
                
                cell.textContent = newValue;
                cell.classList.remove('editing');
            }

            function loadMoreData() {
                populateTable(false); // Do not clear existing data
            }

            function updateRecordsInfo() {
                const recordsInfo = document.getElementById('recordsInfo');
                recordsInfo.textContent = `Showing ${displayedData.length} records`;

                const showMoreBtn = document.getElementById('showMoreBtn');
                if (currentIndex < displayedData.length) {
                    showMoreBtn.classList.remove('hidden');
                } else {
                    showMoreBtn.classList.add('hidden');
                }
            }

            // Clear filter inputs
            function clearFilters() {
                document.getElementById('resultFilter').value = "";
                document.getElementById('nameFilter').value = "";
                document.getElementById('companyFilter').value = "";
                document.getElementById('schemeFilter').value = "";
                document.getElementById('bankFilter').value = "";
                document.getElementById('salaryFilter').value = "";
                applyFilters();
            }

            // Attach event listeners for call and comment buttons
            function attachButtonListeners(container) {
                container.querySelectorAll('.direct-call').forEach(button => {
                    button.removeEventListener('click', handleCallClick); // Prevent double-listening
                    button.addEventListener('click', handleCallClick);
                });
                container.querySelectorAll('.teams-call').forEach(button => {
                    button.removeEventListener('click', handleTeamsClick); // Prevent double-listening
                    button.addEventListener('click', handleTeamsClick);
                });
                container.querySelectorAll('.whatsapp-call').forEach(button => {
                    button.removeEventListener('click', handleWhatsappClick); // Prevent double-listening
                    button.addEventListener('click', handleWhatsappClick);
                });
                container.querySelectorAll('.comment-btn').forEach(button => {
                    button.removeEventListener('click', handleCommentClick); // Prevent double-listening
                    button.addEventListener('click', handleCommentClick);
                });
            }

            function handleCallClick(event) {
                const mobile = this.getAttribute('href').replace('tel:+', '');
                if (mobile) {
                    incrementCallCounter();
                    window.location.href = `tel:+${mobile}`;
                } else {
                    alert('Mobile number not available.');
                }
            }
            
            function handleTeamsClick(event) {
                const mobile = this.getAttribute('href').replace('https://teams.microsoft.com/l/call/0/0?users=4:+971', '');
                if (mobile) {
                    incrementCallCounter();
                }
            }

            function handleWhatsappClick(event) {
                const mobile = this.getAttribute('href').replace('https://wa.me/', '').split('?')[0];
                if (mobile) {
                    incrementCallCounter();
                }
            }

            function handleCommentClick() {
                const rowIndex = this.dataset.rowIndex;
                const columnName = this.dataset.columnName; // This is always 'Result' from your HTML
                // Assuming 'Name' is always in the 4th cell (index 3 if 0-indexed) of the same row
                const customerName = this.closest('tr').querySelector('td:nth-child(4)').textContent; 
                showCommentModal(rowIndex, columnName, customerName);
            }

            // Track row changes for call counter
            function trackRowChange(rowIndex) {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                
                // If this row hasn't been changed today
                if (!changedRows[rowIndex]) {
                    // Mark as changed
                    changedRows[rowIndex] = today;
                    // Increment call counter
                    incrementCallCounter();
                    // Save updated tracking data
                    saveCallData();
                }
            }

            // Update cell value in Google Sheet
            async function updateCell(rowIndex, columnName, newValue, oldValue) {
                showLoadingIndicator();
                hideError();
                try {
                    const response = await fetch(`${WEB_APP_URL}?action=updateCallingCell&row=${rowIndex}&column=${columnName}&value=${encodeURIComponent(newValue)}`);
                    const result = await response.json();

                    if (result.success) {
                        showSuccessIndicator('Cell updated successfully!');
                        // Store undo information
                        lastUndoAction = {
                            action: 'update',
                            rowIndex: rowIndex,
                            columnName: columnName,
                            oldValue: oldValue,
                            newValue: newValue
                        };
                        showUndoNotification();
                    } else {
                        showError(result.error || 'Failed to update cell.');
                        // Revert the UI change if update failed
                        // Find the original cell and revert its value/selection
                        const tableBody = document.getElementById('callingTableBody');
                        const rows = tableBody.querySelectorAll('tr');
                        
                        for (let i = 0; i < rows.length; i++) {
                            const row = rows[i];
                            const cells = row.querySelectorAll('td');
                            
                            // Check if this is the row we're looking for
                            if (cells.length > 0) {
                                const actionCell = cells[0];
                                const commentBtn = actionCell.querySelector('.comment-btn');
                                
                                if (commentBtn && commentBtn.dataset.rowIndex == rowIndex) {
                                    // This is our row
                                    const colIndexInHtmlTable = columnNames.indexOf(columnName);
                                    if (colIndexInHtmlTable !== -1) {
                                        const targetCell = cells[colIndexInHtmlTable];
                                        if (columnName === 'Result') {
                                            targetCell.querySelector('.result-dropdown').value = oldValue;
                                        } else {
                                            targetCell.textContent = oldValue;
                                        }
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error updating cell:', error);
                    showError('Network error during cell update. Check console for details.');
                    // Similar reversion code as above for network errors
                } finally {
                    hideLoadingIndicator();
                }
            }

            async function undoLastChange() {
                if (!lastUndoAction) {
                    alert('No action to undo.');
                    return;
                }

                showLoadingIndicator();
                hideUndoNotification(); // Hide undo notification immediately
                try {
                    const { action, rowIndex, columnName, oldValue } = lastUndoAction;
                    let response;
                    let result;

                    if (action === 'update') {
                        // Undo an update by setting the value back to oldValue
                        response = await fetch(`${WEB_APP_URL}?action=updateCallingCell&row=${rowIndex}&column=${columnName}&value=${encodeURIComponent(oldValue)}`);
                        result = await response.json();

                        if (result.success) {
                            showSuccessIndicator('Last change undone!');
                            // Update UI to reflect undone change
                            fetchCallingData(); // Re-fetch to ensure consistency
                            
                            // If undoing a Result column change, remove this row from today's changed rows
                            if (columnName === 'Result' && changedRows[rowIndex]) {
                                delete changedRows[rowIndex];
                                decrementCallCounter();
                                saveCallData();
                            }
                            
                            lastUndoAction = null; // Clear undo action after successful undo
                        } else {
                            showError(result.error || 'Failed to undo change.');
                        }
                    }
                } catch (error) {
                    console.error('Error undoing change:', error);
                    showError('Network error during undo. Check console for details.');
                } finally {
                    hideLoadingIndicator();
                }
            }

            // Function to handle saving the comment
            async function saveComment() {
                const rowIndex = document.getElementById('commentRowIndex').value;
                const column = document.getElementById('commentColumn').value; // This will be 'Result'
                const commentText = document.getElementById('commentText').value;
                const commentType = document.querySelector('input[name="commentType"]:checked').value; // 'sheet' or 'value'

                if (!commentText.trim()) {
                    alert('Comment cannot be empty.');
                    return;
                }

                showLoadingIndicator();
                try {
                    let apiUrl = `${WEB_APP_URL}`;
                    let successMessage = '';

                    if (commentType === 'sheet') {
                        // This sends a GET request to doGet with action=addCellComment
                        apiUrl += `?action=addCellComment&row=${rowIndex}&column=${column}&comment=${encodeURIComponent(commentText)}`;
                        successMessage = 'Comment added to cell!';
                    } else if (commentType === 'value') {
                        // This sends a GET request to doGet with action=updateCallingCell
                        apiUrl += `?action=updateCallingCell&row=${rowIndex}&column=${column}&value=${encodeURIComponent(commentText)}`;
                        successMessage = 'Cell value updated!';
                        
                        // Track row change for call counter
                        trackRowChange(rowIndex);
                    }
                    
                    const response = await fetch(apiUrl);
                    const result = await response.json(); // Apps Script returns JSON

                    if (result.success) {
                        showSuccessIndicator(successMessage);
                        hideCommentModal();
                        if (commentType === 'value') {
                            // If value was updated, refresh data to reflect the change
                            fetchCallingData();
                        }
                    } else {
                        showError(result.error || 'Unknown error');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showError('Failed to add comment: ' + error.message);
                } finally {
                    hideLoadingIndicator();
                }
            }
            
            // Call counter functions
            function incrementCallCounter() {
                callCount++;
                document.getElementById('callCounter').textContent = callCount;
                saveCallData();
            }
            
            function decrementCallCounter() {
                if (callCount > 0) {
                    callCount--;
                    document.getElementById('callCounter').textContent = callCount;
                    saveCallData();
                }
            }
            
            function saveCallData() {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                localStorage.setItem('callCount', callCount.toString());
                localStorage.setItem('callCountDate', today);
                localStorage.setItem('changedRows', JSON.stringify(changedRows));
            }
            
            function loadCallData() {
                const storedCount = localStorage.getItem('callCount');
                if (storedCount !== null) {
                    callCount = parseInt(storedCount, 10);
                    document.getElementById('callCounter').textContent = callCount;
                }
                
                const storedChangedRows = localStorage.getItem('changedRows');
                if (storedChangedRows) {
                    changedRows = JSON.parse(storedChangedRows);
                }
            }
            
            function checkAndResetDailyCounter() {
                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                const lastDate = localStorage.getItem('callCountDate');
                
                if (lastDate !== today) {
                    // It's a new day, reset counter and changed rows tracking
                    callCount = 0;
                    changedRows = {};
                    document.getElementById('callCounter').textContent = '0';
                    saveCallData();
                }
            }

            // Modal functions
            function showCommentModal(rowIndex, columnName, customerName) {
                document.getElementById('commentModal').style.display = 'flex';
                document.getElementById('commentRowIndex').value = rowIndex;
                document.getElementById('commentColumn').value = columnName; // 'Result'
                document.getElementById('commentName').textContent = customerName;
                document.getElementById('commentText').value = ''; // Clear previous comment
                document.querySelector('input[name="commentType"][value="sheet"]').checked = true; // Default to sheet comment
            }

            function hideCommentModal() {
                document.getElementById('commentModal').style.display = 'none';
            }

            // Utility functions
            function showLoadingIndicator() {
                document.getElementById('loadingIndicator').classList.remove('hidden');
            }

            function hideLoadingIndicator() {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }

            function showSuccessIndicator(message) {
                const indicator = document.getElementById('successIndicator');
                document.getElementById('successMessage').textContent = message;
                indicator.classList.remove('hidden');
                indicator.style.opacity = '1';
                indicator.style.animation = 'none'; // Reset animation
                void indicator.offsetWidth; // Trigger reflow
                indicator.style.animation = 'fadeOut 2s forwards'; // Re-apply animation
            }

            function showError(message) {
                const errorContainer = document.getElementById('errorContainer');
                document.getElementById('errorMessage').textContent = message;
                errorContainer.classList.remove('hidden');
            }

            function hideError() {
                document.getElementById('errorContainer').classList.add('hidden');
            }

            function showUndoNotification() {
                const undoNotification = document.getElementById('undoNotification');
                undoNotification.classList.remove('hidden');
            }

            function hideUndoNotification() {
                document.getElementById('undoNotification').classList.add('hidden');
            }

            function copyToClipboard(text, element) {
                navigator.clipboard.writeText(text).then(() => {
                    element.classList.add('copied');
                    setTimeout(() => {
                        element.classList.remove('copied');
                    }, 1500); // Matches animation duration
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                });
            }

            // Close modal if clicked outside
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('commentModal');
                if (event.target === modal) {
                    hideCommentModal();
                }
            });
            
            // Add information about cell comments
            const tableContainer = document.querySelector('.table-container');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'text-sm text-gray-600 mt-2';
            infoDiv.innerHTML = 'Tip: Right-click on any cell to add a Google Sheets comment (appears as a yellow triangle). Click the comment button <i class="fas fa-comment text-yellow-500"></i> to update the Result value.';
            tableContainer.parentNode.insertBefore(infoDiv, tableContainer.nextSibling);
        });
    </script>
</body>
</html>
