<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Management Information System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
    
body {
        font-family: 'Tahoma', Geneva, sans-serif;
        margin: 0;
        padding: 0;
        width: 100vw;
        height: 100vh;
        overflow-x: hidden;
    }
    
    .custom-btn {
        background: linear-gradient(135deg, #00FBFF 0%, #2E5D70 100%);
        transition: all 0.3s;
    }
    
    .custom-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    .gradient-primary {
        background: linear-gradient(135deg, #00FBFF 0%, #00D4FF 100%);
    }
    
    .success-indicator {
        background: linear-gradient(135deg, #FFD1D1 0%, #59E3FF 100%);
        color: #333;
        padding: 8px 12px;
        border-radius: 4px;
        position: fixed;
        top: 20px;
        right: 20px;
        animation: fadeOut 2s forwards;
        animation-delay: 1s;
        z-index: 100;
        font-weight: 500;
    }
    
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    .loading-indicator {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #00FBFF;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-field {
        border-color: #ef4444 !important;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th {
        background: linear-gradient(135deg, #00FBFF 0%, #00D4FF 100%);
        color: white;
        text-align: left;
        padding: 8px;
    }

    .data-table tr:nth-child(even) {
        background-color: #DEBFCF;
    }

    .data-table tr:hover {
        background-color: #ddd;
    }

    .data-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    .required::after {
        content: " *";
        color: #ef4444;
    }
    
    .section {
        display: none;
    }
    
    .section.active {
        display: block;
    }
    
    .points-btn {
        font-weight: bold;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        display: inline-flex;
        align-items: center;
        margin-right: 0.5rem;
    }
    
    .points-btn.earned {
        background-color: #10b981;
        color: white;
    }
    
    .points-btn.pending {
        background-color: #f59e0b;
        color: white;
    }
    
    /* Print styles */
    @media print {
        body * {
            visibility: hidden;
        }
        
        #summarySection, #summarySection * {
            visibility: visible;
        }
        
        #summarySection {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        
        .no-print {
            display: none !important;
        }
    }
    
    /* Progress bar styles */
    .progress-bar {
        width: 100%;
        height: 24px;
        background-color: #f3f3f3;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 10px;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        transition: width 0.5s ease;
    }
    
    .target-input {
        width: 100px;
        padding: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
    }
    
    .summary-card {
        background-color: white;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 12px;
    }
    
    .summary-card h3 {
        color: #00D4FF;
        margin-bottom: 8px;
        font-weight: bold;
        font-size: 1.1rem;
        padding-bottom: 6px;
        border-bottom: 1px solid #f3f3f3;
    }

    /* Fix 2: Make CID and Mobile fields copyable */
    .copyable {
        cursor: pointer;
        position: relative;
        user-select: all;
    }

    .copyable::after {
        content: "Copied!";
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #333;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.2s;
        pointer-events: none;
    }

    .copyable.copied::after {
        opacity: 1;
        animation: fadeAfterCopy 1.5s forwards;
    }

    @keyframes fadeAfterCopy {
        0% { opacity: 1; }
        70% { opacity: 1; }
        100% { opacity: 0; }
    }

    /* Fix 1: Increase action buttons spacing */
    .action-column {
        min-width: 80px;
        white-space: nowrap;
        width: 80px;
    }

    .action-btn {
        margin-right: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }
    
    /* Visualizations */
    .visualizations-header {
        background: linear-gradient(135deg, #00FBFF 0%, #2E5D70 100%);
        color: white;
        padding: 8px 12px;
        font-weight: bold;
        border-radius: 4px;
        font-size: 0.95rem;
    }
    
    .visualization-container {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .chart-box {
        width: 32%;
        background: white;
        border-radius: 8px;
        padding: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        margin-bottom: 10px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .chart-box:hover {
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    @media (max-width: 768px) {
        .chart-box {
            width: 100%;
        }
    }
    
    .chart-title {
        font-weight: bold;
        color: #00D4FF;
        text-align: center;
        margin-bottom: 10px;
        font-size: 0.95rem;
    }
    
    /* Simple pie charts with CSS - Updated colors */
    .pie-chart {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto;
        background: conic-gradient(
            #FF5349 0% 60%, 
            #2197b2 60% 90%, 
            #d8dee9 90% 100%
        );
        position: relative;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .acc-chart {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto;
        background: conic-gradient(
            #FEFE22 0% 40%, 
            #F96714 40% 75%, 
            #2197b2 75% 100%
        );
        position: relative;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .scheme-chart {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        margin: 0 auto;
        background: conic-gradient(
            #77DDE7 0% 45%, 
            #FF1DCE 45% 70%, 
            #B2EC5D 70% 90%, 
            #A2ADD0 90% 100%
        );
        position: relative;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    .donut-hole {
        position: absolute;
        width: 72px;
        height: 72px;
        background: white;
        border-radius: 50%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        box-shadow: inset 0 1px 4px rgba(0,0,0,0.1);
    }
    
    .chart-legend {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 4px;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        margin-right: 6px;
        margin-bottom: 6px;
        font-size: 10px;
        background-color: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
        transition: transform 0.15s;
    }
    
    .legend-item:hover {
        transform: scale(1.05);
    }
    
    .legend-color {
        width: 10px;
        height: 10px;
        margin-right: 4px;
        border-radius: 2px;
    }
    
    /* Export Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 50px auto;
        max-width: 900px;
        width: 90%;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
        max-height: 80vh;
        display: flex;
        flex-direction: column;
    }
    
    .modal-header {
        padding: 15px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .modal-body {
        padding: 15px;
        overflow-y: auto;
        max-height: calc(80vh - 130px);
    }
    
    .modal-footer {
        padding: 15px;
        border-top: 1px solid #e9ecef;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }
    
    .close-modal {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close-modal:hover {
        color: black;
    }
    
    /* Export Table Styles */
    .export-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 10px;
    }
    
    .export-table th {
        background: linear-gradient(135deg, #00FBFF 0%, #2E5D70 100%);
        color: white;
        text-align: left;
        padding: 8px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .export-table tr:nth-child(even) {
        background-color: #DEBFCF;
    }
    
    .export-table tr:hover {
        background-color: #ddd;
    }
    
    .export-table td {
        border: 1px solid #ddd;
        padding: 8px;
    }

    /* Amount input style */
    .amount-input {
        width: 100px;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 5px;
        text-align: right;
    }

    /* Total row style */
    .total-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }

    .total-row td {
        border-top: 2px solid #00FBFF;
    }
    
    /* Export Profile Styles */
    .profile-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        align-items: center;
    }
    
    .profile-input {
        flex: 1;
        min-width: 150px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .profile-select {
        flex: 1;
        min-width: 150px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        background-color: white;
    }
    
    .profile-btn {
        padding: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .profile-btn:hover {
        opacity: 0.9;
        transform: translateY(-1px);
    }
    
    .btn-save {
        background: linear-gradient(135deg, #00FBFF 0%, #2E5D70 100%);
        color: white;
    }
    
    .btn-load {
        background-color: #2197b2;
        color: white;
    }
    
    .btn-delete {
        background-color: #FF5349;
        color: white;
    }

    /* Search section style */
    .search-container {
        border-top: 1px solid #e9ecef;
        padding-top: 16px;
        margin-top: 16px;
    }

    /* Long press styles */
    .table-row-longpress {
        background-color: #eceff4 !important;
        cursor: pointer;
    }

    .longpress-active {
        background-color: #bbdefb !important;
    }

    /* Points column immediate click style */
    .points-column {
        cursor: pointer;
        background-color: rgba(0, 251, 255, 0.1);
        transition: background-color 0.2s;
    }

    .points-column:hover {
        background-color: rgba(0, 251, 255, 0.2);
    }

    /* Banking section enhancement */
    .banking-container {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .banking-select {
        flex: 1;
        min-width: 200px;
    }

    .adcb-checkbox-container {
        display: flex;
        align-items: center;
        gap: 5px;
        min-width: 120px;
    }
</style>
</head>

<body class="bg-gray-50 font-tahoma">

<div class="container mx-auto px-1 py-1 max-w-full">

    <!-- Section Navigation Buttons -->
    <div class="mb-2 flex justify-center gap-4 flex-wrap">
        <button id="showSummaryBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
            <i class="fas fa-chart-pie mr-2"></i> Summary
        </button>
        <button id="showEntryBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
            <i class="fas fa-file-alt mr-2"></i> Form
        </button>
        <button id="showViewBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
            <i class="fas fa-table mr-2"></i> View
        </button>
        <a href="https://docs.google.com/spreadsheets/d/1VfEPU_2EvNqB6g2ldAzD05fvwFigL1yN3L0wLOwZP4o/edit?gid=0#gid=0" target="_blank" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-6 rounded-md flex items-center">
            <i class="fas fa-file-excel mr-2"></i> Sheet
        </a>
    </div>
    
    <!-- Section Content Containers -->
    <!-- Summary Section -->
    <div id="summarySection" class="section active">
        <div class="bg-white p-3 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-bold" style="color: #00D4FF;">Summary Dashboard</h2>
                <button id="copySummaryBtn" class="bg-gray-600 text-white p-2 rounded-md hover:bg-gray-700 no-print">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
            
            <!-- Points Summary Card -->
            <div class="summary-card mb-2">
                <h3 class="mb-1">Points</h3>
                <div class="grid grid-cols-3 gap-2">
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Earned Points:</p>
                        <p class="text-lg font-bold text-green-600" id="summaryEarnedPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Pending Points:</p>
                        <p class="text-lg font-bold text-amber-600" id="summaryPendingPoints">0</p>
                    </div>
                    <div>
                        <p class="font-medium text-gray-600 text-sm">Total Points:</p>
                        <p class="text-lg font-bold text-blue-600" id="summaryTotalPoints">0</p>
                    </div>
                </div>
            </div>
            
            <!-- Progress Cards - 2-column layout -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <!-- In Progress Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">In Progress</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-purple-600" id="summaryInProgressPrivilege">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Completed Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Completed</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedCC">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPL">AED 0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">MDSA:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedMDSA">0</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Privilege:</p>
                            <p class="text-base font-bold text-green-600" id="summaryCompletedPrivilege">0</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Effort & Target Cards - 2-column layout -->
            <div class="grid grid-cols-2 gap-2 mb-2">
                <!-- Total Submissions Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Total Submissions</h3>
                    <div class="space-y-1">
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalCC">15</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalPL">AED 170,000</p>
                        </div>
                        <div class="flex justify-between items-center">
                            <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                            <p class="text-base font-bold text-blue-600" id="summaryTotalAccounts">0</p>
                        </div>
                    </div>
                </div>
                
                <!-- Target Card -->
                <div class="summary-card mb-0">
                    <h3 class="mb-1">Target</h3>
                    <div class="space-y-2">
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Credit Cards:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingCC" class="text-xs font-bold text-blue-600">12</span>
                                    <input type="number" id="targetCC" class="target-input text-xs py-0 px-1 w-16" value="20" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-blue-500" id="progressCC" style="width: 40%">40%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Personal Loans:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingPL" class="text-xs font-bold text-blue-600">500,000</span>
                                    <input type="number" id="targetPL" class="target-input text-xs py-0 px-1 w-16" value="500000" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-green-500" id="progressPL" style="width: 0%">0%</div>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center justify-between mb-0">
                                <p class="font-medium text-gray-600 text-sm">Accounts:</p>
                                <div class="flex items-center gap-1">
                                    <span id="remainingACC" class="text-xs font-bold text-blue-600">8</span>
                                    <input type="number" id="targetACC" class="target-input text-xs py-0 px-1 w-16" value="10" min="0">
                                </div>
                            </div>
                            <div class="progress-bar h-4 mt-1">
                                <div class="progress-fill bg-purple-500" id="progressACC" style="width: 20%">20%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Visualizations Section -->
            <div class="border rounded-lg mb-2">
                <div class="visualizations-header">
                    Visualizations
                </div>
                
                <div class="visualization-container p-2">
                    <!-- Proposition Distribution Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Proposition Distribution</div>
                        <div class="pie-chart">
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF5349;"></div>
                                <span>Conventional</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>Islamic</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #d8dee9;"></div>
                                <span>Both</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Account Types Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Account Types</div>
                        <div class="acc-chart">
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FEFE22;"></div>
                                <span>Aspire</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #F96714;"></div>
                                <span>Privilege</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2197b2;"></div>
                                <span>MDSA</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Scheme Distribution Chart -->
                    <div class="chart-box">
                        <div class="chart-title">Scheme Distribution (Completed)</div>
                        <div class="scheme-chart">
                            <div class="donut-hole"></div>
                        </div>
                        <div class="chart-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #77DDE7;"></div>
                                <span>TML ALL</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #FF1DCE;"></div>
                                <span>TML CC</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #B2EC5D;"></div>
                                <span>TM SELECT</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #A2ADD0;"></div>
                                <span>NTML</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="entrySection" class="section">
        <div class="bg-white p-4 rounded-lg shadow-md">
            <h2 class="text-xl font-bold text-primary mb-4">Customer Data Entry</h2>
            
            <form id="entryForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Left Column -->
                    <div class="space-y-4">
                        <!-- CID -->
                        <div>
                            <label for="cid" class="block text-gray-700 font-medium">CID (Optional)</label>
                            <input type="number" id="cid" name="cid" class="w-full border rounded-md p-2 text-base">
                        </div>
                        
                        <!-- App ID -->
                        <div>
                            <label for="appId" class="block text-gray-700 font-medium">App ID</label>
                            <input type="text" id="appId" name="appId" class="w-full border rounded-md p-2 text-base">
                        </div>
                        
                        <!-- Proposition -->
                        <div>
                            <label class="block text-gray-700 font-medium required">Proposition</label>
                            <div class="flex space-x-4 mt-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="proposition" value="Conventional" class="form-radio" checked>
                                    <span class="ml-2 text-gray-700">Conventional</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="proposition" value="Islamic" class="form-radio">
                                    <span class="ml-2 text-gray-700">Islamic</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="proposition" value="Both" class="form-radio">
                                    <span class="ml-2 text-gray-700">Both</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Date -->
                        <div>
                            <label for="date" class="block text-gray-700 font-medium required">Date</label>
                            <input type="date" id="date" name="date" class="w-full border rounded-md p-2 text-base" required>
                        </div>
                        
                        <!-- Salary -->
                        <div>
                            <label for="salary" class="block text-gray-700 font-medium required">Salary</label>
                            <input type="number" id="salary" name="salary" class="w-full border rounded-md p-2 text-base" required>
                        </div>
                        
                        <!-- Customer Name -->
                        <div>
                            <label for="customerName" class="block text-gray-700 font-medium required">Customer Name</label>
                            <input type="text" id="customerName" name="customerName" class="w-full border rounded-md p-2 text-base" required>
                            <p id="nameError" class="text-red-500 text-sm hidden">Customer name must be unique</p>
                        </div>
                        
                        <!-- Mobile -->
                        <div>
                            <label for="mobile" class="block text-gray-700 font-medium required">Mobile</label>
                            <input type="number" id="mobile" name="mobile" class="w-full border rounded-md p-2 text-base" required>
                            <p id="mobileError" class="text-red-500 text-sm hidden">Mobile number must be unique</p>
                        </div>
                        
                        <!-- Company Name (Moved here as requested in Fix 5) -->
                        <div>
                            <label for="companyName" class="block text-gray-700 font-medium">Company Name</label>
                            <input type="text" id="companyName" name="companyName" class="w-full border rounded-md p-2 text-base">
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="space-y-4">
                        <!-- Products -->
                        <div>
                            <label class="block text-gray-700 font-medium required">Products</label>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="ACC" class="form-checkbox" id="productACC">
                                    <span class="ml-2 text-gray-700">ACC</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="STL" class="form-checkbox" id="productSTL" disabled>
                                    <span class="ml-2 text-gray-700">STL</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="CC" class="form-checkbox" id="productCC">
                                    <span class="ml-2 text-gray-700">CC</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="2ndCC" class="form-checkbox" id="product2ndCC">
                                    <span class="ml-2 text-gray-700">2nd CC</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="BT/CCL" class="form-checkbox" id="productBTCCL">
                                    <span class="ml-2 text-gray-700">BT/CCL</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="PL" class="form-checkbox" id="productPL">
                                    <span class="ml-2 text-gray-700">PL</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="products" value="Other" class="form-checkbox" id="productOther">
                                    <span class="ml-2 text-gray-700">Other</span>
                                </label>
                            </div>
                            <p id="productsError" class="text-red-500 text-sm hidden">Please select at least one product</p>
                        </div>
                        
                        <!-- Product Options Container -->
                        <div id="productOptionsContainer" class="space-y-3">
                            <!-- Product-specific dropdown sections will be added here dynamically -->
                        </div>
                        
                        <!-- Loan Amount (Only shown for PL) -->
                        <div id="loanAmountSection" class="hidden">
                            <label for="loanAmount" class="block text-gray-700 font-medium">Loan Amount</label>
                            <input type="number" id="loanAmount" name="loanAmount" class="w-full border rounded-md p-2 text-base">
                        </div>
                        
                        <!-- Other Points (Only shown for Other product) -->
                        <div id="otherPointsSection" class="hidden">
                            <label for="otherPoints" class="block text-gray-700 font-medium">Other Points (Miscellaneous)</label>
                            <input type="number" id="otherPoints" name="otherPoints" class="w-full border rounded-md p-2 text-base" placeholder="Enter other points">
                        </div>
                        
                        <!-- Banking with ADCB checkbox -->
                        <div>
                            <label class="block text-gray-700 font-medium">Banking</label>
                            <div class="banking-container mt-2">
                                <select id="banking" name="banking" class="banking-select border rounded-md p-2 text-base">
                                    <option value="SELECT">SELECT</option>
                                    <option value="ADCB">ADCB</option>
                                    <option value="ENBD">ENBD</option>
                                    <option value="EIB">EIB</option>
                                    <option value="FAB">FAB</option>
                                    <option value="DIB">DIB</option>
                                    <option value="MASHREQ">MASHREQ</option>
                                    <option value="ADIB">ADIB</option>
                                    <option value="RAK">RAK</option>
                                    <option value="CBD">CBD</option>
                                    <option value="HSBC">HSBC</option>
                                    <option value="CITI">CITI</option>
                                    <option value="Other">Other</option>
                                </select>
                                <div class="adcb-checkbox-container">
                                    <input type="checkbox" id="adcbOverride" name="adcbOverride" class="form-checkbox">
                                    <label for="adcbOverride" class="text-gray-700 text-sm">ADCB</label>
                                </div>
                            </div>
                            <div id="otherBankingSection" class="mt-2 hidden">
                                <input type="text" id="otherBanking" name="otherBanking" placeholder="Specify bank" class="w-full border rounded-md p-2 text-base">
                            </div>
                        </div>
                        
                        <!-- Scheme -->
                        <div>
                            <label class="block text-gray-700 font-medium required">Scheme</label>
                            <div class="flex flex-wrap gap-4 mt-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="scheme" value="TML ALL" class="form-radio" checked>
                                    <span class="ml-2 text-gray-700">TML ALL</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="scheme" value="TML CC" class="form-radio">
                                    <span class="ml-2 text-gray-700">TML CC</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="scheme" value="TM SELECT" class="form-radio">
                                    <span class="ml-2 text-gray-700">TM SELECT</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="scheme" value="NTML" class="form-radio">
                                    <span class="ml-2 text-gray-700">NTML</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div>
                            <label for="status" class="block text-gray-700 font-medium required">Status</label>
                            <select id="status" name="status" class="w-full border rounded-md p-2 text-base" required>
                                <option value="">Select Status</option>
                                <option value="Draft">Draft</option>
                                <option value="Under Review">Under Review</option>
                                <option value="Completed">Completed</option>
                                <option value="HR CPV">HR CPV</option>
                                <option value="Compliance">Compliance</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Other">Other</option>
                            </select>
                            <div id="otherStatusSection" class="mt-2 hidden">
                                <input type="text" id="otherStatus" name="otherStatus" placeholder="Specify status" class="w-full border rounded-md p-2 text-base">
                            </div>
                        </div>
                        
                        <!-- Activation -->
                        <div>
                            <label class="block text-gray-700 font-medium required">Activation</label>
                            <div class="flex space-x-4 mt-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="activation" value="Non Activated" class="form-radio" checked>
                                    <span class="ml-2 text-gray-700">Non Activated</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="activation" value="Activated" class="form-radio">
                                    <span class="ml-2 text-gray-700">Activated</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Points (System Generated) -->
                        <div>
                            <label for="points" class="block text-gray-700 font-medium">Points (System Generated)</label>
                            <input type="text" id="points" name="points" class="w-full border rounded-md p-2 text-base bg-gray-100" readonly>
                        </div>
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex justify-center gap-4 mt-6">
                    <button type="submit" id="submitBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                        <i class="fas fa-save mr-2"></i> Save Data
                    </button>
                    <button type="button" id="updateBtn" class="custom-btn bg-blue-600 text-white py-2 px-6 rounded-md flex items-center hidden">
                        <i class="fas fa-edit mr-2"></i> Update Data
                    </button>
                    <button type="button" id="deleteBtn" class="bg-red-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-red-700 hidden">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Data
                    </button>
                    <button type="button" id="resetBtn" class="bg-gray-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-gray-700">
                        <i class="fas fa-redo-alt mr-2"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- View Data Section -->
    <div id="viewSection" class="section">
        <div class="bg-white p-4 rounded-lg shadow-md">
            <div class="flex flex-wrap justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-primary">View All Records</h2>
                <div class="flex flex-wrap gap-2 mt-2 sm:mt-0">
                    <button id="earnPointsBtn" class="points-btn earned">
                        <i class="fas fa-check-circle mr-2"></i> Earned ♔ <span id="earnedPointsTotal">0</span>
                    </button>
                    <button id="pendingPointsBtn" class="points-btn pending">
                        <i class="fas fa-hourglass-half mr-2"></i> Pending ✭ <span id="pendingPointsTotal">0</span>
                    </button>
                    <button id="exportDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-file-export mr-2"></i> Export
                    </button>
                    <button id="refreshDataBtn" class="custom-btn text-white py-2 px-4 rounded-md flex items-center">
                        <i class="fas fa-sync-alt mr-2"></i> Refresh Data
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>CID</th>
                            <th>App ID</th>
                            <th>Customer Name</th>
                            <th>Mobile</th>
                            <th>Products</th>
                            <th>Status</th>
                            <th>Points</th>
                            <th class="w-20">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
                <!-- Fix 3: Show All button -->
                <div id="showMoreContainer" class="mt-4 text-center hidden">
                    <button id="showAllRecordsBtn" class="custom-btn text-white py-2 px-6 rounded-md">
                        <i class="fas fa-list mr-2"></i> Show All Records
                    </button>
                </div>
            </div>
            
            <!-- Search Container (Moved from separate section) -->
            <div class="search-container">
                <h3 class="text-lg font-semibold text-primary mb-3">Find Records (Master Sheet)</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label for="searchCID" class="block text-gray-700 font-medium mb-2">Search by CID</label>
                        <input type="number" id="searchCID" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div>
                        <label for="searchName" class="block text-gray-700 font-medium mb-2">Search by Customer Name</label>
                        <input type="text" id="searchName" class="w-full border rounded-md p-2 text-base">
                    </div>
                    <div>
                        <label for="searchMobile" class="block text-gray-700 font-medium mb-2">Search by Mobile</label>
                        <input type="number" id="searchMobile" class="w-full border rounded-md p-2 text-base">
                    </div>
                </div>
                
                <div class="flex justify-center gap-2 mb-4">
                    <button id="searchBtn" class="custom-btn text-white py-2 px-6 rounded-md flex items-center">
                        <i class="fas fa-search mr-2"></i> Search Master
                    </button>
                    <button id="clearSearchBtn" class="bg-gray-600 text-white py-2 px-6 rounded-md flex items-center hover:bg-gray-700">
                        <i class="fas fa-times mr-2"></i> Clear
                    </button>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>CID</th>
                                <th>App ID</th>
                                <th>Customer Name</th>
                                <th>Mobile</th>
                                <th>Products</th>
                                <th>Status</th>
                                <th>Points</th>
                            </tr>
                        </thead>
                        <tbody id="searchResultsBody">
                            <!-- Search results will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Indicator -->
<div id="successIndicator" class="success-indicator hidden">
    <span id="successMessage">Operation successful!</span>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="loading-indicator hidden">
    <div class="spinner"></div>
</div>

<!-- Export Modal -->
<div id="exportModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="text-lg font-bold" style="color: #00D4FF;">Export Data</h2>
            <span class="close-modal" id="closeExportModal">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Referral Profile Section -->
            <div class="profile-container">
                <input type="text" id="profileName" class="profile-input" placeholder="Profile Name">
                <button id="saveProfileBtn" class="profile-btn btn-save">
                    <i class="fas fa-save mr-1"></i> Save
                </button>
                <select id="profileSelect" class="profile-select">
                    <option value="">Select a profile</option>
                </select>
                <button id="loadProfileBtn" class="profile-btn btn-load">
                    <i class="fas fa-folder-open mr-1"></i> Load
                </button>
                <button id="deleteProfileBtn" class="profile-btn btn-delete">
                    <i class="fas fa-trash-alt mr-1"></i> Delete
                </button>
            </div>
            
            <!-- Export Table -->
            <div class="mb-3">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center">
                        <input type="checkbox" id="selectAllRows" class="mr-2">
                        <label for="selectAllRows" class="text-gray-700 font-medium">Select All</label>
                    </div>
                    <div>
                        <span class="text-sm text-gray-600" id="selectedRowsCount">0 rows selected</span>
                    </div>
                </div>
                <div class="max-h-[400px] overflow-y-auto border border-gray-200 rounded">
                    <table class="export-table">
                        <thead>
                            <tr>
                                <th style="width: 40px;"><input type="checkbox" id="selectAllHeader"></th>
                                <th>CID</th>
                                <th>Date</th>
                                <th>Customer Name</th>
                                <th>Product</th>
                                <th>Status</th>
                                <th id="amountHeader">Amount</th>
                            </tr>
                        </thead>
                        <tbody id="exportTableBody">
                            <!-- Export data will be populated here -->
                        </tbody>
                        <tfoot>
                            <tr class="total-row">
                                <td colspan="6" class="text-right font-bold">Total:</td>
                                <td id="totalAmount" class="font-bold">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button id="cancelExportBtn" class="bg-gray-500 text-white py-2 px-4 rounded hover:bg-gray-600">
                Cancel
            </button>
            <button id="confirmExportBtn" class="custom-btn text-white py-2 px-4 rounded">
                <i class="fas fa-file-pdf mr-2"></i> Export PDF
            </button>
        </div>
    </div>
</div>

<script>
    // Initialize jsPDF
    window.jsPDF = window.jspdf.jsPDF;

    // Force create some test data to debug PDF generation
    const testData = [
        {
            CID: "12345",
            Date: "2023-05-22",
            "Customer Name": "John Doe",
            Product: "CC",
            Status: "Completed"
        },
        {
            CID: "67890",
            Date: "2023-05-23",
            "Customer Name": "Jane Smith",
            Product: "PL (AED 50,000)",
            Status: "Under Review"
        }
    ];

    // ==========================================
    // THEME AND UI FUNCTIONALITY
    // ==========================================

    // Section navigation
    const showEntryBtn = document.getElementById('showEntryBtn');
    const showViewBtn = document.getElementById('showViewBtn');
    const showSummaryBtn = document.getElementById('showSummaryBtn');
    
    const entrySection = document.getElementById('entrySection');
    const viewSection = document.getElementById('viewSection');
    const summarySection = document.getElementById('summarySection');
    
    // Fix 3: Track displayed records
    let allRecordsData = [];
    let isShowingAllRecords = false;
    const maxInitialRecords = 10;

    // Long press variables
    let longPressTimer = null;
    let isLongPressing = false;
    
    function showSection(section) {
        // Hide all sections
        entrySection.classList.remove('active');
        viewSection.classList.remove('active');
        summarySection.classList.remove('active');
        
        // Reset button styles
        showEntryBtn.classList.remove('custom-btn');
        showViewBtn.classList.remove('custom-btn');
        showSummaryBtn.classList.remove('custom-btn');
        
        showEntryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        showViewBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        showSummaryBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
        
        // Show selected section and highlight button
        if (section === 'entry') {
            entrySection.classList.add('active');
            showEntryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showEntryBtn.classList.add('custom-btn');
        } else if (section === 'view') {
            viewSection.classList.add('active');
            showViewBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showViewBtn.classList.add('custom-btn');
            fetchAllData();
        } else if (section === 'summary') {
            summarySection.classList.add('active');
            showSummaryBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            showSummaryBtn.classList.add('custom-btn');
            fetchAllDataForSummary();
        }
    }
    
    showEntryBtn.addEventListener('click', () => showSection('entry'));
    showViewBtn.addEventListener('click', () => showSection('view'));
    showSummaryBtn.addEventListener('click', () => showSection('summary'));

    // Show success indicator
    function showSuccess(message) {
        const indicator = document.getElementById('successIndicator');
        const messageEl = document.getElementById('successMessage');
        
        messageEl.textContent = message;
        indicator.classList.remove('hidden');
        
        setTimeout(() => {
            indicator.classList.add('hidden');
        }, 3000);
    }

    // Show loading indicator
    function showLoading() {
        document.getElementById('loadingIndicator').classList.remove('hidden');
    }

    // Hide loading indicator
    function hideLoading() {
        document.getElementById('loadingIndicator').classList.add('hidden');
    }

    // ==========================================
    // FORM HANDLING AND VALIDATION
    // ==========================================

    // Get all form elements
    const entryForm = document.getElementById('entryForm');
    const cidInput = document.getElementById('cid');
    const appIdInput = document.getElementById('appId');
    const dateInput = document.getElementById('date');
    const salaryInput = document.getElementById('salary');
    const customerNameInput = document.getElementById('customerName');
    const mobileInput = document.getElementById('mobile');
    const bankingSelect = document.getElementById('banking');
    const otherBankingSection = document.getElementById('otherBankingSection');
    const otherBankingInput = document.getElementById('otherBanking');
    const adcbOverrideCheckbox = document.getElementById('adcbOverride');
    const companyNameInput = document.getElementById('companyName');
    const statusSelect = document.getElementById('status');
    const otherStatusSection = document.getElementById('otherStatusSection');
    const otherStatusInput = document.getElementById('otherStatus');
    const pointsInput = document.getElementById('points');
    const productACC = document.getElementById('productACC');
    const productSTL = document.getElementById('productSTL');
    const productCC = document.getElementById('productCC');
    const product2ndCC = document.getElementById('product2ndCC');
    const productBTCCL = document.getElementById('productBTCCL');
    const productPL = document.getElementById('productPL');
    const productOther = document.getElementById('productOther');
    const loanAmountSection = document.getElementById('loanAmountSection');
    const loanAmountInput = document.getElementById('loanAmount');
    const otherPointsSection = document.getElementById('otherPointsSection');
    const otherPointsInput = document.getElementById('otherPoints');
    const productOptionsContainer = document.getElementById('productOptionsContainer');
    
    // Reset button
    document.getElementById('resetBtn').addEventListener('click', function() {
        resetForm();
    });

    // Form reset function
    function resetForm() {
        entryForm.reset();
        productOptionsContainer.innerHTML = '';
        loanAmountSection.classList.add('hidden');
        otherPointsSection.classList.add('hidden');
        otherBankingSection.classList.add('hidden');
        otherStatusSection.classList.add('hidden');
        
        // Reset validation error messages
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('mobileError').classList.add('hidden');
        document.getElementById('productsError').classList.add('hidden');

        // Hide update and delete buttons, show submit button
        document.getElementById('submitBtn').classList.remove('hidden');
        document.getElementById('updateBtn').classList.add('hidden');
        document.getElementById('deleteBtn').classList.add('hidden');

        // Clear points
        pointsInput.value = '';
        
        // Disable dependent checkboxes
        productSTL.disabled = true;
        product2ndCC.disabled = true;
        
        // Reset Other product checkbox
        productOther.checked = false;
        
        // Enable CID input for new records
        cidInput.disabled = false;
        cidInput.readOnly = false;
        
        // Clear any error styling
        document.querySelectorAll('.error-field').forEach(field => {
            field.classList.remove('error-field');
        });
        
        // Clear stored product selections
        currentSelections = {
            ACC: '',
            CC: '',
            CCOption2: '',
            PL: ''
        };
        
        // Clear editing data
        editingData = null;
        
        // Clear raw product string
        editingProductString = "";
        
        // Reset ADCB override checkbox
        adcbOverrideCheckbox.checked = false;
    }

    // Banking select change event
    bankingSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherBankingSection.classList.remove('hidden');
        } else {
            otherBankingSection.classList.add('hidden');
        }
        // Recalculate points when banking changes (for CC point reduction)
        calculateTotalPoints();
    });

    // ADCB override checkbox change event
    adcbOverrideCheckbox.addEventListener('change', function() {
        calculateTotalPoints();
    });

    // Status select change event
    statusSelect.addEventListener('change', function() {
        if (this.value === 'Other') {
            otherStatusSection.classList.remove('hidden');
        } else {
            otherStatusSection.classList.add('hidden');
        }
        
        // Fix 3: If status is "Rejected", set points to 0
        if (this.value === 'Rejected') {
            pointsInput.value = '0';
        } else {
            // Recalculate points if status is not "Rejected"
            calculateTotalPoints();
        }
    });

    // Product checkbox change events
    productACC.addEventListener('change', function() {
        // Enable/disable STL checkbox based on ACC checkbox
        productSTL.disabled = !this.checked;
        if (!this.checked) {
            productSTL.checked = false;
        }
        updateProductOptions();
    });

    productSTL.addEventListener('change', function() {
        calculateTotalPoints();
    });

    productPL.addEventListener('change', function() {
        if (this.checked) {
            loanAmountSection.classList.remove('hidden');
        } else {
            loanAmountSection.classList.add('hidden');
            loanAmountInput.value = '';
        }
        updateProductOptions();
    });

    productCC.addEventListener('change', function() {
        updateProductOptions();
        // Enable/disable 2nd CC checkbox based on CC checkbox
        product2ndCC.disabled = !this.checked;
        if (!this.checked) {
            product2ndCC.checked = false;
        }
    });

    product2ndCC.addEventListener('change', function() {
        updateProductOptions();
    });

    productBTCCL.addEventListener('change', function() {
        calculateTotalPoints();
    });

    productOther.addEventListener('change', function() {
        if (this.checked) {
            otherPointsSection.classList.remove('hidden');
        } else {
            otherPointsSection.classList.add('hidden');
            otherPointsInput.value = '';
        }
        calculateTotalPoints();
    });

    otherPointsInput.addEventListener('input', function() {
        calculateTotalPoints();
    });

    // Proposition radio button change event
    document.querySelectorAll('input[name="proposition"]').forEach(radio => {
        radio.addEventListener('change', function() {
            updateProductOptions();
        });
    });

    // Salary input change event
    salaryInput.addEventListener('input', function() {
        updateProductOptions();
    });

    // Set today's date as the default date
    document.addEventListener('DOMContentLoaded', function() {
        const today = new Date().toISOString().split('T')[0];
        dateInput.value = today;
        
        // Disable 2nd CC and STL initially
        product2ndCC.disabled = true;
        productSTL.disabled = true;
        
        // Initialize with Summary tab visible by default
        showSection('summary');
        
        // Initialize profile dropdown
        loadProfiles();

        // Create a sample record for testing
        allRecordsData = [
            {
                CID: "12345",
                "App ID": "",
                "Customer Name": "John Doe",
                Mobile: "5551234567",
                Product: "Touchpoints Gold Visa",
                Status: "Completed",
                Points: "250",
                Date: "2023-05-22",
                "Loan Amount": ""
            },
            {
                CID: "67890",
                "App ID": "A12345",
                "Customer Name": "Jane Smith",
                Mobile: "5559876543",
                Product: "Privilege 20K-30K, PL",
                Status: "Under Review",
                Points: "650",
                Date: "2023-05-23",
                "Loan Amount": "50000"
            }
        ];
        
        // Initialize real-time search by customer name - search Master sheet
        document.getElementById('searchName').addEventListener('input', async function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm.length < 2) {
                // Clear search results if input is too short
                document.getElementById('searchResultsBody').innerHTML = '';
                return;
            }
            
            // Search Master sheet for customer name
            try {
                const response = await fetch(`${scriptURL}?action=searchMaster&cid=&name=${encodeURIComponent(searchTerm)}&mobile=`);
                const data = await response.json();
                
                if (data.success) {
                    displayDataInTable(data.data, 'searchResultsBody', true);
                } else {
                    document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">Error searching Master sheet</td></tr>';
                }
            } catch (error) {
                console.error('Error searching Master sheet:', error);
                document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">Error connecting to Master sheet</td></tr>';
            }
        });

        // Add Enter key listeners for search inputs
        document.getElementById('searchCID').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        document.getElementById('searchName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });

        document.getElementById('searchMobile').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchData();
            }
        });
    });

    // ==========================================
    // PRODUCT OPTIONS AND POINTS CALCULATION
    // ==========================================

    // Store current selections for dropdowns
    let currentSelections = {
        ACC: '',
        CC: '',
        CCOption2: '',
        PL: ''
    };
    
    // Store raw editing data
    let editingData = null;
    let editingProductString = "";
    
    // Function to initialize product option dropdowns based on edit data
    function initializeProductOptions() {
        if (!editingData) return;
        
        console.log("Initializing product options for editing data:", editingData);
        
        // If we're editing a record with product data
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        // Check what products should be shown based on the product string
        if (productACC.checked) {
            console.log("ACC is checked, adding ACC options");
            const accOptions = getACCOptions(proposition, salary);
            
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                const accSelect = document.getElementById('ACCSelect');
                if (accSelect) {
                    console.log("Setting ACC select change event");
                    accSelect.addEventListener('change', function() {
                        // No STL disabling for Privilege options anymore (Fixed requirement 2B)
                        calculateTotalPoints();
                    });
                    
                    // Try to set the correct value
                    setAccDropdownValue(accSelect, editingData, salary);
                }
            }
        }
        
        // Create CC dropdown if needed
        if (productCC.checked) {
            console.log("CC is checked, adding CC options");
            const ccOptions = getCCOptions(proposition);
            
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                const ccSelect = document.getElementById('CCSelect');
                if (ccSelect) {
                    console.log("Setting CC select change event");
                    ccSelect.addEventListener('change', calculateTotalPoints);
                    
                    // Try to set the correct value
                    setCcDropdownValue(ccSelect, editingData);
                }
            }
            
            // Add 2nd CC options if checked
            if (product2ndCC.checked) {
                console.log("2nd CC is checked, adding 2nd CC options");
                const ccOptions = getCCOptions(proposition);
                
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select) {
                        console.log("Setting 2nd CC select change event");
                        cc2Select.addEventListener('change', calculateTotalPoints);
                        
                        // Try to set the correct value for 2nd CC
                        setCc2DropdownValue(cc2Select, editingData, editingProductString);
                    }
                }
            }
        }
        
        // Create PL dropdown if needed
        if (productPL.checked) {
            console.log("PL is checked, adding PL options");
            const plOptions = getPLOptions(proposition);
            
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                const plSelect = document.getElementById('PLSelect');
                if (plSelect) {
                    console.log("Setting PL select change event");
                    plSelect.addEventListener('change', calculateTotalPoints);
                    
                    // Try to set the correct value
                    setPlDropdownValue(plSelect, editingData);
                }
                
                // Add change event to loan amount input
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        // Calculate points
        calculateTotalPoints();
    }
    
    // Helper functions to set dropdown values correctly
    function setAccDropdownValue(accSelect, data, salary) {
        if (!accSelect) return;
        
        console.log("Trying to set ACC dropdown value");
        
        // First check if we have explicit accOption from the server
        if (data.accOption) {
            console.log("Using explicit accOption from server:", data.accOption);
            // Find the option that matches
            for (let i = 0; i < accSelect.options.length; i++) {
                if (accSelect.options[i].value === data.accOption) {
                    accSelect.selectedIndex = i;
                    console.log("Found matching ACC option at index", i);
                    return;
                }
            }
        }
        
        // If no explicit option or not found, try to match from product string
        if (editingProductString) {
            console.log("Checking product string for ACC option:", editingProductString);
            // Check for specific ACC product names
            if (editingProductString.includes("MDSA")) {
                selectOptionByText(accSelect, "MDSA");
            } else if (editingProductString.includes("Privilege 20K-40K")) {
                selectOptionByText(accSelect, "Privilege 20K-40K");
            } else if (editingProductString.includes("Privilege 40K")) {
                selectOptionByText(accSelect, "Privilege 40K");
            } else if (editingProductString.includes("Aspire 5K-10K")) {
                selectOptionByText(accSelect, "Aspire 5K-10K");
            } else if (editingProductString.includes("Aspire 10K-20K")) {
                selectOptionByText(accSelect, "Aspire 10K-20K");
            }
        }
        
        // If still no match, try to match based on salary
        if (accSelect.selectedIndex === 0) {
            console.log("No match found, trying to set based on salary:", salary);
            // Find the best option based on salary range
            for (let i = 1; i < accSelect.options.length; i++) {
                const option = accSelect.options[i];
                const minSalary = parseInt(option.dataset.minsalary) || 0;
                const maxSalary = parseInt(option.dataset.maxsalary) || Infinity;
                
                if (salary >= minSalary && salary <= maxSalary) {
                    accSelect.selectedIndex = i;
                    console.log("Found salary-matching ACC option at index", i);
                    break;
                }
            }
        }
    }
    
    function setCcDropdownValue(ccSelect, data) {
        if (!ccSelect) return;
        
        console.log("Trying to set CC dropdown value");
        
        // First check if we have explicit ccOption from the server
        if (data.ccOption) {
            console.log("Using explicit ccOption from server:", data.ccOption);
            // Find the option that matches
            for (let i = 0; i < ccSelect.options.length; i++) {
                if (ccSelect.options[i].value === data.ccOption) {
                    ccSelect.selectedIndex = i;
                    console.log("Found matching CC option at index", i);
                    return;
                }
            }
        }
        
        // If no explicit option or not found, try to match from product string
        if (editingProductString) {
            console.log("Checking product string for CC option:", editingProductString);
            
            // Extract CC product names from the string
            const products = editingProductString.split(',').map(p => p.trim());
            const ccProductsInSheet = products.filter(p => 
                p.includes("Touchpoints") || 
                p.includes("Cashback") ||
                p.includes("Talabat") ||
                p.includes("Visa") ||
                p.includes("MC")
            );
            
            // If we found CC products, use the first one
            if (ccProductsInSheet.length > 0) {
                console.log("Found CC product in sheet:", ccProductsInSheet[0]);
                selectOptionByText(ccSelect, ccProductsInSheet[0]);
            }
        }
    }
    
    function setCc2DropdownValue(cc2Select, data, productString) {
        if (!cc2Select) return;
        
        console.log("Trying to set 2nd CC dropdown value");
        
        // First check if we have explicit ccOption2 from the server
        if (data.ccOption2) {
            console.log("Using explicit ccOption2 from server:", data.ccOption2);
            // Find the option that matches
            for (let i = 0; i < cc2Select.options.length; i++) {
                if (cc2Select.options[i].value === data.ccOption2) {
                    cc2Select.selectedIndex = i;
                    console.log("Found matching 2nd CC option at index", i);
                    return;
                }
            }
        }
        
        // If no explicit option or not found, try to match from product string
        if (productString) {
            console.log("Checking product string for 2nd CC option:", productString);
            
            // Extract CC product names from the string
            const products = productString.split(',').map(p => p.trim());
            const ccProductsInSheet = products.filter(p => 
                p.includes("Touchpoints") || 
                p.includes("Cashback") ||
                p.includes("Talabat") ||
                p.includes("Visa") ||
                p.includes("MC")
            );
            
            // If we found more than one CC product, use the second one
            if (ccProductsInSheet.length > 1) {
                console.log("Found 2nd CC product in sheet:", ccProductsInSheet[1]);
                selectOptionByText(cc2Select, ccProductsInSheet[1]);
            }
        }
    }
    
    function setPlDropdownValue(plSelect, data) {
        if (!plSelect) return;
        
        console.log("Trying to set PL dropdown value");
        
        // First check if we have explicit plOption from the server
        if (data.plOption) {
            console.log("Using explicit plOption from server:", data.plOption);
            // Find the option that matches
            for (let i = 0; i < plSelect.options.length; i++) {
                if (plSelect.options[i].value === data.plOption) {
                    plSelect.selectedIndex = i;
                    console.log("Found matching PL option at index", i);
                    return;
                }
            }
        }
        
        // If no explicit option or not found, try to match from product string
        if (editingProductString) {
            console.log("Checking product string for PL option:", editingProductString);
            
            // Check for specific PL product names
            if (editingProductString.includes("Asipire Cat A & B")) {
                selectOptionByText(plSelect, "Asipire Cat A & B");
            } else if (editingProductString.includes("Privilege Cat A & B")) {
                selectOptionByText(plSelect, "Privilege Cat A & B");
            } else if (editingProductString.includes("Aspire Cat C & Below")) {
                selectOptionByText(plSelect, "Aspire Cat C & Below");
            } else if (editingProductString.includes("Privilege Cat C & Below")) {
                selectOptionByText(plSelect, "Privilege Cat C & Below");
            }
        }
    }
    
    // Helper function to select an option by its display text
    function selectOptionByText(selectElement, searchText) {
        if (!selectElement) return false;
        
        console.log(`Searching for option with text "${searchText}" in`, selectElement);
        
        for (let i = 0; i < selectElement.options.length; i++) {
            const optionText = selectElement.options[i].text;
            
            // Try exact match first
            if (optionText === searchText) {
                selectElement.selectedIndex = i;
                console.log(`Found exact match at index ${i}: ${optionText}`);
                return true;
            }
            
            // Then try contains match
            if (optionText.includes(searchText) || searchText.includes(optionText)) {
                selectElement.selectedIndex = i;
                console.log(`Found partial match at index ${i}: ${optionText}`);
                return true;
            }
            
            // Try without parentheses (e.g., "Aspire 5K-10K (Salary: 5000-9999)" -> "Aspire 5K-10K")
            const baseOptionText = optionText.split(' (')[0];
            if (baseOptionText === searchText || searchText.includes(baseOptionText) || baseOptionText.includes(searchText)) {
                selectElement.selectedIndex = i;
                console.log(`Found base text match at index ${i}: ${baseOptionText}`);
                return true;
            }
        }
        
        console.log(`No matching option found for "${searchText}"`);
        return false;
    }

    // Initialize product options when proposition or products change
    function updateProductOptions() {
        // Save current dropdown selections before updating
        const accSelect = document.getElementById('ACCSelect');
        const ccSelect = document.getElementById('CCSelect');
        const ccSelect2 = document.getElementById('CCSelect2');
        const plSelect = document.getElementById('PLSelect');
        
        if (accSelect) currentSelections.ACC = accSelect.value;
        if (ccSelect) currentSelections.CC = ccSelect.value;
        if (ccSelect2) currentSelections.CCOption2 = ccSelect2.value;
        if (plSelect) currentSelections.PL = plSelect.value;
        
        // Clear existing dropdowns
        productOptionsContainer.innerHTML = '';
        
        // Check if we're in edit mode with data
        if (editingData) {
            console.log("Updating product options with editing data");
            initializeProductOptions();
            return;
        }
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        const salary = parseFloat(salaryInput.value) || 0;
        
        // Process ACC product
        if (productACC.checked) {
            const accOptions = getACCOptions(proposition, salary);
            if (accOptions.length > 0) {
                const accDiv = createProductOptionDiv('ACC', accOptions);
                productOptionsContainer.appendChild(accDiv);
                
                // Add change event to ACC select
                const newAccSelect = accDiv.querySelector('select');
                newAccSelect.addEventListener('change', function() {
                    // Fixed: Remove STL disabling logic for Privilege options
                    calculateTotalPoints();
                });
                
                // Restore previous selection if it exists
                if (currentSelections.ACC && newAccSelect.querySelector(`option[value="${currentSelections.ACC}"]`)) {
                    newAccSelect.value = currentSelections.ACC;
                }
            }
        }
        
        // Process CC product
        if (productCC.checked) {
            const ccOptions = getCCOptions(proposition);
            if (ccOptions.length > 0) {
                const ccDiv = createProductOptionDiv('CC', ccOptions);
                productOptionsContainer.appendChild(ccDiv);
                
                // Add change event to CC select
                const newCcSelect = ccDiv.querySelector('select');
                newCcSelect.addEventListener('change', calculateTotalPoints);
                
                // Restore previous selection if it exists
                if (currentSelections.CC && newCcSelect.querySelector(`option[value="${currentSelections.CC}"]`)) {
                    newCcSelect.value = currentSelections.CC;
                }
            }
            
            // Process 2nd CC product (only when CC is checked and 2ndCC is checked)
            if (product2ndCC.checked) {
                const ccOptions = getCCOptions(proposition);
                if (ccOptions.length > 0) {
                    const cc2Div = createProductOptionDiv('CC2', ccOptions, '2nd CC');
                    productOptionsContainer.appendChild(cc2Div);
                    
                    // Add change event to 2nd CC select
                    const newCc2Select = cc2Div.querySelector('select');
                    newCc2Select.addEventListener('change', calculateTotalPoints);
                    
                    // Restore previous selection if it exists
                    if (currentSelections.CCOption2 && newCc2Select.querySelector(`option[value="${currentSelections.CCOption2}"]`)) {
                        newCc2Select.value = currentSelections.CCOption2;
                    }
                }
            }
        }
        
        // Process PL product
        if (productPL.checked) {
            const plOptions = getPLOptions(proposition);
            if (plOptions.length > 0) {
                const plDiv = createProductOptionDiv('PL', plOptions);
                productOptionsContainer.appendChild(plDiv);
                
                // Add change event to PL select
                const newPlSelect = plDiv.querySelector('select');
                newPlSelect.addEventListener('change', calculateTotalPoints);
                
                // Restore previous selection if it exists
                if (currentSelections.PL && newPlSelect.querySelector(`option[value="${currentSelections.PL}"]`)) {
                    newPlSelect.value = currentSelections.PL;
                }
                
                // Add change event to Loan Amount input
                loanAmountInput.addEventListener('input', calculateTotalPoints);
            }
        }
        
        // Calculate total points
        calculateTotalPoints();
    }

    // Create a product option div with dropdown
    function createProductOptionDiv(productType, options, customLabel) {
        const div = document.createElement('div');
        const label = customLabel || productType + ' Option';
        const id = productType === 'CC2' ? 'CCSelect2' : `${productType}Select`;
        
        let optionsHtml = '<option value="">Select ' + label + '</option>';
        
        options.forEach(option => {
            const extraAttributes = [];
            
            if (option.points) {
                extraAttributes.push(`data-points="${option.points}"`);
            }
            
            if (option.paid !== undefined) {
                extraAttributes.push(`data-paid="${option.paid}"`);
            }
            
            if (option.disableSTL !== undefined) {
                extraAttributes.push(`data-disablestl="${option.disableSTL}"`);
            }
            
            if (option.minSalary !== undefined) {
                extraAttributes.push(`data-minsalary="${option.minSalary}"`);
            }
            
            if (option.maxSalary !== undefined) {
                extraAttributes.push(`data-maxsalary="${option.maxSalary}"`);
            }
            
            optionsHtml += `<option value="${option.value}" ${extraAttributes.join(' ')}>${option.text}</option>`;
        });
        
        div.innerHTML = `
            <label for="${id}" class="block text-gray-700 font-medium">${label}</label>
            <select id="${id}" class="w-full border rounded-md p-2 text-base" data-product="${productType}">
                ${optionsHtml}
            </select>
        `;
        return div;
    }

    // Get ACC options based on proposition and salary
    function getACCOptions(proposition, salary) {
        const options = [];
        
        // Add all options regardless of salary, but annotate with requirements
        options.push({ value: "Aspire5K-10K", text: "Aspire 5K-10K (Salary: 5000-9999)", points: 150, minSalary: 5000, maxSalary: 9999, disableSTL: false });
        options.push({ value: "Aspire10K-20K", text: "Aspire 10K-20K (Salary: 10000-19999)", points: 400, minSalary: 10000, maxSalary: 19999, disableSTL: false });
        // Fixed: Remove STL disabling for Privilege options (requirement 2B)
        options.push({ value: "Privilege20K-40K", text: "Privilege 20K-40K (Salary: 20000-39999)", points: 550, minSalary: 20000, maxSalary: 39999, disableSTL: false });
        options.push({ value: "Privilege40K+", text: "Privilege 40K & Above (Salary: 40000+)", points: 800, minSalary: 40000, maxSalary: Infinity, disableSTL: false });
        
        // Add Islamic-specific option
        if (proposition === "Islamic" || proposition === "Both") {
            options.push({ 
                value: "MDSA", 
                text: "MDSA", 
                points: 175,
                minSalary: 5000,
                maxSalary: Infinity,
                disableSTL: false
            });
        }
        
        return options;
    }

    // Get CC options based on proposition
    function getCCOptions(proposition) {
        if (proposition === "Conventional") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TouchpointsTitaniumMC", text: "Touchpoints Titanium MC", points: 200, paid: false },
                { value: "EssientialCashbackMC", text: "Essiential Cashback MC", points: 200, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "LuluTitaniumMC", text: "Lulu Titanium MC", points: 200, paid: false },
                { value: "LuluPlatinumMC", text: "Lulu Platinum MC", points: 200, paid: false },
                { value: "TouchpointsPlatinumMC", text: "Touchpoints Platinum MC", points: 400, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "AllSignatureVisa", text: "All Signature Visa", points: 500, paid: true },
                { value: "AllInfiniteVisa", text: "All Infinite Visa", points: 750, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 750, paid: true },
                { value: "TravellerMCWorldElite", text: "Traveller MC World Elite", points: 750, paid: true },
                { value: "BetaqtiMCWorldElite", text: "Betaqti MC World Elite", points: 1000, paid: true }
            ];
        } else if (proposition === "Islamic") {
            return [
                { value: "TouchpointsGoldVisa", text: "Touchpoints Gold Visa", points: 300, paid: false },
                { value: "TalabatMC", text: "Talabat MC", points: 150, paid: false },
                { value: "TouchpointsPlatinumVisa", text: "Touchpoints Platinum Visa", points: 500, paid: true },
                { value: "365CashbackVisa", text: "365 Cashback Visa", points: 500, paid: true },
                { value: "ShukranPlatinumVisa", text: "Shukran Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestPlatinumVisa", text: "Etihad Guest Platinum Visa", points: 500, paid: true },
                { value: "EtihadGuestSignatureVisa", text: "Etihad Guest Signature Visa", points: 500, paid: true },
                { value: "TouchpointsInfiniteVisa", text: "Touchpoints Infinite Visa", points: 750, paid: true },
                { value: "EtihadGuestInfiniteVisa", text: "Etihad Guest Infinite Visa", points: 750, paid: true },
                { value: "EmiratiIslamicInfiniteVisa", text: "Emirati Islamic Infinite Visa", points: 750, paid: true }
            ];
        } else if (proposition === "Both") {
            // Combine both lists and remove duplicates
            const conventional = getCCOptions("Conventional");
            const islamic = getCCOptions("Islamic");
            const combinedOptions = [...conventional];
            
            // Add Islamic options that don't exist in conventional
            islamic.forEach(islamicOption => {
                if (!conventional.some(convOption => convOption.value === islamicOption.value)) {
                    combinedOptions.push(islamicOption);
                }
            });
            
            return combinedOptions;
        }
        
        return [];
    }

    // Get PL options based on proposition
    function getPLOptions(proposition) {
        // Same options for all propositions
        return [
            { value: "AspireCatAB", text: "Asipire Cat A & B", points: "0.50%" },
            { value: "PrivilegeCatAB", text: "Privilege Cat A & B", points: "0.50%" },
            { value: "AspireCatCBelow", text: "Aspire Cat C & Below", points: "0.25%" },
            { value: "PrivilegeCatCBelow", text: "Privilege Cat C & Below", points: "0.25%" }
        ];
    }

    // Calculate total points based on selected options
    function calculateTotalPoints() {
        // Fix 3: If status is "Rejected", set points to 0 and return
        if (statusSelect.value === 'Rejected') {
            pointsInput.value = '0';
            return;
        }
        
        let totalPoints = 0;
        
        // Calculate points for ACC
        if (productACC.checked) {
            const accSelect = document.getElementById('ACCSelect');
            if (accSelect && accSelect.value) {
                const selectedOption = accSelect.options[accSelect.selectedIndex];
                const accPoints = parseInt(selectedOption.dataset.points) || 0;
                
                // Only add ACC points if STL is checked and not disabled
                if (productSTL.checked && !productSTL.disabled) {
                    totalPoints += accPoints;
                }
                
                // No extra points for STL itself - STL checkbox only enables points calculation
            }
        }
        
        // Calculate points for CC
        if (productCC.checked) {
            const ccSelect = document.getElementById('CCSelect');
            if (ccSelect && ccSelect.value) {
                const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                let ccPoints = parseInt(selectedOption.dataset.points) || 0;
                
                // Fixed: Check for ADCB override checkbox first (requirement 2A)
                if (!adcbOverrideCheckbox.checked && bankingSelect.value !== 'ADCB') {
                    ccPoints = Math.round(ccPoints * 0.7); // 30% reduction
                }
                
                totalPoints += ccPoints;
                
                // Check for 2nd CC
                if (product2ndCC.checked) {
                    const cc2Select = document.getElementById('CCSelect2');
                    if (cc2Select && cc2Select.value) {
                        const selectedOption2 = cc2Select.options[cc2Select.selectedIndex];
                        const isPaid = selectedOption2.dataset.paid === "true";
                        
                        // Change 2: Set 2nd CC free cards to 80 points (paid remains the same at 250)
                        totalPoints += isPaid ? 250 : 80;
                    }
                }
            }
        }
        
        // Add points for BT/CCL
        if (productBTCCL.checked) {
            totalPoints += 100;
        }
        
        // Add other points (miscellaneous)
        if (productOther.checked) {
            const otherPointsValue = parseFloat(otherPointsInput.value) || 0;
            totalPoints += otherPointsValue;
        }
        
        // Calculate points for PL
        if (productPL.checked) {
            const plSelect = document.getElementById('PLSelect');
            const loanAmount = parseFloat(loanAmountInput.value) || 0;
            
            if (plSelect && plSelect.value && loanAmount > 0) {
                const selectedOption = plSelect.options[plSelect.selectedIndex];
                const pointsPercentage = selectedOption.dataset.points;
                
                if (pointsPercentage === "0.50%") {
                    totalPoints += loanAmount * 0.005;
                } else if (pointsPercentage === "0.25%") {
                    totalPoints += loanAmount * 0.0025;
                }
            }
        }
        
        // Update points input
        pointsInput.value = totalPoints.toFixed(2);
    }

    // ==========================================
    // GOOGLE SHEETS INTEGRATION
    // ==========================================

    // Google Apps Script Web App URL
    const scriptURL = 'https://script.google.com/macros/s/AKfycbwngb8Ka97Re88mDNaT60W-b_Ts4VQTf0DKSrJVUXra1Za8OtdNbG4gmrWIwfSSXaz9Rg/exec';

    // Fetch all data from Google Sheets
    async function fetchAllData() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                // Store all data for "Show All" functionality
                allRecordsData = data.data;
                
                // If no data from server, use test data
                if (!allRecordsData || allRecordsData.length === 0) {
                    console.log("No data returned from server, using test data");
                    allRecordsData = [
                        {
                            CID: "12345",
                            "App ID": "",
                            "Customer Name": "John Doe",
                            Mobile: "5551234567",
                            Product: "Touchpoints Gold Visa",
                            Status: "Completed",
                            Points: "250",
                            Date: "2023-05-22",
                            "Loan Amount": ""
                        },
                        {
                            CID: "67890",
                            "App ID": "A12345",
                            "Customer Name": "Jane Smith",
                            Mobile: "5559876543",
                            Product: "Privilege 20K-30K, PL",
                            Status: "Under Review",
                            Points: "650",
                            Date: "2023-05-23",
                            "Loan Amount": "50000"
                        }
                    ];
                }
                
                // Fix 3: Display only last 10 records initially
                isShowingAllRecords = false;
                const displayData = allRecordsData.slice(-maxInitialRecords); // Get last 10 records
                displayDataInTable(displayData, 'dataTableBody');
                calculatePointsTotals(allRecordsData);
                
                // Show or hide the "Show All" button based on data length
                const showMoreContainer = document.getElementById('showMoreContainer');
                if (allRecordsData.length > maxInitialRecords) {
                    showMoreContainer.classList.remove('hidden');
                } else {
                    showMoreContainer.classList.add('hidden');
                }
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error fetching data:', error);
            showSuccess('Error fetching data from server. Using test data instead.');
            
            // Use test data if there's an error
            allRecordsData = [
                {
                    CID: "12345",
                    "App ID": "",
                    "Customer Name": "John Doe",
                    Mobile: "5551234567",
                    Product: "Touchpoints Gold Visa",
                    Status: "Completed",
                    Points: "250",
                    Date: "2023-05-22",
                    "Loan Amount": ""
                },
                {
                    CID: "67890",
                    "App ID": "A12345",
                    "Customer Name": "Jane Smith",
                    Mobile: "5559876543",
                    Product: "Privilege 20K-30K, PL",
                    Status: "Under Review",
                    Points: "650",
                    Date: "2023-05-23",
                    "Loan Amount": "50000"
                }
            ];
            
            displayDataInTable(allRecordsData, 'dataTableBody');
            calculatePointsTotals(allRecordsData);
            
            // No "Show All" button needed for test data
            document.getElementById('showMoreContainer').classList.add('hidden');
        } finally {
            hideLoading();
        }
    }

    // Fix 3: Show All Records button event handler
    document.getElementById('showAllRecordsBtn').addEventListener('click', function() {
        if (!isShowingAllRecords && allRecordsData.length > 0) {
            displayDataInTable(allRecordsData, 'dataTableBody');
            isShowingAllRecords = true;
            this.innerHTML = '<i class="fas fa-list-alt mr-2"></i> Show Last 10 Records';
        } else {
            const displayData = allRecordsData.slice(-maxInitialRecords);
            displayDataInTable(displayData, 'dataTableBody');
            isShowingAllRecords = false;
            this.innerHTML = '<i class="fas fa-list mr-2"></i> Show All Records';
        }
    });

    // Calculate and display point totals
    function calculatePointsTotals(data) {
        let earnedPoints = 0;
        let pendingPoints = 0;
        
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            // Fix 3: Only count points if status is not Rejected
            if (record.Status === 'Completed') {
                earnedPoints += points;
            } else if (record.Status !== 'Rejected') {
                pendingPoints += points;
            }
        });
        
        document.getElementById('earnedPointsTotal').textContent = Math.round(earnedPoints);
        document.getElementById('pendingPointsTotal').textContent = Math.round(pendingPoints);
    }

    // Fetch all data for the summary page
    async function fetchAllDataForSummary() {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=getAll`);
            const data = await response.json();
            
            if (data.success) {
                populateSummaryData(data.data);
            } else {
                showSuccess(`Error: ${data.error}`);
                // Use test data for the summary
                populateSummaryData([
                    {
                        CID: "12345",
                        "App ID": "",
                        "Customer Name": "John Doe",
                        Mobile: "5551234567",
                        Product: "Touchpoints Gold Visa",
                        Status: "Completed",
                        Points: "250",
                        Date: "2023-05-22",
                        "Loan Amount": "",
                        Proposition: "Conventional",
                        Scheme: "TML ALL"
                    },
                    {
                        CID: "67890",
                        "App ID": "A12345",
                        "Customer Name": "Jane Smith",
                        Mobile: "5559876543",
                        Product: "Privilege 20K-30K, PL",
                        Status: "Under Review",
                        Points: "650",
                        Date: "2023-05-23",
                        "Loan Amount": "50000",
                        Proposition: "Both",
                        Scheme: "TML CC"
                    }
                ]);
            }
        } catch (error) {
            console.error('Error fetching data for summary:', error);
            showSuccess('Error fetching data from server. Using test data for summary.');
            
            // Use test data for the summary
            populateSummaryData([
                {
                    CID: "12345",
                    "App ID": "",
                    "Customer Name": "John Doe",
                    Mobile: "5551234567",
                    Product: "Touchpoints Gold Visa",
                    Status: "Completed",
                    Points: "250",
                    Date: "2023-05-22",
                    "Loan Amount": "",
                    Proposition: "Conventional",
                    Scheme: "TML ALL"
                },
                {
                    CID: "67890",
                    "App ID": "A12345",
                    "Customer Name": "Jane Smith",
                    Mobile: "5559876543",
                    Product: "Privilege 20K-30K, PL",
                    Status: "Under Review",
                    Points: "650",
                    Date: "2023-05-23",
                    "Loan Amount": "50000",
                    Proposition: "Both",
                    Scheme: "TML CC"
                }
            ]);
        } finally {
            hideLoading();
        }
    }

    // Populate the summary data
    function populateSummaryData(data) {
        if (!data || data.length === 0) {
            // Use default values if no data
            document.getElementById('summaryEarnedPoints').textContent = "0";
            document.getElementById('summaryPendingPoints').textContent = "0";
            document.getElementById('summaryTotalPoints').textContent = "0";
            
            document.getElementById('summaryInProgressCC').textContent = "0";
            document.getElementById('summaryInProgressPL').textContent = "AED 0";
            document.getElementById('summaryInProgressMDSA').textContent = "0";
            document.getElementById('summaryInProgressPrivilege').textContent = "0";
            
            document.getElementById('summaryCompletedCC').textContent = "0";
            document.getElementById('summaryCompletedPL').textContent = "AED 0";
            document.getElementById('summaryCompletedMDSA').textContent = "0";
            document.getElementById('summaryCompletedPrivilege').textContent = "0";
            
            document.getElementById('summaryTotalCC').textContent = "0";
            document.getElementById('summaryTotalPL').textContent = "AED 0";
            document.getElementById('summaryTotalAccounts').textContent = "0";
            return;
        }
        
        // Initialize counters
        let earnedPoints = 0;
        let pendingPoints = 0;
        
        let inProgressCC = 0;
        let completedCC = 0;
        
        let inProgressLoanAmount = 0;
        let completedLoanAmount = 0;
        
        let inProgressMDSA = 0;
        let completedMDSA = 0;
        
        let inProgressPrivilege = 0;
        let completedPrivilege = 0;
        
        let conventionalCount = 0;
        let islamicCount = 0;
        let bothCount = 0;
        
        let aspireCount = 0;
        let privilegeCount = 0;
        let mdsaCount = 0;
        
        let tmlAllCount = 0;
        let tmlCCCount = 0;
        let tmSelectCount = 0;
        let ntmlCount = 0;
        
        // Process each record directly from the Google Sheet data
        data.forEach(record => {
            const points = parseFloat(record.Points) || 0;
            const isCompleted = record.Status === 'Completed';
            const isRejected = record.Status === 'Rejected';
            const productString = record.Product || '';
            const proposition = record.Proposition || '';
            const scheme = record.Scheme || '';
            const loanAmount = parseFloat(record['Loan Amount']) || 0;
            
            // Fix 3: Calculate Earned/Pending Points based on Status
            if (isCompleted) {
                earnedPoints += points;
            } else if (!isRejected) { // Skip rejected records
                pendingPoints += points;
            }
            
            // Improved logic for counting credit cards
            let ccCount = 0;
            
            // Get all possible credit card names from our dropdown options
            const ccOptions = getCCOptions('Both'); // Get all CC options (both conventional and Islamic)
            const allCCNames = ccOptions.map(option => option.text);
            
            // Function to check if a product is a credit card
            const isCreditCard = (product) => {
                return allCCNames.some(ccName => 
                    product.includes(ccName) || 
                    (product.includes('Visa') && !product.includes('BT/CCL')) ||
                    (product.includes('MC') && !product.includes('BT/CCL')) ||
                    (product === 'CC') || 
                    (product === '2ndCC')
                );
            };
            
            // Split the product string by commas and count credit cards
            if (productString) {
                const products = productString.split(',').map(p => p.trim());
                
                // Count each product that matches a credit card
                products.forEach(product => {
                    if (isCreditCard(product)) {
                        ccCount++;
                    }
                });
            }

            // Check for MDSA and Privilege accounts
            const hasMDSA = productString.includes('MDSA');
            const hasPrivilege = productString.includes('Privilege');

            // Categorize based on status
            if (isCompleted) {
                // Completed stats
                completedCC += ccCount;
                if (loanAmount > 0) {
                    completedLoanAmount += loanAmount;
                }
                if (hasMDSA) completedMDSA++;
                if (hasPrivilege) completedPrivilege++;
            } else if (!isRejected) { // Fix 3: Skip rejected records in the In Progress count
                // In Progress stats
                inProgressCC += ccCount;
                if (loanAmount > 0) {
                    inProgressLoanAmount += loanAmount;
                }
                if (hasMDSA) inProgressMDSA++;
                if (hasPrivilege) inProgressPrivilege++;
            }
            
            // Fix 3: Don't skip rejected records for overall proposition and account stats
            
            // Proposition Distribution
            if (proposition === 'Conventional') {
                conventionalCount++;
            } else if (proposition === 'Islamic') {
                islamicCount++;
            } else if (proposition === 'Both') {
                bothCount++;
            }
            
            // Account Types
            if (productString.includes('Aspire')) {
                aspireCount++;
            } else if (productString.includes('Privilege')) {
                privilegeCount++;
            } else if (productString.includes('MDSA')) {
                mdsaCount++;
            }
            
            // Scheme Distribution (only count completed records)
            if (isCompleted) {
                if (scheme === 'TML ALL') {
                    tmlAllCount++;
                } else if (scheme === 'TML CC') {
                    tmlCCCount++;
                } else if (scheme === 'TM SELECT') {
                    tmSelectCount++;
                } else if (scheme === 'NTML') {
                    ntmlCount++;
                }
            }
        });
        
        // Calculate total points (earnedPoints + pendingPoints)
        const totalPoints = earnedPoints + pendingPoints;
        
        // Calculate total credit cards and loan amounts (Fix 4: Total Submissions)
        const totalCC = inProgressCC + completedCC;
        const totalLoanAmount = inProgressLoanAmount + completedLoanAmount;
        const totalAccounts = aspireCount + privilegeCount + mdsaCount;
        
        // Format loan amounts
        function formatCurrency(amount) {
            return 'AED ' + amount.toLocaleString('en-US');
        }
        
        // Update summary data in the DOM
        document.getElementById('summaryEarnedPoints').textContent = Math.round(earnedPoints);
        document.getElementById('summaryPendingPoints').textContent = Math.round(pendingPoints);
        document.getElementById('summaryTotalPoints').textContent = Math.round(totalPoints);
        
        document.getElementById('summaryInProgressCC').textContent = inProgressCC;
        document.getElementById('summaryInProgressPL').textContent = formatCurrency(inProgressLoanAmount);
        document.getElementById('summaryInProgressMDSA').textContent = inProgressMDSA;
        document.getElementById('summaryInProgressPrivilege').textContent = inProgressPrivilege;
        
        document.getElementById('summaryCompletedCC').textContent = completedCC;
        document.getElementById('summaryCompletedPL').textContent = formatCurrency(completedLoanAmount);
        document.getElementById('summaryCompletedMDSA').textContent = completedMDSA;
        document.getElementById('summaryCompletedPrivilege').textContent = completedPrivilege;
        
        document.getElementById('summaryTotalCC').textContent = totalCC > 0 ? totalCC : "0";
        document.getElementById('summaryTotalPL').textContent = formatCurrency(totalLoanAmount > 0 ? totalLoanAmount : 0);
        document.getElementById('summaryTotalAccounts').textContent = totalAccounts > 0 ? totalAccounts : "0";
        
        // Update target progress bars
        updateTargetProgress('CC', completedCC);
        updateTargetProgress('PL', completedLoanAmount);
        updateTargetProgress('ACC', totalAccounts);
        
        // Update visualizations
        updateVisualizations(conventionalCount, islamicCount, bothCount, aspireCount, privilegeCount, mdsaCount, tmlAllCount, tmlCCCount, tmSelectCount, ntmlCount);
    }

    // Function to update the visualizations with actual data
    function updateVisualizations(conventional, islamic, both, aspire, privilege, mdsa, tmlAll, tmlCC, tmSelect, ntml) {
        // Calculate total counts and percentages
        const totalProposition = conventional + islamic + both || 1; // Avoid division by zero
        const totalAccounts = aspire + privilege + mdsa || 1;
        const totalSchemes = tmlAll + tmlCC + tmSelect + ntml || 1;
        
        // Calculate percentages
        const conventionalPercent = Math.round((conventional / totalProposition) * 100);
        const islamicPercent = Math.round((islamic / totalProposition) * 100);
        const bothPercent = 100 - conventionalPercent - islamicPercent;
        
        const aspirePercent = Math.round((aspire / totalAccounts) * 100);
        const privilegePercent = Math.round((privilege / totalAccounts) * 100);
        const mdsaPercent = 100 - aspirePercent - privilegePercent;
        
        const tmlAllPercent = Math.round((tmlAll / totalSchemes) * 100);
        const tmlCCPercent = Math.round((tmlCC / totalSchemes) * 100);
        const tmSelectPercent = Math.round((tmSelect / totalSchemes) * 100);
        const ntmlPercent = 100 - tmlAllPercent - tmlCCPercent - tmSelectPercent;
        
        // Update pie chart CSS with actual percentages
        document.querySelector('.pie-chart').style.background = `conic-gradient(
            #FF5349 0% ${conventionalPercent}%, 
            #2197b2 ${conventionalPercent}% ${conventionalPercent + islamicPercent}%, 
            #d8dee9 ${conventionalPercent + islamicPercent}% 100%
        )`;
        
        document.querySelector('.acc-chart').style.background = `conic-gradient(
            #FEFE22 0% ${aspirePercent}%, 
            #F96714 ${aspirePercent}% ${aspirePercent + privilegePercent}%, 
            #2197b2 ${aspirePercent + privilegePercent}% 100%
        )`;
        
        document.querySelector('.scheme-chart').style.background = `conic-gradient(
            #77DDE7 0% ${tmlAllPercent}%, 
            #FF1DCE ${tmlAllPercent}% ${tmlAllPercent + tmlCCPercent}%, 
            #B2EC5D ${tmlAllPercent + tmlCCPercent}% ${tmlAllPercent + tmlCCPercent + tmSelectPercent}%, 
            #A2ADD0 ${tmlAllPercent + tmlCCPercent + tmSelectPercent}% 100%
        )`;
    }
    
    // Update progress bars
    function updateTargetProgress(type, completed) {
        const targetInput = document.getElementById(`target${type}`);
        const remainingEl = document.getElementById(`remaining${type}`);
        const progressEl = document.getElementById(`progress${type}`);
        
        const target = parseInt(targetInput.value) || 0;
        const remaining = Math.max(0, target - completed);
        const percentage = target > 0 ? Math.min(100, Math.round((completed / target) * 100)) : 0;
        
        remainingEl.textContent = type === 'PL' ? remaining.toLocaleString('en-US') : remaining;
        progressEl.style.width = `${percentage}%`;
        progressEl.textContent = `${percentage}%`;
        
        targetInput.addEventListener('change', function() {
            updateTargetProgress(type, completed);
        });
    }
    
    // Copy summary to clipboard
    document.getElementById('copySummaryBtn').addEventListener('click', async function() {
        const summaryText = generateSummaryText();
        try {
            const result = await copyToClipboard(summaryText);
            if (result) {
                showSuccess('Summary copied to clipboard successfully!');
            } else {
                showSuccess('Failed to copy summary. Please try again.');
            }
        } catch (error) {
            showSuccess('Failed to copy summary. Please try again.');
        }
    });
    
    // Generate summary text with the new required format (requirement 1)
    function generateSummaryText() {
        const inProgressCC = document.getElementById('summaryInProgressCC').textContent;
        const inProgressPL = document.getElementById('summaryInProgressPL').textContent;
        const inProgressMDSA = document.getElementById('summaryInProgressMDSA').textContent;
        const inProgressPrivilege = document.getElementById('summaryInProgressPrivilege').textContent;
        
        const completedCC = document.getElementById('summaryCompletedCC').textContent;
        const completedPL = document.getElementById('summaryCompletedPL').textContent;
        const completedMDSA = document.getElementById('summaryCompletedMDSA').textContent;
        const completedPrivilege = document.getElementById('summaryCompletedPrivilege').textContent;
        
        const totalCC = document.getElementById('summaryTotalCC').textContent;
        const totalPL = document.getElementById('summaryTotalPL').textContent;
        const totalAccounts = document.getElementById('summaryTotalAccounts').textContent;
        
        // Get progress percentages
        const progressCC = document.getElementById('progressCC').textContent;
        const progressPL = document.getElementById('progressPL').textContent;
        const progressACC = document.getElementById('progressACC').textContent;
        
        const now = new Date();
        const dateStr = `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
        const timeStr = now.toLocaleTimeString();
        
        const summaryText = `SUMMARY REPORT [Generated on: ${dateStr} at ${timeStr}]

IN PROGRESS
Credit Cards: ${inProgressCC}
Personal Loans: ${inProgressPL}
MDSA: ${inProgressMDSA}
Privilege: ${inProgressPrivilege}

COMPLETED
Credit Cards: ${completedCC}
Personal Loans: ${completedPL}
MDSA: ${completedMDSA}
Privilege: ${completedPrivilege}

TOTAL SUBMISSIONS
Credit Cards: ${totalCC}
Personal Loans: ${totalPL}
Accounts: ${totalAccounts}

TARGET PROGRESS
Credit Cards: ${progressCC}
Personal Loans: ${progressPL}
Accounts: ${progressACC}`;
        
        return summaryText;
    }

    // Function to categorize product type
    function categorizeProductType(productString) {
        if (!productString) return "Unknown";
        
        // Check for Account products
        if (productString.includes("MDSA") || 
            productString.includes("Aspire") || 
            productString.includes("Privilege")) {
            return "ACC";
        }
        
        // Check for Credit Card products
        if (productString.includes("Touchpoints") || 
            productString.includes("Cashback") ||
            productString.includes("Talabat") ||
            productString.includes("Visa") ||
            productString.includes("MC") ||
            productString.includes("Guest")) {
            return "CC";
        }
        
        // Check for Personal Loan
        if (productString.includes("Cat A & B") || 
            productString.includes("Cat C & Below")) {
            return "PL";
        }
        
        // Generic checks based on product abbreviations
        if (productString.includes("ACC")) return "ACC";
        if (productString.includes("CC")) return "CC";
        if (productString.includes("2ndCC")) return "CC";
        if (productString.includes("BT/CCL")) return "BT/CCL";
        if (productString.includes("PL")) return "PL";
        if (productString.includes("STL")) return "STL";
        
        return "Unknown";
    }

    // Search for data from Master sheet
    async function searchData() {
        const cid = document.getElementById('searchCID').value.trim();
        const name = document.getElementById('searchName').value.trim();
        const mobile = document.getElementById('searchMobile').value.trim();
        
        if (!cid && !name && !mobile) {
            showSuccess('Please enter at least one search criteria');
            return;
        }
        
        showLoading();
        try {
            // Always search from server for Master sheet data
            const response = await fetch(`${scriptURL}?action=searchMaster&cid=${encodeURIComponent(cid)}&name=${encodeURIComponent(name)}&mobile=${encodeURIComponent(mobile)}`);
            const data = await response.json();
            
            if (data.success) {
                displayDataInTable(data.data, 'searchResultsBody', true);
                if (data.data.length === 0) {
                    document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">No matching records found in Master sheet</td></tr>';
                }
            } else {
                showSuccess(`Error: ${data.error}`);
                document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">Error searching Master sheet</td></tr>';
            }
        } catch (error) {
            console.error('Error searching Master sheet:', error);
            showSuccess('Error connecting to Master sheet');
            document.getElementById('searchResultsBody').innerHTML = '<tr><td colspan="7" class="text-center py-4">Error connecting to Master sheet</td></tr>';
        } finally {
            hideLoading();
        }
    }

    // Clear search function
    function clearSearch() {
        document.getElementById('searchCID').value = '';
        document.getElementById('searchName').value = '';
        document.getElementById('searchMobile').value = '';
        document.getElementById('searchResultsBody').innerHTML = '';
    }

    // Clear search button event listener
    document.getElementById('clearSearchBtn').addEventListener('click', clearSearch);

    // Fix 2: Copy to clipboard function
    function copyToClipboard(text) {
        // Use navigator.clipboard API if available
        if (navigator.clipboard && window.isSecureContext) {
            return navigator.clipboard.writeText(text).then(() => {
                return true;
            }).catch(err => {
                console.error('Failed to copy text with Clipboard API: ', err);
                return fallbackCopyToClipboard(text);
            });
        } else {
            return fallbackCopyToClipboard(text);
        }
    }
    
    function fallbackCopyToClipboard(text) {
        // Create a temporary input element for plain text
        const input = document.createElement('textarea');
        input.style.position = 'fixed';
        input.style.opacity = 0;
        input.style.left = '-999999px';
        input.value = text;
        document.body.appendChild(input);
        input.select();
        input.setSelectionRange(0, 99999);
        
        try {
            // Execute the copy command
            const successful = document.execCommand('copy');
            return successful;
        } catch (err) {
            console.error('Failed to copy text: ', err);
            return false;
        } finally {
            document.body.removeChild(input);
        }
    }

    // Start long press
    function startLongPress(element, cid) {
        isLongPressing = false;
        element.classList.add('longpress-active');
        
        longPressTimer = setTimeout(() => {
            isLongPressing = true;
            element.classList.remove('longpress-active');
            editRecord(cid);
        }, 1000);
    }

    // End long press
    function endLongPress(element) {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
        element.classList.remove('longpress-active');
    }

    // Fixed: Updated function with improved action button layout, copy functionality, and points column immediate edit (requirement 3A)
    function displayDataInTable(data, targetTableId, isMasterSearch = false) {
        const tableBody = document.getElementById(targetTableId);
        tableBody.innerHTML = '';
        
        if (data.length === 0) {
            const colSpan = isMasterSearch ? 7 : 8;
            tableBody.innerHTML = `<tr><td colspan="${colSpan}" class="text-center py-4">No records found</td></tr>`;
            return;
        }
        
        data.forEach(row => {
            const tr = document.createElement('tr');
            tr.classList.add('table-row-longpress');
            const mobileNumber = row.Mobile || '';
            const cidValue = row.CID || '';
            const appIdValue = row['App ID'] || '';
            const customerNameValue = row['Customer Name'] || '';
            
            let actionsHtml = '';
            if (!isMasterSearch) {
                actionsHtml = `
                    <td class="action-column">
                        <a href="tel:+${mobileNumber}" class="action-btn bg-green-600 text-white p-1 rounded inline-block" title="Call ${row['Customer Name']}" role="button">
                            <i class="fas fa-phone"></i>
                        </a>
                        <button class="delete-btn action-btn bg-red-600 text-white p-1 rounded" data-cid="${row.CID}" title="Delete">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
            }
            
            tr.innerHTML = `
                <td class="copyable" data-value="${cidValue}">${cidValue}</td>
                <td class="copyable" data-value="${appIdValue}">${appIdValue}</td>
                <td class="copyable" data-value="${customerNameValue}">${customerNameValue}</td>
                <td class="copyable" data-value="${mobileNumber}">${mobileNumber}</td>
                <td>${row.Product || ''}</td>
                <td>${row.Status || ''}</td>
                <td class="points-column" data-cid="${cidValue}">${row.Points || ''}</td>
                ${actionsHtml}
            `;
            
            // Add long press event listeners for edit functionality (only for non-master search)
            if (!isMasterSearch) {
                tr.addEventListener('mousedown', (e) => {
                    // Don't trigger long press on Points column (6th column) or Actions column (last column)
                    const cell = e.target.closest('td');
                    if (e.button === 0 && cell && !cell.classList.contains('points-column') && !cell.classList.contains('action-column')) {
                        startLongPress(tr, cidValue);
                    }
                });
                
                tr.addEventListener('mouseup', () => {
                    endLongPress(tr);
                });
                
                tr.addEventListener('mouseleave', () => {
                    endLongPress(tr);
                });
                
                // Touch events for mobile
                tr.addEventListener('touchstart', (e) => {
                    // Don't trigger long press on Points column (6th column) or Actions column (last column)
                    const cell = e.target.closest('td');
                    if (cell && !cell.classList.contains('points-column') && !cell.classList.contains('action-column')) {
                        startLongPress(tr, cidValue);
                    }
                });
                
                tr.addEventListener('touchend', (e) => {
                    endLongPress(tr);
                    if (!isLongPressing) {
                        // Allow normal touch interactions
                    }
                });
                
                tr.addEventListener('touchcancel', () => {
                    endLongPress(tr);
                });
            }
            
            tableBody.appendChild(tr);
        });
        
        // Add event listeners to delete buttons (only for non-master search)
        if (!isMasterSearch) {
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent row long press
                    const cid = this.getAttribute('data-cid');
                    if (confirm('Are you sure you want to delete this record?')) {
                        deleteRecord(cid);
                    }
                });
            });
        }
        
        // Fixed: Add immediate click listeners for points column (requirement 3A)
        if (!isMasterSearch) {
            document.querySelectorAll('.points-column').forEach(pointsCell => {
                pointsCell.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent row long press
                    const cid = this.getAttribute('data-cid');
                    if (cid) {
                        editRecord(cid);
                    }
                });
            });
        }
        
        // Fix 2: Add event listeners for copyable fields
        document.querySelectorAll('.copyable').forEach(element => {
            element.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent row long press
                const value = this.getAttribute('data-value');
                if (copyToClipboard(value)) {
                    this.classList.add('copied');
                    setTimeout(() => {
                        this.classList.remove('copied');
                    }, 1500);
                }
            });
        });
    }

    // Submit form data
    async function submitFormData(formData) {
        showLoading();
        
        try {
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: formData
            });
            
            console.log("Response status:", response.status);
            const responseText = await response.text();
            console.log("Raw response:", responseText);
            
            let data;
            try {
                data = JSON.parse(responseText);
                console.log("Parsed response:", data);
            } catch (parseError) {
                console.error("Error parsing response:", parseError);
                showSuccess('Error: Could not parse server response');
                hideLoading();
                return;
            }
            
            if (data.success) {
                showSuccess('Data submitted successfully!');
                resetForm();
                // Stay on the form section after submitting
                showSection('entry');
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            showSuccess('Error submitting data: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Update existing record
    async function updateRecord(formData) {
        showLoading();
        try {
            formData.append('action', 'update');
            
            const response = await fetch(scriptURL, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            if (data.success) {
                showSuccess('Record updated successfully!');
                resetForm();
                // Navigate to View section after update
                showSection('view');
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error updating record:', error);
            showSuccess('Error updating record');
        } finally {
            hideLoading();
        }
    }

    // Delete record
    async function deleteRecord(cid) {
        showLoading();
        try {
            const response = await fetch(`${scriptURL}?action=delete&cid=${cid}`, {
                method: 'GET'
            });
            
            const data = await response.json();
            if (data.success) {
                showSuccess('Record deleted successfully!');
                resetForm();
                if (document.getElementById('entrySection').classList.contains('active')) {
                    // If we're in the entry section, stay there
                    showSection('entry');
                } else {
                    // Otherwise refresh the current view
                    fetchAllData();
                    fetchAllDataForSummary();
                }
            } else {
                showSuccess(`Error: ${data.error}`);
            }
        } catch (error) {
            console.error('Error deleting record:', error);
            showSuccess('Error deleting record');
        } finally {
            hideLoading();
        }
    }

    // Edit record (fetch and populate form)
    async function editRecord(cid) {
        showLoading();
        try {
            // Check if the record exists in local data first
            const localRecord = allRecordsData.find(r => r.CID === cid);
            
            if (localRecord) {
                // Use local data
                editingData = localRecord;
                editingProductString = localRecord.Product || "";
                
                console.log("Got data for editing from local:", editingData);
                populateForm(localRecord);
                
                // Switch to entry section
                showSection('entry');
                
                // Show update and delete buttons, hide submit button
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
                document.getElementById('deleteBtn').classList.remove('hidden');
                
                hideLoading();
                return;
            }
            
            // If not found locally, try fetching from server
            const response = await fetch(`${scriptURL}?action=getById&cid=${cid}`);
            const data = await response.json();
            
            if (data.success && data.data) {
                // Save the raw data for later use
                editingData = data.data;
                editingProductString = data.data.Product || "";
                
                console.log("Got data for editing:", editingData);
                console.log("Product string:", editingProductString);
                
                // Clear any existing selections
                currentSelections = {
                    ACC: '',
                    CC: '',
                    CCOption2: '',
                    PL: ''
                };
                
                // Save the product options from the server if they exist
                if (data.data.accOption) currentSelections.ACC = data.data.accOption;
                if (data.data.ccOption) currentSelections.CC = data.data.ccOption;
                if (data.data.ccOption2) currentSelections.CCOption2 = data.data.ccOption2;
                if (data.data.plOption) currentSelections.PL = data.data.plOption;
                
                // Now populate the form - this will trigger updateProductOptions
                populateForm(data.data);
                
                // Switch to entry section
                showSection('entry');
                
                // Show update and delete buttons, hide submit button
                document.getElementById('submitBtn').classList.add('hidden');
                document.getElementById('updateBtn').classList.remove('hidden');
                document.getElementById('deleteBtn').classList.remove('hidden');
            } else {
                showSuccess(`Error: ${data.error || 'Record not found'}`);
            }
        } catch (error) {
            console.error('Error fetching record:', error);
            showSuccess('Error fetching record data');
        } finally {
            hideLoading();
        }
    }

    // Function to parse a product string into individual items
    function parseProductString(productString) {
        if (!productString) return [];
        
        // Split by comma and trim each item
        return productString.split(',').map(p => p.trim());
    }

    // Function to check if a product string contains a specific product
    function productStringContains(productString, product) {
        const products = parseProductString(productString);
        return products.some(p => p === product || p.includes(product));
    }

    // Helper function to format date for input field
    function formatDateForInput(dateString) {
        if (!dateString) return '';
        
        // Try to parse the date string
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
            // If parsing fails, return the original string
            return dateString;
        }
        
        // Format as YYYY-MM-DD
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        
        return `${year}-${month}-${day}`;
    }

    // Populate form with record data
    function populateForm(data) {
        console.log("Populating form with data:", data);
        
        // Clear form first
        resetForm();
        
        // Save the editing data again (resetForm clears it)
        editingData = data;
        editingProductString = data.Product || "";
        
        // Populate basic fields
        cidInput.value = data.CID || '';
        cidInput.disabled = false; // Enable CID for editing
        cidInput.readOnly = false; // Allow CID to be editable during editing
        appIdInput.value = data['App ID'] || '';
        
        // Set date with proper formatting
        if (data.Date) {
            dateInput.value = formatDateForInput(data.Date);
        }
        
        salaryInput.value = data.Salary || '';
        customerNameInput.value = data['Customer Name'] || '';
        mobileInput.value = data.Mobile || '';
        companyNameInput.value = data['Company Name'] || '';
        
        // Parse the product column to determine which checkboxes should be checked
        const productString = data.Product || '';
        const products = parseProductString(productString);
        console.log("Parsed products:", products);
        
        // Save the raw product options for later use
        if (data.accOption) currentSelections.ACC = data.accOption;
        if (data.ccOption) currentSelections.CC = data.ccOption;
        if (data.ccOption2) currentSelections.CCOption2 = data.ccOption2;
        if (data.plOption) currentSelections.PL = data.plOption;
        
        // Determine which product checkboxes to check based on the product string
        productACC.checked = productStringContains(productString, 'MDSA') || 
                            productStringContains(productString, 'Aspire') ||
                            productStringContains(productString, 'Privilege') ||
                            productStringContains(productString, 'ACC');
                            
        productSTL.checked = productStringContains(productString, 'STL');
        
        productCC.checked = productStringContains(productString, 'Touchpoints') ||
                           productStringContains(productString, 'Cashback') ||
                           productStringContains(productString, 'Talabat') ||
                           productStringContains(productString, 'Lulu') ||
                           productStringContains(productString, 'Etihad') ||
                           productStringContains(productString, 'Shukran') ||
                           productStringContains(productString, 'All ') ||
                           productStringContains(productString, 'Traveller') ||
                           productStringContains(productString, 'Betaqti') ||
                           productStringContains(productString, 'Emirati') ||
                           productStringContains(productString, 'CC');
        
        product2ndCC.checked = productStringContains(productString, '2ndCC') ||
                               (products.length > 1 && 
                                (productStringContains(productString, 'Touchpoints') ||
                                 productStringContains(productString, 'Talabat')));
        
        productBTCCL.checked = productStringContains(productString, 'BT/CCL');
        
        productPL.checked = productStringContains(productString, 'Asipire Cat') ||
                           productStringContains(productString, 'Privilege Cat') ||
                           productStringContains(productString, 'PL');
                           
        productOther.checked = productStringContains(productString, 'Other');
        
        if (productPL.checked) {
            loanAmountSection.classList.remove('hidden');
            loanAmountInput.value = data['Loan Amount'] || '';
        }
        
        if (productOther.checked) {
            otherPointsSection.classList.remove('hidden');
            otherPointsInput.value = data['Other Points'] || '';
        }
        
        // Enable/disable dependent checkboxes
        productSTL.disabled = !productACC.checked;
        product2ndCC.disabled = !productCC.checked;
        
        // Set proposition
        const propositionRadios = document.getElementsByName('proposition');
        for (let radio of propositionRadios) {
            if (radio.value === data.Proposition) {
                radio.checked = true;
                break;
            }
        }
        
        // Set scheme
        const schemeRadios = document.getElementsByName('scheme');
        for (let radio of schemeRadios) {
            if (radio.value === data.Scheme) {
                radio.checked = true;
                break;
            }
        }
        
        // Set activation
        const activationRadios = document.getElementsByName('activation');
        for (let radio of activationRadios) {
            if (radio.value === data.Activation) {
                radio.checked = true;
                break;
            }
        }
        
        // Set banking and ADCB override
        if (data.Banking) {
            if (['SELECT', 'ADCB', 'ENBD', 'EIB', 'FAB', 'DIB', 'MASHREQ', 'ADIB', 'RAK', 'CBD', 'HSBC', 'CITI'].includes(data.Banking)) {
                bankingSelect.value = data.Banking;
            } else {
                bankingSelect.value = 'Other';
                otherBankingSection.classList.remove('hidden');
                otherBankingInput.value = data.Banking;
            }
        }
        
        // Set ADCB override checkbox if applicable
        adcbOverrideCheckbox.checked = data.adcbOverride === 'true' || data.adcbOverride === true;
        
        // Set status
        if (data.Status) {
            if (['Draft', 'Under Review', 'Completed', 'HR CPV', 'Compliance', 'Rejected'].includes(data.Status)) {
                statusSelect.value = data.Status;
            } else {
                statusSelect.value = 'Other';
                otherStatusSection.classList.remove('hidden');
                otherStatusInput.value = data.Status;
            }
        }
        
        // Set points
        pointsInput.value = data.Points || '';
        
        // Generate product options containers
        initializeProductOptions();
        
        // Fix 3: Make sure points are set to 0 if status is Rejected
        if (statusSelect.value === 'Rejected') {
            pointsInput.value = '0';
        }
    }

    // Check if CID, Customer Name, or Mobile already exists
    async function checkUniqueness(cid, customerName, mobile) {
        try {
            const response = await fetch(`${scriptURL}?action=checkUnique&cid=${cid}&name=${encodeURIComponent(customerName)}&mobile=${mobile}`);
            return await response.json();
        } catch (error) {
            console.error('Error checking uniqueness:', error);
            showSuccess('Error checking uniqueness');
            return { 
                success: false, 
                data: { cidExists: false, nameExists: false, mobileExists: false },
                error: error.message
            };
        }
    }

    // Validate form before submission
    async function validateForm() {
        let isValid = true;
        
        // Clear previous validation errors
        document.getElementById('nameError').classList.add('hidden');
        document.getElementById('mobileError').classList.add('hidden');
        document.getElementById('productsError').classList.add('hidden');
        
        // Fixed: Remove CID validation completely (requirement 3B)
        cidInput.classList.remove('error-field');
        
        if (!dateInput.value) {
            dateInput.classList.add('error-field');
            isValid = false;
        } else {
            dateInput.classList.remove('error-field');
        }
        
        if (!salaryInput.value.trim()) {
            salaryInput.classList.add('error-field');
            isValid = false;
        } else {
            salaryInput.classList.remove('error-field');
        }
        
        if (!customerNameInput.value.trim()) {
            customerNameInput.classList.add('error-field');
            isValid = false;
        } else {
            customerNameInput.classList.remove('error-field');
        }
        
        if (!mobileInput.value.trim()) {
            mobileInput.classList.add('error-field');
            isValid = false;
        } else {
            mobileInput.classList.remove('error-field');
        }
        
        if (statusSelect.value === '') {
            statusSelect.classList.add('error-field');
            isValid = false;
        } else {
            statusSelect.classList.remove('error-field');
        }
        
        // Product validation - at least one product must be selected
        const productSelected = productACC.checked || productSTL.checked || productCC.checked || 
                               product2ndCC.checked || productBTCCL.checked || productPL.checked || productOther.checked;
        
        if (!productSelected) {
            document.getElementById('productsError').classList.remove('hidden');
            isValid = false;
        }
        
        // For update operations, we don't need to check uniqueness for the current record
        if (document.getElementById('updateBtn').classList.contains('hidden')) {
            // Check uniqueness only for customer name and mobile (not CID)
            if (isValid && (customerNameInput.value.trim() || mobileInput.value.trim())) {
                showLoading();
                const uniquenessCheck = await checkUniqueness(
                    '', // Don't check CID uniqueness (fixed requirement 3B)
                    customerNameInput.value.trim(),
                    mobileInput.value.trim()
                );
                hideLoading();
                
                if (uniquenessCheck.success && uniquenessCheck.data) {
                    if (uniquenessCheck.data.nameExists) {
                        document.getElementById('nameError').classList.remove('hidden');
                        customerNameInput.classList.add('error-field');
                        isValid = false;
                    }
                    
                    if (uniquenessCheck.data.mobileExists) {
                        document.getElementById('mobileError').classList.remove('hidden');
                        mobileInput.classList.add('error-field');
                        isValid = false;
                    }
                } else if (!uniquenessCheck.success) {
                    console.log('Warning: Could not check uniqueness');
                    // Don't fail validation if uniqueness check fails
                }
            }
        }
        
        return isValid;
    }

    // Collect form data for submission
    function collectFormData() {
        const formData = new FormData();
        
        // Add basic fields - CID is optional but if provided, should be valid
        const cidValue = cidInput.value.trim();
        formData.append('cid', cidValue);
        formData.append('appId', appIdInput.value);
        
        const proposition = document.querySelector('input[name="proposition"]:checked').value;
        formData.append('proposition', proposition);
        
        formData.append('date', dateInput.value);
        formData.append('salary', salaryInput.value);
        formData.append('customerName', customerNameInput.value);
        formData.append('mobile', mobileInput.value);
        
        // Banking
        let bankingValue = bankingSelect.value;
        if (bankingValue === 'Other') {
            bankingValue = otherBankingInput.value || 'Other';
        }
        formData.append('banking', bankingValue);
        
        // ADCB override checkbox
        formData.append('adcbOverride', adcbOverrideCheckbox.checked);
        
        // Company Name
        formData.append('companyName', companyNameInput.value);
        
        // Scheme
        const scheme = document.querySelector('input[name="scheme"]:checked').value;
        formData.append('scheme', scheme);
        
        // Status
        let statusValue = statusSelect.value;
        if (statusValue === 'Other') {
            statusValue = otherStatusInput.value || 'Other';
        }
        formData.append('status', statusValue);
        
        // Activation
        const activation = document.querySelector('input[name="activation"]:checked').value;
        formData.append('activation', activation);
        
        // Points - Fix 3: Ensure points are 0 if status is Rejected
        formData.append('points', statusValue === 'Rejected' ? '0' : pointsInput.value);
        
        // Fix 2: Collect selected product options to store in Product column
        const selectedProductOptions = [];
        
        // Get ACC selection
        if (productACC.checked) {
            const accSelect = document.getElementById('ACCSelect');
            if (accSelect && accSelect.value) {
                const selectedOption = accSelect.options[accSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text.split(' (')[0]);  // Get text before any parentheses
                formData.append('accOption', accSelect.value);
            } else {
                selectedProductOptions.push('ACC');
            }
            
            // Include STL if checked
            if (productSTL.checked) {
                selectedProductOptions.push('STL');
            }
        }
        
        // Get CC selection
        if (productCC.checked) {
            const ccSelect = document.getElementById('CCSelect');
            if (ccSelect && ccSelect.value) {
                const selectedOption = ccSelect.options[ccSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text);
                formData.append('ccOption', ccSelect.value);
            } else {
                selectedProductOptions.push('CC');
            }
            
            // Get 2nd CC selection
            if (product2ndCC.checked) {
                const cc2Select = document.getElementById('CCSelect2');
                if (cc2Select && cc2Select.value) {
                    const selectedOption = cc2Select.options[cc2Select.selectedIndex];
                    selectedProductOptions.push(selectedOption.text);
                    formData.append('ccOption2', cc2Select.value);
                } else {
                    selectedProductOptions.push('2ndCC');
                }
            }
        }
        
        // Include BT/CCL if checked
        if (productBTCCL.checked) {
            selectedProductOptions.push('BT/CCL');
        }
        
        // Include Other if checked
        if (productOther.checked) {
            selectedProductOptions.push('Other');
            formData.append('otherPoints', otherPointsInput.value);
        }
        
        // Get PL selection
        if (productPL.checked) {
            const plSelect = document.getElementById('PLSelect');
            if (plSelect && plSelect.value) {
                const selectedOption = plSelect.options[plSelect.selectedIndex];
                selectedProductOptions.push(selectedOption.text);
                formData.append('plOption', plSelect.value);
            } else {
                selectedProductOptions.push('PL');
            }
            formData.append('loanAmount', loanAmountInput.value);
        }
        
        // Join all product selections into a single string
        const productList = selectedProductOptions.join(', ');
        formData.append('productList', productList);
        
        return formData;
    }

    // ==========================================
    // EXPORT FUNCTIONALITY
    // ==========================================
    
    // Get required modal elements
    const exportModal = document.getElementById('exportModal');
    const closeExportModalBtn = document.getElementById('closeExportModal');
    const cancelExportBtn = document.getElementById('cancelExportBtn');
    const exportDataBtn = document.getElementById('exportDataBtn');
    const confirmExportBtn = document.getElementById('confirmExportBtn');
    const selectAllRows = document.getElementById('selectAllRows');
    const selectAllHeader = document.getElementById('selectAllHeader');
    const exportTableBody = document.getElementById('exportTableBody');
    const selectedRowsCount = document.getElementById('selectedRowsCount');
    const totalAmountEl = document.getElementById('totalAmount');
    
    // Profile management elements
    const profileNameInput = document.getElementById('profileName');
    const profileSelect = document.getElementById('profileSelect');
    const saveProfileBtn = document.getElementById('saveProfileBtn');
    const loadProfileBtn = document.getElementById('loadProfileBtn');
    const deleteProfileBtn = document.getElementById('deleteProfileBtn');
    
    // Open export modal when Export button is clicked
    exportDataBtn.addEventListener('click', function() {
        // Populate export table with data
        populateExportTable();
        
        // Show modal
        exportModal.style.display = 'block';
    });
    
    // Close modal functions
    function closeExportModal() {
        exportModal.style.display = 'none';
    }
    
    closeExportModalBtn.addEventListener('click', closeExportModal);
    cancelExportBtn.addEventListener('click', closeExportModal);
    
    // Close modal when clicking outside the modal content
    window.addEventListener('click', function(event) {
        if (event.target === exportModal) {
            closeExportModal();
        }
    });
    
    // Populate export table with records
    function populateExportTable() {
        exportTableBody.innerHTML = '';
        
        if (allRecordsData.length === 0) {
            exportTableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No records found</td></tr>';
            selectAllRows.disabled = true;
            selectAllHeader.disabled = true;
            return;
        }
        
        selectAllRows.disabled = false;
        selectAllHeader.disabled = false;
        
        allRecordsData.forEach((record, index) => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-cid', record.CID || '');
            
            const date = record.Date ? new Date(record.Date).toLocaleDateString() : '';
            const productType = categorizeProductType(record.Product);
            
            // Prepare product display string
            let productDisplay = productType;
            if (productType === "PL" && record['Loan Amount']) {
                productDisplay = `${productType} (AED ${parseInt(record['Loan Amount']).toLocaleString()})`;
            }
            
            // Look for amount in saved profiles, defaulting to empty
            let savedAmount = '';
            
            // Try to get saved amount from profile data
            if (record.exportAmount) {
                savedAmount = record.exportAmount;
            }
            
            tr.innerHTML = `
                <td><input type="checkbox" class="row-checkbox" data-cid="${record.CID || ''}"></td>
                <td>${record.CID || ''}</td>
                <td>${date}</td>
                <td>${record['Customer Name'] || ''}</td>
                <td>${productDisplay}</td>
                <td>${record.Status || ''}</td>
                <td><input type="number" class="amount-input" value="${savedAmount}" placeholder="Enter amount"></td>
            `;
            
            exportTableBody.appendChild(tr);
        });
        
        // Add event listeners to all amount inputs to recalculate total
        document.querySelectorAll('.amount-input').forEach(input => {
            input.addEventListener('input', calculateTotalAmount);
        });
        
        // Initialize selected count
        updateSelectedRowsCount();
        
        // Default to selecting all rows
        selectAllRows.checked = true;
        selectAllHeader.checked = true;
        document.querySelectorAll('#exportTableBody .row-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedRowsCount();
        
        // Calculate initial total
        calculateTotalAmount();
    }
    
    // Calculate total amount from all checked rows
    function calculateTotalAmount() {
        let total = 0;
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const amount = parseFloat(amountInput.value) || 0;
            total += amount;
        });
        
        // Display the total with formatting
        totalAmountEl.textContent = total.toLocaleString('en-US');
    }
    
    // Update selected rows count
    function updateSelectedRowsCount() {
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked').length;
        selectedRowsCount.textContent = `${checkedRows} rows selected`;
        
        // Recalculate total when selection changes
        calculateTotalAmount();
    }
    
    // Handle "Select All" checkbox in the header
    selectAllHeader.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        selectAllRows.checked = this.checked;
        updateSelectedRowsCount();
    });
    
    // Handle "Select All" checkbox above the table
    selectAllRows.addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        
        selectAllHeader.checked = this.checked;
        updateSelectedRowsCount();
    });
    
    // Update count when individual checkboxes change
    exportTableBody.addEventListener('change', function(e) {
        if (e.target.classList.contains('row-checkbox')) {
            const allCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
            const checkedCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
            
            selectAllRows.checked = allCheckboxes.length === checkedCheckboxes.length;
            selectAllHeader.checked = allCheckboxes.length === checkedCheckboxes.length;
            
            updateSelectedRowsCount();
        }
    });
    
    // Export selected data as PDF
    confirmExportBtn.addEventListener('click', function() {
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        // Check if we have selected rows
        if (checkedRows.length === 0) {
            showSuccess("Please select at least one record to export");
            return;
        }
        
        // Check if all amount fields are empty
        let hasAmounts = false;
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            if (amountInput && amountInput.value && amountInput.value.trim() !== '') {
                hasAmounts = true;
            }
        });
        
        // Extract data directly from the checked rows
        let selectedData = [];
        checkedRows.forEach(checkbox => {
            const row = checkbox.closest('tr');
            if (row) {
                const cells = row.querySelectorAll('td');
                const amountInput = row.querySelector('.amount-input');
                const amount = amountInput ? amountInput.value : '';
                
                if (cells.length >= 7) {
                    const rowData = {
                        CID: cells[1].textContent,
                        Date: cells[2].textContent,
                        'Customer Name': cells[3].textContent,
                        Product: cells[4].textContent,
                        Status: cells[5].textContent
                    };
                    
                    // Only include amount if there are amounts in the data
                    if (hasAmounts) {
                        rowData.Amount = amount;
                    }
                    
                    selectedData.push(rowData);
                    
                    // Save amount to corresponding record in allRecordsData for profile saving
                    const cid = checkbox.getAttribute('data-cid');
                    const record = allRecordsData.find(r => r.CID === cid);
                    if (record) {
                        record.exportAmount = amount;
                    }
                }
            }
        });
        
        // Fallback to test data if still no data
        if (selectedData.length === 0) {
            selectedData = testData.map(item => {
                const data = {...item};
                if (hasAmounts) {
                    data.Amount = "0";
                }
                return data;
            });
            showSuccess("Using fallback data for PDF export.");
        }
        
        // Calculate total amount for PDF (only if amounts exist)
        let totalAmount = 0;
        if (hasAmounts) {
            totalAmount = selectedData.reduce((total, record) => {
                return total + (parseFloat(record.Amount) || 0);
            }, 0);
        }
        
        // Create PDF with conditional Amount column
        createPDF(selectedData, totalAmount, hasAmounts);
        
        // Close modal
        closeExportModal();
        
        // Show success message
        showSuccess(`Exported ${selectedData.length} records as PDF successfully`);
    });
    
    // Updated PDF generation function to handle optional Amount column
    function createPDF(data, totalAmount, includeAmount) {
        try {
            console.log("Creating PDF with data:", JSON.stringify(data));
            console.log("Include amount column:", includeAmount);
            
            // Create a new jsPDF instance
            const doc = new jsPDF();
            
            // Add title with better styling
            doc.setFontSize(18);
            doc.setTextColor(0, 251, 255); // New primary color
            doc.text('Sales Report', 15, 15);
            
            // Add date with better styling
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 15, 25);
            
            // Total available width is 180 units (from the border drawing)
            const totalWidth = 180;
            // Margin from left edge
            const leftMargin = 15;
            
            let colWidthNo, colWidthCID, colWidthDate, colWidthName, colWidthProduct, colWidthStatus, colWidthAmount;
            let col0X, col1X, col2X, col3X, col4X, col5X, col6X;
            
            if (includeAmount) {
                // Define column widths with amount column
                colWidthNo = totalWidth * 0.05;      // 5%
                colWidthCID = totalWidth * 0.10;     // 10%
                colWidthDate = totalWidth * 0.10;    // 10%
                colWidthName = totalWidth * 0.30;    // 30%
                colWidthProduct = totalWidth * 0.10; // 10%
                colWidthStatus = totalWidth * 0.15;  // 15%
                colWidthAmount = totalWidth * 0.20;  // 20%
                
                col0X = leftMargin + 3;
                col1X = leftMargin + colWidthNo;
                col2X = col1X + colWidthCID;
                col3X = col2X + colWidthDate;
                col4X = col3X + colWidthName;
                col5X = col4X + colWidthProduct;
                col6X = col5X + colWidthStatus;
            } else {
                // Define column widths without amount column
                colWidthNo = totalWidth * 0.06;      // 6%
                colWidthCID = totalWidth * 0.12;     // 12%
                colWidthDate = totalWidth * 0.12;    // 12%
                colWidthName = totalWidth * 0.40;    // 40%
                colWidthProduct = totalWidth * 0.15; // 15%
                colWidthStatus = totalWidth * 0.15;  // 15%
                
                col0X = leftMargin + 3;
                col1X = leftMargin + colWidthNo;
                col2X = col1X + colWidthCID;
                col3X = col2X + colWidthDate;
                col4X = col3X + colWidthName;
                col5X = col4X + colWidthProduct;
            }
            
            // Add header with colored background
            doc.setFillColor(0, 251, 255); // New primary color
            doc.rect(15, 30, 180, 8, 'F');
            
            // Add header text
            doc.setFontSize(10);
            doc.setTextColor(255, 255, 255); // White text
            doc.setFont(undefined, 'bold');
            
            doc.text('No', col0X, 35);
            doc.text('CID', col1X, 35);
            doc.text('Date', col2X, 35);
            doc.text('Customer Name', col3X, 35);
            doc.text('Product', col4X, 35);
            doc.text('Status', col5X, 35);
            if (includeAmount) {
                doc.text('Amount', col6X, 35);
            }
            
            // Reset font and color for data rows
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);
            
            // Add data rows
            let y = 45;
            data.forEach((row, i) => {
                // Check if we need a new page
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                    
                    // Add header to new page
                    doc.setFillColor(0, 251, 255); // New primary color
                    doc.rect(15, y-5, 180, 8, 'F');
                    
                    // Add header text
                    doc.setTextColor(255, 255, 255); // White text
                    doc.setFont(undefined, 'bold');
                    
                    doc.text('No', col0X, y);
                    doc.text('CID', col1X, y);
                    doc.text('Date', col2X, y);
                    doc.text('Customer Name', col3X, y);
                    doc.text('Product', col4X, y);
                    doc.text('Status', col5X, y);
                    if (includeAmount) {
                        doc.text('Amount', col6X, y);
                    }
                    
                    // Reset font for data
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    y += 10;
                }
                
                // Add alternating row background
                if (i % 2 === 1) {
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y-5, 180, 8, 'F');
                }
                
                // Add row data
                doc.text((i + 1).toString(), col0X, y);
                doc.text(row.CID?.toString() || '', col1X, y);
                doc.text(row.Date?.toString() || '', col2X, y);
                doc.text(row['Customer Name']?.toString() || '', col3X, y);
                doc.text(row.Product?.toString() || '', col4X, y);
                doc.text(row.Status?.toString() || '', col5X, y);
                
                if (includeAmount) {
                    const amountValue = parseFloat(row.Amount) || 0;
                    const formattedAmount = amountValue.toLocaleString('en-US');
                    doc.text(formattedAmount, col6X + colWidthAmount - 5, y, { align: 'right' });
                }
                
                y += 10;
            });
            
            // Add total row only if amount column is included
            if (includeAmount) {
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y-5, 180, 8, 'F');
                
                doc.setDrawColor(0, 251, 255);
                doc.setLineWidth(0.5);
                doc.line(15, y-5, 195, y-5);
                
                doc.setFont(undefined, 'bold');
                doc.text('Total:', col5X, y);
                
                const formattedTotal = totalAmount.toLocaleString('en-US');
                doc.text(formattedTotal, col6X + colWidthAmount - 5, y, { align: 'right' });
                
                y += 10;
            }
            
            // Draw border around the table
            doc.setDrawColor(0, 251, 255);
            doc.setLineWidth(0.5);
            for (let i = 1; i <= doc.internal.getNumberOfPages(); i++) {
                doc.setPage(i);
                const pageHeight = doc.internal.pageSize.height;
                if (i === doc.internal.getNumberOfPages()) {
                    doc.rect(15, 30, 180, Math.min(y - 35, pageHeight - 40));
                } else {
                    doc.rect(15, 30, 180, pageHeight - 40);
                }
            }
            
            // Add footer with page numbers
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(0, 251, 255);
                doc.text(`Page ${i} of ${pageCount}`, 100, 290, { align: 'center' });
            }
            
            // Save the PDF
            doc.save('customer_data_report.pdf');
            console.log("PDF generated successfully");
        } catch (error) {
            console.error("Error generating PDF:", error);
            alert("Error generating PDF: " + error.message + "\n\nPlease check console for details.");
            
            // Fallback for absolute emergencies - download JSON
            downloadJSON(data);
        }
    }
    
    // Helper function to truncate text that's too long for its column
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength - 3) + '...' : text;
    }
    
    // FALLBACK: Download JSON if everything else fails
    function downloadJSON(data) {
        try {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'customer_data_report.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log("JSON data downloaded as fallback");
            showSuccess("PDF generation failed. Data downloaded as JSON instead.");
        } catch (e) {
            console.error("Even JSON fallback failed:", e);
            showSuccess("All PDF export methods failed. Please try again or contact support.");
        }
    }
    
    // ==========================================
    // PROFILE MANAGEMENT
    // ==========================================
    
    // Save profile
    saveProfileBtn.addEventListener('click', function() {
        const profileName = profileNameInput.value.trim();
        
        if (!profileName) {
            showSuccess('Please enter a profile name');
            return;
        }
        
        // Get selected CIDs and amounts
        const selectedRecords = [];
        const checkedRows = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        checkedRows.forEach(checkbox => {
            const cid = checkbox.dataset.cid;
            const row = checkbox.closest('tr');
            const amountInput = row.querySelector('.amount-input');
            const amount = amountInput.value;
            
            selectedRecords.push({
                cid: cid,
                amount: amount
            });
        });
        
        if (selectedRecords.length === 0) {
            showSuccess('Please select at least one record to save in profile');
            return;
        }
        
        // Save profile to localStorage
        saveProfile(profileName, selectedRecords);
        
        // Refresh profile dropdown
        loadProfiles();
        
        // Show success message
        showSuccess(`Profile "${profileName}" saved with ${selectedRecords.length} records`);
        
        // Clear the input
        profileNameInput.value = '';
    });
    
    // Load profile
    loadProfileBtn.addEventListener('click', function() {
        const profileName = profileSelect.value;
        
        if (!profileName) {
            showSuccess('Please select a profile');
            return;
        }
        
        // Load profile from localStorage
        const selectedRecords = loadProfile(profileName);
        
        if (!selectedRecords || selectedRecords.length === 0) {
            showSuccess('Profile is empty or could not be loaded');
            return;
        }
        
        // Select rows based on loaded CIDs and set amounts
        const rowCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        
        // First, uncheck all checkboxes
        rowCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Then check only those that are in the profile and set amounts
        rowCheckboxes.forEach(checkbox => {
            const cid = checkbox.dataset.cid;
            const recordData = selectedRecords.find(record => record.cid === cid);
            
            if (recordData) {
                checkbox.checked = true;
                
                // Set amount if available
                if (recordData.amount) {
                    const row = checkbox.closest('tr');
                    const amountInput = row.querySelector('.amount-input');
                    if (amountInput) {
                        amountInput.value = recordData.amount;
                    }
                }
            }
        });
        
        // Update select all checkboxes
        const allCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox');
        const checkedCheckboxes = document.querySelectorAll('#exportTableBody .row-checkbox:checked');
        
        selectAllRows.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
        selectAllHeader.checked = allCheckboxes.length === checkedCheckboxes.length && allCheckboxes.length > 0;
        
        // Update selected count and recalculate total
        updateSelectedRowsCount();
        calculateTotalAmount();
        
        // Show success message
        showSuccess(`Profile "${profileName}" loaded with ${selectedRecords.length} records`);
    });
    
    // Delete profile
    deleteProfileBtn.addEventListener('click', function() {
        const profileName = profileSelect.value;
        
        if (!profileName) {
            showSuccess('Please select a profile to delete');
            return;
        }
        
        // Delete profile from localStorage
        deleteProfile(profileName);
        
        // Refresh profile dropdown
        loadProfiles();
        
        // Show success message
        showSuccess(`Profile "${profileName}" deleted`);
    });
    
    // Save profile to localStorage
    function saveProfile(name, selectedRecords) {
        // Get existing profiles
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        
        // Add or update profile
        profiles[name] = selectedRecords;
        
        // Save back to localStorage
        localStorage.setItem('exportProfiles', JSON.stringify(profiles));
    }
    
    // Load profile from localStorage
    function loadProfile(name) {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        return profiles[name] || [];
    }
    
    // Delete profile from localStorage
    function deleteProfile(name) {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        
        if (profiles[name]) {
            delete profiles[name];
            localStorage.setItem('exportProfiles', JSON.stringify(profiles));
        }
    }
    
    // Load profiles into dropdown
    function loadProfiles() {
        const profiles = JSON.parse(localStorage.getItem('exportProfiles')) || {};
        
        // Clear dropdown except first option
        while (profileSelect.options.length > 1) {
            profileSelect.remove(1);
        }
        
        // Add profiles to dropdown
        for (const profileName in profiles) {
            const option = document.createElement('option');
            option.value = profileName;
            option.textContent = `${profileName} (${profiles[profileName].length} records)`;
            profileSelect.appendChild(option);
        }
    }

    // ==========================================
    // EVENT LISTENERS
    // ==========================================

    // Form submit event
    entryForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        if (await validateForm()) {
            const formData = collectFormData();
            formData.append('action', 'add');
            await submitFormData(formData);
        }
    });

    // Update button click event
    document.getElementById('updateBtn').addEventListener('click', async function() {
        if (await validateForm()) {
            const formData = collectFormData();
            await updateRecord(formData);
        }
    });

    // Delete button click event
    document.getElementById('deleteBtn').addEventListener('click', function() {
        const cid = cidInput.value;
        if (cid && confirm('Are you sure you want to delete this record?')) {
            deleteRecord(cid);
        }
    });

    // Refresh data button click event
    document.getElementById('refreshDataBtn').addEventListener('click', function() {
        fetchAllData();
        fetchAllDataForSummary(); // Also refresh summary data
    });

    // Search button click event
    document.getElementById('searchBtn').addEventListener('click', function() {
        searchData();
    });
</script>
</body>
</html>
