<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Eligibility Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6F2C4F',
                        secondary: '#262a5a',
                        lightblue: '#caf0f8',
                        lightgreen: '#d8f3dc',
                        lightyellow: '#ffedd8',
                        lightred: '#ffccd5',
                        lightgray: '#f3f4f6',
                        accent: '#36c5a1'
                    },
                    fontFamily: {
                        tahoma: ['Tahoma', 'Geneva', 'sans-serif']
                    },
                    boxShadow: {
                        'custom': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'custom-lg': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tahoma:wght@400;700&display=swap');
        
        body {
            font-family: 'Tahoma', Geneva, sans-serif;
        }

        /* Tab styling */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .tab-button {
            position: relative;
            transition: all 0.3s;
        }
        
        .tab-button.active {
            color: #6F2C4F;
            border-bottom-color: #6F2C4F;
        }
        
        .dark .tab-button.active {
            color: white;
            border-bottom-color: white;
        }
        
        /* Tab indicator animation */
        .tab-indicator {
            position: absolute;
            bottom: 0;
            height: 4px;
            background-color: #6F2C4F;
            transition: all 0.3s;
        }
        
        .dark .tab-indicator {
            background-color: white;
        }
        
        @keyframes redFlash {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .dbr-warning-flash {
            animation: redFlash 1s ease-in-out 3;
            border: 2px solid rgba(239, 68, 68, 0.7) !important;
            background-color: rgba(239, 68, 68, 0.05) !important;
        }
        
        .dark .dbr-warning-flash {
            border: 2px solid rgba(248, 113, 113, 0.7) !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
        }
        
        .dbr-high {
            color: #ef4444 !important;
            font-weight: bold;
            background-color: rgba(239, 68, 68, 0.1) !important;
            border-color: #ef4444 !important;
        }

        .dark .dbr-high {
            color: #f87171 !important;
            background-color: rgba(248, 113, 113, 0.1) !important;
            border-color: #f87171 !important;
        }
        
        .card-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .card-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .loan-settled {
            opacity: 0.6;
            background-color: #f3f4f6 !important;
            border: 1px dashed #9ca3af !important;
        }
        
        .dark .loan-settled {
            background-color: #374151 !important;
            border: 1px dashed #6b7280 !important;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: #2D336B !important;
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }
        
        .btn-icon {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
            width: 60px;
            height: 60px;
        }
        
        .btn-icon i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        /* Action pills */
        .action-pill {
            transition: all 0.3s ease;
        }
        
        .action-pill:hover {
            transform: translateY(-2px);
        }
        
        .success-indicator {
            background: rgb(22, 163, 74);
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            position: fixed;
            top: 20px;
            right: 20px;
            animation: fadeOut 2s forwards;
            animation-delay: 1s;
            z-index: 100;
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .emi-table th {
            background-color: #0b7285;
            color: white;
            text-align: center;
            padding: 4px;
            border: 1px solid #ddd;
        }
        
        .emi-table td {
            text-align: right;
            padding: 2px 4px;
            border: 1px solid #ddd;
        }
        
        .emi-table td:first-child {
            text-align: center;
        }
        
        .dark .emi-table th {
            background-color: #374151;
        }
        
        .dark .emi-table td {
            border-color: #4b5563;
        }

        /* Calendar styling for follow-up tracker */
        .calendar-day {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        
        .dark .calendar-day:hover {
            background-color: #4b5563;
        }
        
        .calendar-day.active {
            background-color: #6F2C4F;
            color: white;
        }
        
        .dark .calendar-day.active {
            background-color: #9d174d;
            color: white;
        }
        
        .calendar-day.has-events {
            font-weight: bold;
            border: 2px solid #6F2C4F;
        }
        
        .dark .calendar-day.has-events {
            border-color: #9d174d;
        }

        /* Advanced calculator styles */
        .calc-key {
            transition: all 0.2s;
        }
        
        .calc-key:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .calc-key:active {
            transform: translateY(0);
        }

        /* Rate grid styling */
        .rate-grid-cell {
            transition: all 0.2s;
        }
        
        .rate-grid-cell:hover {
            background-color: #f3f4f6;
        }
        
        .dark .rate-grid-cell:hover {
            background-color: #4b5563;
        }

        /* Modern scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        /* Quick EMI calculator */
        .quick-emi-result {
            transition: all 0.3s;
        }

        /* Custom badges */
        .badge {
            display: inline-flex;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-primary {
            background-color: #6F2C4F;
            color: white;
        }
        
        .badge-secondary {
            background-color: #36c5a1;
            color: white;
        }
        
        .badge-warning {
            background-color: #fbbf24;
            color: #1f2937;
        }
        
        .badge-danger {
            background-color: #ef4444;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-200 font-tahoma">
    <div class="container mx-auto px-4 py-4 max-w-6xl" id="printableArea">
        <h1 class="text-3xl font-bold text-center text-primary dark:text-white mb-4">Customer Eligibility Check</h1>
                
        <!-- Main Tab Navigation -->
        <div class="mb-6 overflow-hidden">
            <div class="tab-navigation bg-white dark:bg-gray-800 rounded-t-lg shadow-md border-t-4 border-primary flex overflow-x-auto">
                <button id="mainCalculatorTab" class="tab-button active flex items-center justify-center p-4 border-b-4 border-primary text-primary dark:text-white font-semibold">
                    <i class="fas fa-calculator mr-2"></i> <span class="hidden sm:inline">Calculator</span>
                </button>
                <button id="followUpTrackerTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-calendar-check mr-2"></i> <span class="hidden sm:inline">Follow-up</span>
                </button>
                <button id="emiChartTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-chart-bar mr-2"></i> <span class="hidden sm:inline">EMI Chart</span>
                </button>
                <button id="loanComparisonTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-balance-scale mr-2"></i> <span class="hidden sm:inline">Comparison</span>
                </button>
                <button id="shareTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-share-alt mr-2"></i> <span class="hidden sm:inline">Share</span>
                </button>
                <button id="advCalcTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-tools mr-2"></i> <span class="hidden sm:inline">Adv. Calc</span>
                </button>
                <button id="rateGridTab" class="tab-button flex items-center justify-center p-4 border-b-4 border-transparent hover:text-primary dark:hover:text-white font-semibold">
                    <i class="fas fa-table mr-2"></i> <span class="hidden sm:inline">Rate Grid</span>
                </button>
            </div>
        </div>
        
        <!-- Menu Section -->
        <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-primary">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-primary dark:text-white">MENU</h2>
                <!-- Theme toggle moved to menu -->
                <div class="flex items-center">
                    <span class="mr-2 text-gray-700 dark:text-gray-300 text-sm md:text-base">Light</span>
                    <label class="toggle-switch mx-2">
                        <input type="checkbox" id="themeToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span class="ml-2 text-gray-700 dark:text-gray-300 text-sm md:text-base">Dark</span>
                </div>
            </div>
            
            <!-- WhatsApp Input and Button Group -->
            <div class="flex items-center justify-center mb-4">
                <div class="flex items-center w-full md:w-3/4 lg:w-1/2">
                    <input type="tel" id="whatsappNumber" placeholder="Enter WhatsApp number" class="border rounded-l-md p-2 text-base dark:bg-gray-800 dark:text-white flex-grow">
                    <button id="sendWhatsAppBtn" class="bg-green-600 text-white px-3 py-2 rounded-r-md hover:bg-opacity-80">
                        <i class="fab fa-whatsapp"></i>
                    </button>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="flex flex-wrap justify-center gap-3">
                <a href="https://script.google.com/macros/s/AKfycbyt6zvvO5POe2jMnyaR2bJOPu09L2f2Rr3Aeh72_APIR1C-6JVzSDOZvGfi4ZOZbQL0/exec" class="action-pill bg-gradient-to-r from-yellow-400 to-yellow-500 text-white py-2 px-4 rounded-full flex items-center hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-chart-line mr-2"></i> Analytics
                </a>
                <button id="quickEmiCalcBtn" class="action-pill bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-2 px-4 rounded-full flex items-center hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-calculator mr-2"></i> Quick EMI
                </button>
                <button id="reminderBtn" class="action-pill bg-gradient-to-r from-green-500 to-teal-500 text-white py-2 px-4 rounded-full flex items-center hover:shadow-lg transition-all duration-300">
                    <i class="fas fa-bell mr-2"></i> Reminders
                </button>
            </div>
        </div>
        
        <!-- Tab Content Sections -->
        
        <!-- Main Calculator Tab Content -->
        <div id="mainCalculatorTabContent" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Left Column - DBR Calculator -->
                <div id="dbrCalculator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                    <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">DBR CALCULATOR</h2>
                    
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Salary (AED):</label>
                            <input type="number" id="salary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <!-- Add-back section -->
                        <div id="addbacks-container">
                            <div class="grid grid-cols-3 gap-3 items-center addback-entry">
                                <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back:</label>
                                <div class="col-span-2">
                                    <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                                        <option value="">Select Add-back Type</option>
                                        <option value="hra">HRA</option>
                                        <option value="airfare">Airfare Allowance</option>
                                        <option value="overtime">Over-time</option>
                                        <option value="servicecharge">Service Charge</option>
                                        <option value="incentives">Incentives</option>
                                        <option value="telephone">Telephone Allowance</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dynamic-addback-fields"></div>
                        
                        <div class="flex justify-start gap-2 mb-3">
                            <button id="addMoreAddbackBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80">+ Add More</button>
                            <button id="removeAddbackBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 disabled:opacity-50" disabled>- Remove</button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Gross Salary:</label>
                            <input type="text" id="grossSalary" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Allowed Liability:</label>
                            <input type="text" id="allowedLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">DBR %:</label>
                            <div class="col-span-2 flex items-center">
                                <input type="text" id="dbrPercentage" class="border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                            </div>
                        </div>
                        
                        <button id="addExistingLoanBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 w-full">+ Existing Loans</button>
                        
                        <!-- Existing Loans Container -->
                        <div id="existingLoansContainer" class="mt-2 space-y-2 hidden"></div>

                        <!-- Credit Cards Section -->
                        <div id="creditCardsContainer">
                            <div class="credit-card-entry mb-3">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="text-gray-700 dark:text-gray-300 font-medium">Credit Card 1:</label>
                                    <button class="settle-card-btn bg-primary text-white px-4 py-1 rounded hover:bg-opacity-80">Settle</button>
                                </div>
                                <div class="grid grid-cols-4 gap-2">
                                    <select class="card-bank-select border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                                        <option value="ADCB">ADCB</option>
                                        <option value="ENBD">ENBD</option>
                                        <option value="EIB">EIB</option>
                                        <option value="FAB">FAB</option>
                                        <option value="ADIB">ADIB</option>
                                        <option value="CBD">CBD</option>
                                        <option value="HSBC">HSBC</option>
                                        <option value="CITI">CITI</option>
                                        <option value="SCB">SCB</option>
                                        <option value="MASHREQ">MASHREQ</option>
                                        <option value="DIB">DIB</option>
                                        <option value="OTHER">OTHER</option>
                                    </select>
                                    <input type="number" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                                    <input type="number" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-2">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            <button id="addCreditCardBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80">+ Add Card</button>
                            <button id="removeCreditCardBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 disabled:opacity-50" disabled>- Remove Card</button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total CC Limit:</label>
                            <input type="text" id="totalCCLimit" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">DBR Of Credit Card:</label>
                            <div class="col-span-2 flex items-center">
                                <input type="text" id="dbrCC" class="border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white flex-grow" readonly>
                                <div class="ml-2 flex items-center">
                                    <span class="text-gray-700 dark:text-gray-300 text-sm mr-1">3%</span>
                                    <label class="toggle-switch mx-1" style="width: 40px; height: 20px;">
                                        <input type="checkbox" id="dbrRateToggle">
                                        <span class="toggle-slider" style="border-radius: 20px;"></span>
                                    </label>
                                    <span class="text-gray-700 dark:text-gray-300 text-sm ml-1">5%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Liabilities:</label>
                            <input type="text" id="totalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Available Liability:</label>
                            <input type="text" id="availableLiability" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">New Total Liabilities:</label>
                            <input type="text" id="newTotalLiabilities" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Special Note:</label>
                            <textarea id="specialNote" class="col-span-2 w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" rows="3"></textarea>
                        </div>
                        
                        <div id="ccSuggestionContainer" class="border border-primary p-3 rounded-lg mt-3 hidden">
                            <h3 class="text-lg font-bold text-primary mb-2">CREDIT CARD SUGGESTION</h3>
                            <p id="ccSuggestionText" class="text-gray-700 dark:text-gray-300"></p>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column - EMI Calculator -->
                <div id="emiCalculator" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                    <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">EMI CALCULATOR</h2>
                    
                    <div class="space-y-3">
                        <!-- Customer Profile Management -->
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Customer Name:</label>
                            <input type="text" id="customerName" placeholder="Enter customer name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Saved Profiles:</label>
                            <select id="savedProfiles" class="border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                                <option value="">Select a profile</option>
                            </select>
                            <div class="flex gap-1">
                                <button id="retrieveProfileBtn" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80 flex items-center justify-center">
                                    <i class="fas fa-download mr-1"></i>
                                </button>
                                <button id="deleteProfileBtn" class="bg-red-500 text-white p-2 rounded-md hover:bg-opacity-80 flex items-center justify-center">
                                    <i class="fas fa-trash-alt mr-1"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Type:</label>
                            <select id="loanType" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                                <option value="fresh-0-30">Fresh (0-30 days)</option>
                                <option value="fresh-30-60">Fresh (30-60 days)</option>
                                <option value="topup-0-30">Top-up (0-30 days)</option>
                                <option value="topup-30-60">Top-up (30-60 days)</option>
                                <option value="takeover-60-90">Take over (60-90 days)</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Disbursal Date:</label>
                            <input type="date" id="disbursalDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">First Payment Date:</label>
                            <input type="date" id="firstPaymentDate" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <p id="dateError" class="col-span-3 text-red-600 dark:text-red-400 text-sm hidden">Error: Invalid Payment Date</p>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Days Between:</label>
                            <input type="text" id="daysBetween" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Multiples Of Salary:</label>
                            <input type="number" id="multiplesOfSalary" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="15">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Max Loan Eligibility (AED):</label>
                            <input type="text" id="maxLoanEligibility" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure:</label>
                            <input type="number" id="tenureMonths" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="48" min="1" max="300">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                            <div class="col-span-2">
                                <input type="number" id="loanAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                                <p id="loanAmountError" class="text-red-600 dark:text-red-400 text-sm hidden">Error: Loan Amount Will Exceed DBR Limit!</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate %:</label>
                            <input type="number" id="reducingRate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" value="10">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Flat Rate %:</label>
                            <input type="text" id="flatRate" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                            <input type="text" id="emi" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Payment (AED):</label>
                            <input type="text" id="totalPayment" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                            <input type="text" id="totalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Processing Fees + VAT (AED):</label>
                            <input type="text" id="processingFees" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Outstanding:</label>
                            <input type="text" id="totalOutstanding" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Cash In Hand - NetPay (AED):</label>
                            <input type="text" id="cashInHand" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 mt-4">
                            <button id="findOptimalLoanBtn" class="bg-gradient-to-r from-primary to-secondary text-white p-3 rounded-md hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-search-dollar mr-1"></i> Optimal
                            </button>
                            <button id="resetBtn" class="bg-gradient-to-r from-gray-500 to-gray-600 text-white p-3 rounded-md hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-redo-alt mr-1"></i> Reset
                            </button>
                            <button id="saveProfileBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-3 rounded-md hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-save mr-1"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Follow-up Tracker Tab Content -->
        <div id="followUpTrackerTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">FOLLOW-UP TRACKER</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Calendar Section -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Calendar</h3>
                        <div id="currentMonthYear" class="text-center font-bold mb-2 text-gray-700 dark:text-gray-300"></div>
                        <div class="flex justify-between items-center mb-4">
                            <button id="prevMonth" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80"><i class="fas fa-chevron-left"></i></button>
                            <button id="nextMonth" class="bg-primary text-white p-2 rounded-md hover:bg-opacity-80"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-center">
                            <div class="text-gray-500 font-medium">Su</div>
                            <div class="text-gray-500 font-medium">Mo</div>
                            <div class="text-gray-500 font-medium">Tu</div>
                            <div class="text-gray-500 font-medium">We</div>
                            <div class="text-gray-500 font-medium">Th</div>
                            <div class="text-gray-500 font-medium">Fr</div>
                            <div class="text-gray-500 font-medium">Sa</div>
                        </div>
                        <div id="calendarDays" class="grid grid-cols-7 gap-1 mt-2">
                            <!-- Calendar days will be generated here by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Add New Follow-up Section -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Add Follow-up</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Customer Name:</label>
                                <input type="text" id="followUpCustomerName" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Follow-up Date:</label>
                                <input type="date" id="followUpDate" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Type:</label>
                                <select id="followUpType" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                                    <option value="call">Call</option>
                                    <option value="meeting">Meeting</option>
                                    <option value="document">Document Collection</option>
                                    <option value="approval">Approval Follow-up</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Priority:</label>
                                <select id="followUpPriority" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Notes:</label>
                                <textarea id="followUpNotes" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" rows="3"></textarea>
                            </div>
                            <button id="addFollowUpBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                                <i class="fas fa-plus mr-1"></i> Add Follow-up
                            </button>
                        </div>
                    </div>
                    
                    <!-- Today's Follow-ups Section -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Today's Follow-ups</h3>
                        <div id="todayFollowUps" class="space-y-3">
                            <!-- Today's follow-ups will be populated by JavaScript -->
                            <div class="text-gray-500 dark:text-gray-400 text-center italic">No follow-ups for today.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Follow-up List -->
                <div class="mt-8">
                    <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Upcoming Follow-ups</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full border-collapse">
                            <thead>
                                <tr class="bg-primary text-white">
                                    <th class="border border-gray-300 p-2">Customer Name</th>
                                    <th class="border border-gray-300 p-2">Date</th>
                                    <th class="border border-gray-300 p-2">Type</th>
                                    <th class="border border-gray-300 p-2">Priority</th>
                                    <th class="border border-gray-300 p-2">Notes</th>
                                    <th class="border border-gray-300 p-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="followUpList">
                                <!-- Follow-ups will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- EMI Chart Tab Content -->
        <div id="emiChartTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">EMI PAYMENT SCHEDULE</h2>
                <div class="relative" style="height: 350px;">
                    <canvas id="emiChart"></canvas>
                </div>
                <div class="mt-6 overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-primary text-white">
                                <th class="border border-gray-300 p-2">Month</th>
                                <th class="border border-gray-300 p-2">EMI (AED)</th>
                                <th class="border border-gray-300 p-2">Principal (AED)</th>
                                <th class="border border-gray-300 p-2">Interest (AED)</th>
                                <th class="border border-gray-300 p-2">Balance (AED)</th>
                            </tr>
                        </thead>
                        <tbody id="emiScheduleBody">
                            <!-- Will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loan Comparison Tab Content -->
        <div id="loanComparisonTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">LOAN COMPARISON</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- First Bank -->
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                            <input type="text" id="bank1Name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                            <input type="number" id="bank1LoanAmount" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                            <input type="number" id="bank1Tenure" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                            <input type="number" id="bank1Rate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                            <input type="text" id="bank1EMI" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                            <input type="text" id="bank1TotalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                    </div>
                    
                    <!-- Second Bank -->
                    <div class="space-y-3">
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Bank Name:</label>
                            <input type="text" id="bank2Name" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Loan Amount (AED):</label>
                            <input type="number" id="bank2LoanAmount" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Tenure (Months):</label>
                            <input type="number" id="bank2Tenure" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Reducing Rate (%):</label>
                            <input type="number" id="bank2Rate" step="0.01" class="col-span-2 border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">EMI (AED):</label>
                            <input type="text" id="bank2EMI" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-3 items-center">
                            <label class="text-gray-700 dark:text-gray-300 font-medium">Total Interest (AED):</label>
                            <input type="text" id="bank2TotalInterest" step="0.01" class="col-span-2 border rounded-md p-2 bg-lightgray dark:bg-gray-700 dark:text-white" readonly>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-xl font-semibold text-primary dark:text-white mb-2">COMPARISON RESULT</h3>
                    <p id="comparisonResult" class="text-gray-700 dark:text-gray-300">Enter Details For Both Banks To Compare.</p>
                </div>
                
                <!-- Visual Comparison -->
                <div class="mt-6">
                    <h3 class="text-xl font-semibold text-primary dark:text-white mb-2">Visual Comparison</h3>
                    <div class="relative" style="height: 300px;">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Share Tab Content -->
        <div id="shareTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">SHARE LOAN INFORMATION</h2>
                
                <div class="flex flex-wrap gap-4 mb-6">
                    <button id="exportPdfBtn" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all duration-300 flex items-center">
                        <i class="fas fa-file-pdf mr-2"></i>Export PDF
                    </button>
                    <button id="printPageBtn" class="bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all duration-300 flex items-center">
                        <i class="fas fa-print mr-2"></i>Print Page
                    </button>
                    <button id="copyLinkBtn" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all duration-300 flex items-center">
                        <i class="fas fa-link mr-2"></i>Copy Link
                    </button>
                    <button id="emailDetailsBtn" class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white py-2 px-4 rounded-lg hover:shadow-lg transition-all duration-300 flex items-center">
                        <i class="fas fa-envelope mr-2"></i>Email Details
                    </button>
                </div>
                
                <div class="loan-info-container">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- Left column -->
                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700 w-1/2">Loan Nature/FPD:</td>
                                    <td id="shareLoanType" class="p-2"></td>
                                </tr>
    
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Tenure:</td>
                                    <td id="shareTenure" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Requested Amount (AED):</td>
                                    <td id="shareLoanAmount" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Reducing Rate:</td>
                                    <td id="shareReducingRate" class="p-2"></td>
                                </tr>
                                <tr>
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Flat Rate:</td>
                                    <td id="shareFlatRate" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Max Eligibility (AED):</td>
                                    <td id="shareMaxLoanEligibility" class="p-2"></td>
                                </tr>
                            </table>
                        </div>
                        
                        <!-- Right column -->
                        <div class="border rounded-lg overflow-hidden">
                            <table class="w-full">
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700 w-1/2">EMI (AED):</td>
                                    <td id="shareEmi" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Total Payment (AED):</td>
                                    <td id="shareTotalPayment" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Total Interest/Profit (AED):</td>
                                    <td id="shareTotalInterest" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Processing Fees + VAT (AED):</td>
                                    <td id="shareProcessingFees" class="p-2"></td>
                                </tr>
                                <tr class="border-b">
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Total Outstanding (AED):</td>
                                    <td id="shareTotalOutstanding" class="p-2"></td>
                                </tr>
                                <tr>
                                    <td class="font-bold p-2 bg-gray-50 dark:bg-gray-700">Cash in Hand(AED):</td>
                                    <td id="shareCashInHand" class="p-2"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- EMI Schedule -->
                    <h3 class="text-xl font-bold text-primary dark:text-white mb-3">EMI Payment Schedule</h3>
                    <div class="overflow-x-auto border rounded-lg">
                        <table class="w-full emi-table">
                            <thead>
                                <tr>
                                    <th>Month</th>
                                    <th>EMI (AED)</th>
                                    <th>Principal (AED)</th>
                                    <th>Interest (AED)</th>
                                    <th>Balance (AED)</th>
                                </tr>
                            </thead>
                            <tbody id="shareEmiSchedule">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Calculator Tab Content -->
        <div id="advCalcTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">ADVANCED CALCULATORS</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Early Settlement Calculator -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Early Settlement Calculator</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Loan Amount (AED):</label>
                                <input type="number" id="settlementLoanAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Original Tenure (Months):</label>
                                <input type="number" id="settlementTenure" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Reducing Rate (%):</label>
                                <input type="number" id="settlementRate" step="0.01" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Completed Months:</label>
                                <input type="number" id="completedMonths" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <button id="calculateSettlementBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                                Calculate Settlement
                            </button>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mt-3">
                                <h4 class="font-semibold text-primary dark:text-white mb-2">Settlement Amount:</h4>
                                <p id="settlementResult" class="text-gray-700 dark:text-gray-300 text-lg font-bold">AED 0.00</p>
                                <p id="settlementSavings" class="text-green-600 dark:text-green-400 mt-2">Savings: AED 0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Balloon Payment Calculator -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Balloon Payment Calculator</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Loan Amount (AED):</label>
                                <input type="number" id="balloonLoanAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Tenure (Months):</label>
                                <input type="number" id="balloonTenure" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Reducing Rate (%):</label>
                                <input type="number" id="balloonRate" step="0.01" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Balloon Payment (%):</label>
                                <input type="number" id="balloonPercentage" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <button id="calculateBalloonBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                                Calculate Payments
                            </button>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mt-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <h4 class="font-semibold text-primary dark:text-white">Regular EMI:</h4>
                                        <p id="balloonRegularEmi" class="text-gray-700 dark:text-gray-300 font-bold">AED 0.00</p>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-primary dark:text-white">Final Payment:</h4>
                                        <p id="balloonFinalPayment" class="text-gray-700 dark:text-gray-300 font-bold">AED 0.00</p>
                                    </div>
                                </div>
                                <p id="balloonSavings" class="text-green-600 dark:text-green-400 mt-2">EMI Reduction: AED 0.00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Financial Goal Calculator -->
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-primary dark:text-white mb-4">Loan Eligibility Calculator</h3>
                        <div class="space-y-3">
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Monthly Income (AED):</label>
                                <input type="number" id="eligibilityIncome" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Existing Obligations (AED):</label>
                                <input type="number" id="eligibilityObligations" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Interest Rate (%):</label>
                                <input type="number" id="eligibilityRate" step="0.01" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <div>
                                <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Tenure (Years):</label>
                                <input type="number" id="eligibilityTenure" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            </div>
                            <button id="calculateEligibilityBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                                Calculate Eligibility
                            </button>
                            <div class="bg-gray-100 dark:bg-gray-700 p-3 rounded-lg mt-3">
                                <h4 class="font-semibold text-primary dark:text-white mb-2">Loan Eligibility:</h4>
                                <p id="eligibilityResult" class="text-gray-700 dark:text-gray-300 text-lg font-bold">AED 0.00</p>
                                <p id="eligibilityEmi" class="text-gray-700 dark:text-gray-300 mt-2">Estimated EMI: AED 0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rate Grid Tab Content -->
        <div id="rateGridTabContent" class="tab-content">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border-l-4 border-primary">
                <h2 class="text-2xl font-bold text-primary dark:text-white mb-6">LOAN RATE GRID</h2>
                
                <!-- Controls for rate grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Bank:</label>
                        <select id="rateGridBank" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="adcb">ADCB</option>
                            <option value="enbd">Emirates NBD</option>
                            <option value="fab">First Abu Dhabi Bank</option>
                            <option value="adib">Abu Dhabi Islamic Bank</option>
                            <option value="cbd">Commercial Bank of Dubai</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Product Type:</label>
                        <select id="rateGridProduct" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="personal">Personal Loan</option>
                            <option value="auto">Auto Loan</option>
                            <option value="mortgage">Mortgage</option>
                            <option value="business">Business Loan</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Customer Type:</label>
                        <select id="rateGridCustomerType" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                            <option value="salaried">Salaried</option>
                            <option value="selfemployed">Self Employed</option>
                            <option value="professional">Professional</option>
                        </select>
                    </div>
                </div>
                
                <!-- Rate grid table -->
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm">
                        <thead>
                            <tr class="bg-primary text-white">
                                <th class="border border-gray-300 p-2">Loan Amount</th>
                                <th class="border border-gray-300 p-2">12 Months</th>
                                <th class="border border-gray-300 p-2">24 Months</th>
                                <th class="border border-gray-300 p-2">36 Months</th>
                                <th class="border border-gray-300 p-2">48 Months</th>
                                <th class="border border-gray-300 p-2">60 Months</th>
                            </tr>
                        </thead>
                        <tbody id="rateGridBody">
                            <!-- Rate grid will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Rate Grid Notes -->
                <div class="mt-6 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <h3 class="text-lg font-semibold text-primary dark:text-white mb-2">Notes:</h3>
                    <ul class="list-disc list-inside text-gray-700 dark:text-gray-300 space-y-1">
                        <li>Rates are indicative and subject to change based on bank's internal policies</li>
                        <li>Additional fees may apply (processing, insurance, etc.)</li>
                        <li>Actual rates may vary based on customer profile and credit score</li>
                        <li>Special rates may be available for salary transfer customers</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick EMI Calculator Modal -->
    <div id="quickEmiModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary dark:text-white">Quick EMI Calculator</h3>
                <button id="closeQuickEmiBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Loan Amount (AED):</label>
                    <input type="number" id="quickEmiAmount" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Tenure (Months):</label>
                    <input type="number" id="quickEmiTenure" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Interest Rate (%):</label>
                    <input type="number" id="quickEmiRate" step="0.01" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                </div>
                <button id="calculateQuickEmiBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                    Calculate
                </button>
                <div id="quickEmiResult" class="quick-emi-result mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-lg hidden">
                    <div class="text-center">
                        <h4 class="font-semibold text-primary dark:text-white mb-2">Monthly EMI:</h4>
                        <p id="quickEmiAmount" class="text-2xl font-bold text-primary dark:text-white">AED 0.00</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="text-center">
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Interest</h5>
                            <p id="quickEmiTotalInterest" class="font-semibold text-gray-700 dark:text-gray-300">AED 0.00</p>
                        </div>
                        <div class="text-center">
                            <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300">Total Payment</h5>
                            <p id="quickEmiTotalPayment" class="font-semibold text-gray-700 dark:text-gray-300">AED 0.00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reminders Modal -->
    <div id="remindersModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-primary dark:text-white">Set Reminders</h3>
                <button id="closeRemindersBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Reminder Type:</label>
                    <select id="reminderType" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                        <option value="call">Call customer</option>
                        <option value="document">Document collection</option>
                        <option value="payment">Payment reminder</option>
                        <option value="follow-up">General follow-up</option>
                    </select>
                </div>
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Customer Name:</label>
                    <input type="text" id="reminderCustomer" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Date & Time:</label>
                    <input type="datetime-local" id="reminderDateTime" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white">
                </div>
                <div>
                    <label class="text-gray-700 dark:text-gray-300 font-medium block mb-1">Notes:</label>
                    <textarea id="reminderNotes" class="w-full border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white" rows="3"></textarea>
                </div>
                <button id="saveReminderBtn" class="bg-primary text-white p-3 rounded-md hover:bg-opacity-80 w-full">
                    Save Reminder
                </button>
            </div>
            <div id="activeReminders" class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <h4 class="font-semibold text-primary dark:text-white mb-2">Active Reminders:</h4>
                <div class="space-y-2 max-h-40 overflow-y-auto">
                    <!-- Active reminders will be populated by JavaScript -->
                    <p class="text-gray-500 dark:text-gray-400 italic">No active reminders.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Success Indicator -->
    <div id="successIndicator" class="success-indicator hidden">
        <span id="successMessage">Operation successful!</span>
    </div>
    
    <script>
        // ==========================================
        // INITIALIZATION AND UTILITIES
        // ==========================================
        
        // Theme toggle functionality
        const themeToggle = document.getElementById('themeToggle');
        
        // Set light mode as default
        document.documentElement.classList.remove('dark');
        themeToggle.checked = false;
        
        themeToggle.addEventListener('change', function() {
            if (this.checked) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Helper function to format numbers with thousands separators
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Show success indicator
        function showSuccess(message) {
            const indicator = document.getElementById('successIndicator');
            const messageEl = document.getElementById('successMessage');
            
            messageEl.textContent = message;
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 3000);
        }
        
        // ==========================================
        // TAB MANAGEMENT
        // ==========================================
        
        // Tab functionality
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    btn.classList.remove('text-primary');
                    btn.classList.remove('dark:text-white');
                    btn.classList.add('hover:text-primary');
                    btn.classList.add('dark:hover:text-white');
                    btn.classList.remove('border-primary');
                    btn.classList.add('border-transparent');
                });
                
                // Add active class to clicked tab
                button.classList.add('active');
                button.classList.add('text-primary');
                button.classList.add('dark:text-white');
                button.classList.remove('hover:text-primary');
                button.classList.remove('dark:hover:text-white');
                button.classList.add('border-primary');
                button.classList.remove('border-transparent');
                
                // Hide all tab content
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show corresponding tab content
                const tabId = button.id.replace('Tab', 'TabContent');
                document.getElementById(tabId).classList.add('active');
                
                // Update specific tabs when selected
                if (button.id === 'emiChartTab') {
                    displayEMIChart();
                } else if (button.id === 'loanComparisonTab') {
                    updateBankComparison();
                    renderComparisonChart();
                } else if (button.id === 'shareTab') {
                    updateShareTab();
                } else if (button.id === 'rateGridTab') {
                    updateRateGrid();
                }
            });
        });
        
        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // ==========================================
            // DOM REFERENCES
            // ==========================================
            
            // DBR Calculator Elements
            const salaryInput = document.getElementById('salary');
            const grossSalaryInput = document.getElementById('grossSalary');
            const allowedLiabilityInput = document.getElementById('allowedLiability');
            const dbrPercentageInput = document.getElementById('dbrPercentage');
            const addExistingLoanBtn = document.getElementById('addExistingLoanBtn');
            const existingLoansContainer = document.getElementById('existingLoansContainer');
            const addCreditCardBtn = document.getElementById('addCreditCardBtn');
            const removeCreditCardBtn = document.getElementById('removeCreditCardBtn');
            const creditCardsContainer = document.getElementById('creditCardsContainer');
            const totalCCLimitInput = document.getElementById('totalCCLimit');
            const dbrCCInput = document.getElementById('dbrCC');
            const dbrRateToggle = document.getElementById('dbrRateToggle');
            const totalOutstandingInput = document.getElementById('totalOutstanding');
            const totalLiabilitiesInput = document.getElementById('totalLiabilities');
            const availableLiabilityInput = document.getElementById('availableLiability');
            const newTotalLiabilitiesInput = document.getElementById('newTotalLiabilities');
            const specialNote = document.getElementById('specialNote');
            const ccSuggestionContainer = document.getElementById('ccSuggestionContainer');
            const ccSuggestionText = document.getElementById('ccSuggestionText');
            const dbrCalculatorSection = document.getElementById('dbrCalculator');
            
            // EMI Calculator Elements
            const customerNameInput = document.getElementById('customerName');
            const savedProfilesSelect = document.getElementById('savedProfiles');
            const retrieveProfileBtn = document.getElementById('retrieveProfileBtn');
            const deleteProfileBtn = document.getElementById('deleteProfileBtn');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const loanTypeSelect = document.getElementById('loanType');
            const multiplesOfSalaryInput = document.getElementById('multiplesOfSalary');
            const maxLoanEligibilityInput = document.getElementById('maxLoanEligibility');
            const tenureMonthsInput = document.getElementById('tenureMonths');
            const loanAmountInput = document.getElementById('loanAmount');
            const loanAmountError = document.getElementById('loanAmountError');
            const reducingRateInput = document.getElementById('reducingRate');
            const flatRateInput = document.getElementById('flatRate');
            const emiInput = document.getElementById('emi');
            const totalPaymentInput = document.getElementById('totalPayment');
            const totalInterestInput = document.getElementById('totalInterest');
            const processingFeesInput = document.getElementById('processingFees');
            const cashInHandInput = document.getElementById('cashInHand');
            const findOptimalLoanBtn = document.getElementById('findOptimalLoanBtn');
            const resetBtn = document.getElementById('resetBtn');
            const disbursalDateInput = document.getElementById('disbursalDate');
            const firstPaymentDateInput = document.getElementById('firstPaymentDate');
            const daysBetweenInput = document.getElementById('daysBetween');
            const dateErrorMsg = document.getElementById('dateError');
            const emiCalculatorSection = document.getElementById('emiCalculator');
            
            // Quick EMI Calculator Elements
            const quickEmiCalcBtn = document.getElementById('quickEmiCalcBtn');
            const quickEmiModal = document.getElementById('quickEmiModal');
            const closeQuickEmiBtn = document.getElementById('closeQuickEmiBtn');
            const calculateQuickEmiBtn = document.getElementById('calculateQuickEmiBtn');
            const quickEmiAmountInput = document.getElementById('quickEmiAmount');
            const quickEmiTenureInput = document.getElementById('quickEmiTenure');
            const quickEmiRateInput = document.getElementById('quickEmiRate');
            const quickEmiResult = document.getElementById('quickEmiResult');
            
            // Reminders Elements
            const reminderBtn = document.getElementById('reminderBtn');
            const remindersModal = document.getElementById('remindersModal');
            const closeRemindersBtn = document.getElementById('closeRemindersBtn');
            const saveReminderBtn = document.getElementById('saveReminderBtn');
            
            // Chart & Other Elements
            const emiChartTab = document.getElementById('emiChartTab');
            const sendWhatsAppBtn = document.getElementById('sendWhatsAppBtn');
            const whatsappNumberInput = document.getElementById('whatsappNumber');
            const addbacksContainer = document.getElementById('addbacks-container');
            const dynamicAddbackFields = document.querySelector('.dynamic-addback-fields');
            const addMoreAddbackBtn = document.getElementById('addMoreAddbackBtn');
            const removeAddbackBtn = document.getElementById('removeAddbackBtn');
            
            // Share Tab Elements
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const printPageBtn = document.getElementById('printPageBtn');
            const shareTab = document.getElementById('shareTab');
            
            // Bank comparison inputs
            const bank1NameInput = document.getElementById('bank1Name');
            const bank1LoanAmountInput = document.getElementById('bank1LoanAmount');
            const bank1TenureInput = document.getElementById('bank1Tenure');
            const bank1RateInput = document.getElementById('bank1Rate');
            const bank1EMIInput = document.getElementById('bank1EMI');
            const bank1TotalInterestInput = document.getElementById('bank1TotalInterest');
            const bank2NameInput = document.getElementById('bank2Name');
            const bank2LoanAmountInput = document.getElementById('bank2LoanAmount');
            const bank2TenureInput = document.getElementById('bank2Tenure');
            const bank2RateInput = document.getElementById('bank2Rate');
            const bank2EMIInput = document.getElementById('bank2EMI');
            const bank2TotalInterestInput = document.getElementById('bank2TotalInterest');
            const comparisonResultText = document.getElementById('comparisonResult');
            
            // Advanced Calculator Elements
            const calculateSettlementBtn = document.getElementById('calculateSettlementBtn');
            const calculateBalloonBtn = document.getElementById('calculateBalloonBtn');
            const calculateEligibilityBtn = document.getElementById('calculateEligibilityBtn');
            
            // Rate Grid Elements
            const rateGridBank = document.getElementById('rateGridBank');
            const rateGridProduct = document.getElementById('rateGridProduct');
            const rateGridCustomerType = document.getElementById('rateGridCustomerType');
            
            // EMI Chart variables
            let emiChart = null;
            let existingLoanCount = 0;
            
            // Set current date for date inputs
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            disbursalDateInput.value = formattedDate;
            
            // Add one month to today's date for first payment date
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            firstPaymentDateInput.value = nextMonth.toISOString().split('T')[0];
            
            // Update days between dates
            updateDaysBetween();
            
            // Add-back related variables
            let addbackCount = 1;
            let addbackData = {};
            
            // Track settled credit cards and loans
            let settledCards = new Set();
            let settledLoans = new Set();
            
            // Set DBR CC rate toggle to default 3%
            dbrRateToggle.checked = false;
            
            // Initialize calendar for follow-up tracker
            initializeCalendar();
            
            // Initialize rate grid
            updateRateGrid();
            
            // ==========================================
            // QUICK EMI CALCULATOR FUNCTIONS
            // ==========================================
            
            // Open Quick EMI Calculator Modal
            quickEmiCalcBtn.addEventListener('click', function() {
                quickEmiModal.classList.remove('hidden');
                
                // Pre-fill with values from main calculator if available
                const mainLoanAmount = loanAmountInput.value;
                const mainTenure = tenureMonthsInput.value;
                const mainRate = reducingRateInput.value;
                
                if (mainLoanAmount) quickEmiAmountInput.value = mainLoanAmount;
                if (mainTenure) quickEmiTenureInput.value = mainTenure;
                if (mainRate) quickEmiRateInput.value = mainRate;
            });
            
            // Close Quick EMI Calculator Modal
            closeQuickEmiBtn.addEventListener('click', function() {
                quickEmiModal.classList.add('hidden');
            });
            
            // Calculate Quick EMI
            calculateQuickEmiBtn.addEventListener('click', function() {
                const loanAmount = parseFloat(quickEmiAmountInput.value) || 0;
                const tenure = parseInt(quickEmiTenureInput.value) || 0;
                const rate = parseFloat(quickEmiRateInput.value) || 0;
                
                if (loanAmount <= 0 || tenure <= 0 || rate <= 0) {
                    showSuccess('Please enter valid loan amount, tenure and rate.');
                    return;
                }
                
                const monthlyRate = rate / 12 / 100;
                const emi = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                const totalPayment = emi * tenure;
                const totalInterest = totalPayment - loanAmount;
                
                // Display result
                quickEmiResult.classList.remove('hidden');
                document.getElementById('quickEmiAmount').textContent = 'AED ' + formatNumber(emi.toFixed(2));
                document.getElementById('quickEmiTotalInterest').textContent = 'AED ' + formatNumber(totalInterest.toFixed(2));
                document.getElementById('quickEmiTotalPayment').textContent = 'AED ' + formatNumber(totalPayment.toFixed(2));
            });
            
            // ==========================================
            // REMINDERS FUNCTIONS
            // ==========================================
            
            // Open Reminders Modal
            reminderBtn.addEventListener('click', function() {
                remindersModal.classList.remove('hidden');
                loadReminders();
            });
            
            // Close Reminders Modal
            closeRemindersBtn.addEventListener('click', function() {
                remindersModal.classList.add('hidden');
            });
            
            // Save Reminder
            saveReminderBtn.addEventListener('click', function() {
                const type = document.getElementById('reminderType').value;
                const customer = document.getElementById('reminderCustomer').value.trim();
                const dateTime = document.getElementById('reminderDateTime').value;
                const notes = document.getElementById('reminderNotes').value.trim();
                
                if (!customer || !dateTime) {
                    showSuccess('Please enter customer name and date/time.');
                    return;
                }
                
                // Create reminder object
                const reminder = {
                    type,
                    customer,
                    dateTime,
                    notes,
                    created: new Date().toISOString()
                };
                
                // Save to localStorage
                const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
                reminders.push(reminder);
                localStorage.setItem('reminders', JSON.stringify(reminders));
                
                showSuccess('Reminder saved successfully!');
                
                // Clear form
                document.getElementById('reminderCustomer').value = '';
                document.getElementById('reminderNotes').value = '';
                
                // Reload reminders list
                loadReminders();
            });
            
            // Load Reminders
            function loadReminders() {
                const remindersContainer = document.getElementById('activeReminders').querySelector('div');
                const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
                
                if (reminders.length === 0) {
                    remindersContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No active reminders.</p>';
                    return;
                }
                
                // Sort reminders by date
                reminders.sort((a, b) => new Date(a.dateTime) - new Date(b.dateTime));
                
                // Create HTML for each reminder
                let html = '';
                for (let i = 0; i < Math.min(reminders.length, 5); i++) {
                    const reminder = reminders[i];
                    const date = new Date(reminder.dateTime);
                    
                    let typeIcon = '';
                    switch (reminder.type) {
                        case 'call': typeIcon = 'fa-phone'; break;
                        case 'document': typeIcon = 'fa-file-alt'; break;
                        case 'payment': typeIcon = 'fa-money-bill'; break;
                        case 'follow-up': typeIcon = 'fa-clipboard-check'; break;
                    }
                    
                    html += `
                        <div class="p-2 bg-gray-50 dark:bg-gray-700 rounded flex items-center">
                            <div class="flex-shrink-0 mr-2">
                                <i class="fas ${typeIcon} text-primary"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-medium text-gray-700 dark:text-gray-300">${reminder.customer}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">
                                    ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </p>
                            </div>
                            <button class="delete-reminder bg-red-500 text-white p-1 rounded" data-index="${i}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                }
                
                remindersContainer.innerHTML = html;
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-reminder').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        reminders.splice(index, 1);
                        localStorage.setItem('reminders', JSON.stringify(reminders));
                        loadReminders();
                        showSuccess('Reminder removed.');
                    });
                });
            }
            
            // ==========================================
            // CALENDAR FUNCTIONS
            // ==========================================
            
            // Initialize Calendar
            function initializeCalendar() {
                const currentMonthYear = document.getElementById('currentMonthYear');
                const calendarDays = document.getElementById('calendarDays');
                const prevMonth = document.getElementById('prevMonth');
                const nextMonth = document.getElementById('nextMonth');
                
                let currentDate = new Date();
                
                // Update calendar
                function updateCalendar() {
                    const year = currentDate.getFullYear();
                    const month = currentDate.getMonth();
                    
                    // Update month/year display
                    currentMonthYear.textContent = new Date(year, month, 1).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    // Clear previous days
                    calendarDays.innerHTML = '';
                    
                    // Get first day of month and total days
                    const firstDay = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    // Get follow-ups data
                    const followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                    
                    // Create empty cells for days before first day of month
                    for (let i = 0; i < firstDay; i++) {
                        const emptyCell = document.createElement('div');
                        calendarDays.appendChild(emptyCell);
                    }
                    
                    // Create cells for each day of the month
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayCell = document.createElement('div');
                        dayCell.classList.add('calendar-day');
                        dayCell.textContent = day;
                        
                        // Check if current day
                        const today = new Date();
                        if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                            dayCell.classList.add('bg-gray-200', 'dark:bg-gray-600', 'font-bold');
                        }
                        
                        // Check if day has follow-ups
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const hasFollowUps = followUps.some(followUp => followUp.date.startsWith(dateString));
                        if (hasFollowUps) {
                            dayCell.classList.add('has-events');
                        }
                        
                        // Add click event
                        dayCell.addEventListener('click', () => {
                            // Remove active class from all days
                            document.querySelectorAll('.calendar-day').forEach(cell => {
                                cell.classList.remove('active');
                            });
                            
                            // Add active class to clicked day
                            dayCell.classList.add('active');
                            
                            // Update follow-up date field
                            const selectedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            document.getElementById('followUpDate').value = selectedDate;
                            
                            // Display follow-ups for the selected day
                            displayFollowUpsForDate(selectedDate);
                        });
                        
                        calendarDays.appendChild(dayCell);
                    }
                }
                
                // Display follow-ups for a specific date
                function displayFollowUpsForDate(dateString) {
                    const followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                    const todayFollowUpsContainer = document.getElementById('todayFollowUps');
                    
                    // Filter follow-ups for the selected date
                    const dateFollowUps = followUps.filter(followUp => followUp.date.startsWith(dateString));
                    
                    if (dateFollowUps.length === 0) {
                        todayFollowUpsContainer.innerHTML = '<div class="text-gray-500 dark:text-gray-400 text-center italic">No follow-ups for this day.</div>';
                        return;
                    }
                    
                    // Create HTML for each follow-up
                    let html = '';
                    for (const followUp of dateFollowUps) {
                        // Create badge based on priority
                        let priorityBadge = '';
                        switch (followUp.priority) {
                            case 'low':
                                priorityBadge = '<span class="badge badge-secondary">Low</span>';
                                break;
                            case 'medium':
                                priorityBadge = '<span class="badge badge-warning">Medium</span>';
                                break;
                            case 'high':
                                priorityBadge = '<span class="badge badge-danger">High</span>';
                                break;
                        }
                        
                        html += `
                            <div class="p-3 bg-white dark:bg-gray-700 rounded-lg shadow-sm">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h4 class="font-semibold text-gray-700 dark:text-gray-200">${followUp.customerName}</h4>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${followUp.type} ${priorityBadge}</p>
                                    </div>
                                    <button class="complete-followup bg-primary text-white px-2 py-1 rounded text-xs" data-id="${followUp.id}">Complete</button>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-300 mt-2">${followUp.notes}</p>
                            </div>
                        `;
                    }
                    
                    todayFollowUpsContainer.innerHTML = html;
                    
                    // Add event listeners to complete buttons
                    document.querySelectorAll('.complete-followup').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            completeFollowUp(id);
                        });
                    });
                }
                
                // Complete a follow-up
                function completeFollowUp(id) {
                    let followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                    
                    // Find the follow-up index
                    const index = followUps.findIndex(followUp => followUp.id === id);
                    
                    if (index !== -1) {
                        // Remove the follow-up
                        followUps.splice(index, 1);
                        localStorage.setItem('followUps', JSON.stringify(followUps));
                        
                        // Update calendar
                        updateCalendar();
                        
                        // Update follow-ups list
                        loadFollowUpsList();
                        
                        // Show success message
                        showSuccess('Follow-up marked as complete!');
                        
                        // Display today's follow-ups
                        const today = new Date();
                        const dateString = today.toISOString().split('T')[0];
                        displayFollowUpsForDate(dateString);
                    }
                }
                
                // Navigate to previous month
                prevMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    updateCalendar();
                });
                
                // Navigate to next month
                nextMonth.addEventListener('click', () => {
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    updateCalendar();
                });
                
                // Add follow-up
                document.getElementById('addFollowUpBtn').addEventListener('click', function() {
                    const customerName = document.getElementById('followUpCustomerName').value.trim();
                    const date = document.getElementById('followUpDate').value;
                    const type = document.getElementById('followUpType').value;
                    const priority = document.getElementById('followUpPriority').value;
                    const notes = document.getElementById('followUpNotes').value.trim();
                    
                    if (!customerName || !date) {
                        showSuccess('Please enter customer name and date.');
                        return;
                    }
                    
                    // Create follow-up object
                    const followUp = {
                        id: Date.now().toString(), // Unique ID
                        customerName,
                        date,
                        type,
                        priority,
                        notes,
                        created: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    const followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                    followUps.push(followUp);
                    localStorage.setItem('followUps', JSON.stringify(followUps));
                    
                    showSuccess('Follow-up added successfully!');
                    
                    // Clear form
                    document.getElementById('followUpCustomerName').value = '';
                    document.getElementById('followUpNotes').value = '';
                    
                    // Update calendar
                    updateCalendar();
                    
                    // Update follow-ups list
                    loadFollowUpsList();
                    
                    // Display follow-ups for the selected date
                    displayFollowUpsForDate(date);
                });
                
                // Load follow-ups list
                function loadFollowUpsList() {
                    const followUpList = document.getElementById('followUpList');
                    const followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                    
                    if (followUps.length === 0) {
                        followUpList.innerHTML = '<tr><td colspan="6" class="border border-gray-300 p-2 text-center text-gray-500">No upcoming follow-ups.</td></tr>';
                        return;
                    }
                    
                    // Sort follow-ups by date
                    followUps.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Create table rows
                    let html = '';
                    for (const followUp of followUps) {
                        // Format date
                        const date = new Date(followUp.date);
                        const formattedDate = date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
                        
                        // Set priority class
                        let priorityClass = '';
                        switch (followUp.priority) {
                            case 'low': priorityClass = 'text-blue-600 dark:text-blue-400'; break;
                            case 'medium': priorityClass = 'text-yellow-600 dark:text-yellow-400'; break;
                            case 'high': priorityClass = 'text-red-600 dark:text-red-400'; break;
                        }
                        
                        html += `
                            <tr>
                                <td class="border border-gray-300 p-2">${followUp.customerName}</td>
                                <td class="border border-gray-300 p-2">${formattedDate}</td>
                                <td class="border border-gray-300 p-2">${followUp.type}</td>
                                <td class="border border-gray-300 p-2 ${priorityClass} font-semibold">${followUp.priority}</td>
                                <td class="border border-gray-300 p-2">${followUp.notes}</td>
                                <td class="border border-gray-300 p-2">
                                    <div class="flex gap-1">
                                        <button class="complete-followup-list bg-green-500 text-white p-1 rounded" data-id="${followUp.id}">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="edit-followup bg-blue-500 text-white p-1 rounded" data-id="${followUp.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="delete-followup bg-red-500 text-white p-1 rounded" data-id="${followUp.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                    
                    followUpList.innerHTML = html;
                    
                    // Add event listeners to buttons
                    document.querySelectorAll('.complete-followup-list').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            completeFollowUp(id);
                        });
                    });
                    
                    document.querySelectorAll('.delete-followup').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            
                            if (confirm('Are you sure you want to delete this follow-up?')) {
                                let followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                                const index = followUps.findIndex(followUp => followUp.id === id);
                                
                                if (index !== -1) {
                                    followUps.splice(index, 1);
                                    localStorage.setItem('followUps', JSON.stringify(followUps));
                                    loadFollowUpsList();
                                    updateCalendar();
                                    showSuccess('Follow-up deleted successfully!');
                                }
                            }
                        });
                    });
                    
                    document.querySelectorAll('.edit-followup').forEach(button => {
                        button.addEventListener('click', function() {
                            const id = this.getAttribute('data-id');
                            const followUps = JSON.parse(localStorage.getItem('followUps')) || [];
                            const followUp = followUps.find(followUp => followUp.id === id);
                            
                            if (followUp) {
                                // Populate form with follow-up data
                                document.getElementById('followUpCustomerName').value = followUp.customerName;
                                document.getElementById('followUpDate').value = followUp.date;
                                document.getElementById('followUpType').value = followUp.type;
                                document.getElementById('followUpPriority').value = followUp.priority;
                                document.getElementById('followUpNotes').value = followUp.notes;
                                
                                // Scroll to form
                                document.getElementById('followUpCustomerName').scrollIntoView({ behavior: 'smooth' });
                            }
                        });
                    });
                }
                
                // Initialize calendar and load follow-ups
                updateCalendar();
                loadFollowUpsList();
                
                // Show today's follow-ups initially
                const today = new Date();
                const dateString = today.toISOString().split('T')[0];
                displayFollowUpsForDate(dateString);
            }
            
            // ==========================================
            // ADVANCED CALCULATOR FUNCTIONS
            // ==========================================
            
            // Early Settlement Calculator
            calculateSettlementBtn.addEventListener('click', function() {
                const loanAmount = parseFloat(document.getElementById('settlementLoanAmount').value) || 0;
                const originalTenure = parseInt(document.getElementById('settlementTenure').value) || 0;
                const rate = parseFloat(document.getElementById('settlementRate').value) || 0;
                const completedMonths = parseInt(document.getElementById('completedMonths').value) || 0;
                
                if (loanAmount <= 0 || originalTenure <= 0 || rate <= 0 || completedMonths <= 0 || completedMonths >= originalTenure) {
                    showSuccess('Please enter valid loan details and ensure completed months is less than the original tenure.');
                    return;
                }
                
                // Calculate standard EMI
                const monthlyRate = rate / 12 / 100;
                const emi = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, originalTenure) / (Math.pow(1 + monthlyRate, originalTenure) - 1);
                
                // Calculate remaining principal
                let remainingPrincipal = loanAmount;
                for (let i = 1; i <= completedMonths; i++) {
                    const interestForMonth = remainingPrincipal * monthlyRate;
                    const principalForMonth = emi - interestForMonth;
                    remainingPrincipal -= principalForMonth;
                }
                
                // Calculate total if paid regularly
                const regularPaymentsRemaining = emi * (originalTenure - completedMonths);
                
                // Add 1% early settlement fee
                const settlementFee = remainingPrincipal * 0.01;
                const settlementAmount = remainingPrincipal + settlementFee;
                
                // Calculate savings
                const savings = regularPaymentsRemaining - settlementAmount;
                
                // Display results
                document.getElementById('settlementResult').textContent = 'AED ' + formatNumber(settlementAmount.toFixed(2));
                document.getElementById('settlementSavings').textContent = 'Savings: AED ' + formatNumber(savings.toFixed(2));
            });
            
            // Balloon Payment Calculator
            calculateBalloonBtn.addEventListener('click', function() {
                const loanAmount = parseFloat(document.getElementById('balloonLoanAmount').value) || 0;
                const tenure = parseInt(document.getElementById('balloonTenure').value) || 0;
                const rate = parseFloat(document.getElementById('balloonRate').value) || 0;
                const balloonPercentage = parseFloat(document.getElementById('balloonPercentage').value) || 0;
                
                if (loanAmount <= 0 || tenure <= 0 || rate <= 0 || balloonPercentage <= 0 || balloonPercentage >= 100) {
                    showSuccess('Please enter valid loan details and ensure balloon percentage is between 1 and 99.');
                    return;
                }
                
                // Calculate balloon amount
                const balloonAmount = loanAmount * (balloonPercentage / 100);
                
                // Calculate loan amount excluding balloon
                const reducedLoanAmount = loanAmount - balloonAmount;
                
                // Calculate standard EMI without balloon
                const monthlyRate = rate / 12 / 100;
                const standardEmi = loanAmount * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                
                // Calculate EMI with balloon
                const reducedEmi = reducedLoanAmount * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                
                // Calculate final payment (balloon + last EMI)
                const finalPayment = balloonAmount + reducedEmi;
                
                // Calculate EMI reduction
                const emiReduction = standardEmi - reducedEmi;
                
                // Display results
                document.getElementById('balloonRegularEmi').textContent = 'AED ' + formatNumber(reducedEmi.toFixed(2));
                document.getElementById('balloonFinalPayment').textContent = 'AED ' + formatNumber(finalPayment.toFixed(2));
                document.getElementById('balloonSavings').textContent = 'EMI Reduction: AED ' + formatNumber(emiReduction.toFixed(2));
            });
            
            // Loan Eligibility Calculator
            calculateEligibilityBtn.addEventListener('click', function() {
                const income = parseFloat(document.getElementById('eligibilityIncome').value) || 0;
                const obligations = parseFloat(document.getElementById('eligibilityObligations').value) || 0;
                const rate = parseFloat(document.getElementById('eligibilityRate').value) || 0;
                const tenure = parseInt(document.getElementById('eligibilityTenure').value) || 0;
                
                if (income <= 0 || rate <= 0 || tenure <= 0) {
                    showSuccess('Please enter valid income, rate and tenure.');
                    return;
                }
                
                // Calculate available income for EMI (50% DBR)
                const availableForEmi = (income * 0.5) - obligations;
                
                if (availableForEmi <= 0) {
                    document.getElementById('eligibilityResult').textContent = 'AED 0.00';
                    document.getElementById('eligibilityEmi').textContent = 'Your current obligations exceed 50% of your income.';
                    return;
                }
                
                // Convert tenure to months
                const tenureMonths = tenure * 12;
                
                // Calculate monthly rate
                const monthlyRate = rate / 12 / 100;
                
                // Calculate loan eligibility
                const eligibility = availableForEmi * ((Math.pow(1 + monthlyRate, tenureMonths) - 1) / (monthlyRate * Math.pow(1 + monthlyRate, tenureMonths)));
                
                // Display results
                document.getElementById('eligibilityResult').textContent = 'AED ' + formatNumber(eligibility.toFixed(2));
                document.getElementById('eligibilityEmi').textContent = 'Estimated EMI: AED ' + formatNumber(availableForEmi.toFixed(2));
            });
            
            // ==========================================
            // RATE GRID FUNCTIONS
            // ==========================================
            
            // Update rate grid
            function updateRateGrid() {
                const bank = rateGridBank.value;
                const product = rateGridProduct.value;
                const customerType = rateGridCustomerType.value;
                
                // This would normally fetch from an API or database
                // Here we'll use a simple sample data structure
                const rateGridData = generateRateGridData(bank, product, customerType);
                
                const rateGridBody = document.getElementById('rateGridBody');
                rateGridBody.innerHTML = '';
                
                // Create rows for each loan amount range
                for (const row of rateGridData) {
                    const tr = document.createElement('tr');
                    tr.classList.add('rate-grid-cell');
                    
                    // Create cell for loan amount
                    const tdAmount = document.createElement('td');
                    tdAmount.classList.add('border', 'border-gray-300', 'p-2', 'font-medium');
                    tdAmount.textContent = row.amount;
                    tr.appendChild(tdAmount);
                    
                    // Create cells for each tenure
                    for (const rate of row.rates) {
                        const td = document.createElement('td');
                        td.classList.add('border', 'border-gray-300', 'p-2', 'text-center');
                        td.textContent = rate + '%';
                        tr.appendChild(td);
                    }
                    
                    rateGridBody.appendChild(tr);
                }
            }
            
            // Generate sample rate grid data
            function generateRateGridData(bank, product, customerType) {
                // Base rates - these would typically come from a database
                let baseRates = [];
                
                // Adjust base rates based on bank and product
                if (product === 'personal') {
                    if (bank === 'adcb') {
                        baseRates = [8.99, 8.75, 8.50, 8.25, 7.99];
                    } else if (bank === 'enbd') {
                        baseRates = [9.25, 8.99, 8.75, 8.50, 8.25];
                    } else if (bank === 'fab') {
                        baseRates = [8.75, 8.50, 8.25, 7.99, 7.75];
                    } else if (bank === 'adib') {
                        baseRates = [7.99, 7.75, 7.50, 7.25, 6.99];
                    } else {
                        baseRates = [9.49, 9.25, 8.99, 8.75, 8.50];
                    }
                } else if (product === 'auto') {
                    baseRates = [6.99, 6.75, 6.50, 6.25, 5.99];
                } else if (product === 'mortgage') {
                    baseRates = [5.99, 5.75, 5.50, 5.25, 4.99];
                } else {
                    baseRates = [11.99, 11.75, 11.50, 11.25, 10.99];
                }
                
                // Adjust rates based on customer type
                let rateAdjustment = 0;
                if (customerType === 'selfemployed') {
                    rateAdjustment = 0.5;
                } else if (customerType === 'professional') {
                    rateAdjustment = -0.25;
                }
                
                // Create grid data structure
                return [
                    {
                        amount: 'Up to 50,000',
                        rates: baseRates.map(rate => (rate + rateAdjustment + 0.5).toFixed(2))
                    },
                    {
                        amount: '50,001 - 100,000',
                        rates: baseRates.map(rate => (rate + rateAdjustment + 0.25).toFixed(2))
                    },
                    {
                        amount: '100,001 - 250,000',
                        rates: baseRates.map(rate => (rate + rateAdjustment).toFixed(2))
                    },
                    {
                        amount: '250,001 - 500,000',
                        rates: baseRates.map(rate => (rate + rateAdjustment - 0.25).toFixed(2))
                    },
                    {
                        amount: 'Above 500,000',
                        rates: baseRates.map(rate => (rate + rateAdjustment - 0.5).toFixed(2))
                    }
                ];
            }
            
            // Rate grid control event listeners
            rateGridBank.addEventListener('change', updateRateGrid);
            rateGridProduct.addEventListener('change', updateRateGrid);
            rateGridCustomerType.addEventListener('change', updateRateGrid);
            
            // ==========================================
            // PROFILE MANAGEMENT
            // ==========================================
            
            // Initialize profiles and check for temporary state
            loadSavedProfiles();
            loadTemporaryState();
            
            // Save temporary state when leaving page
            window.addEventListener('beforeunload', saveTemporaryState);
            
            // Save and retrieve profile functionality
            saveProfileBtn.addEventListener('click', saveCustomerProfile);
            retrieveProfileBtn.addEventListener('click', retrieveCustomerProfile);
            deleteProfileBtn.addEventListener('click', deleteCustomerProfile);
            
            function saveCustomerProfile() {
                const customerName = customerNameInput.value.trim();
                if (!customerName) {
                    showSuccess('Please enter a customer name before saving');
                    return;
                }
                
                // Get all input values to save
                const profileData = {
                    customerName: customerName,
                    salary: salaryInput.value,
                    loanType: loanTypeSelect.value,
                    disbursalDate: disbursalDateInput.value,
                    firstPaymentDate: firstPaymentDateInput.value,
                    multiplesOfSalary: multiplesOfSalaryInput.value,
                    tenureMonths: tenureMonthsInput.value,
                    loanAmount: loanAmountInput.value,
                    reducingRate: reducingRateInput.value,
                    specialNote: specialNote.value,
                    dbrRateToggle: dbrRateToggle.checked,
                    
                    // Credit card data
                    creditCards: Array.from(document.querySelectorAll('.credit-card-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.card-bank-select').value,
                            limit: entry.querySelector('.credit-card-amount').value,
                            outstanding: entry.querySelector('.credit-card-outstanding').value,
                            settled: settledCards.has(index)
                        };
                    }),
                    
                    // Existing loans data
                    existingLoans: Array.from(document.querySelectorAll('.existing-loan-entry')).map((entry, index) => {
                        return {
                            type: entry.querySelector('.loan-type').value,
                            installment: entry.querySelector('.loan-installment').value,
                            outstanding: entry.querySelector('.loan-outstanding').value,
                            settled: settledLoans.has(index)
                        };
                    }),
                    
                    // Add-back data
                    addbackData: addbackData
                };
                
                // Save to localStorage
                try {
                    // Get existing profiles
                    const existingProfiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    
                    // Add/update this profile
                    existingProfiles[customerName] = profileData;
                    
                    // Save back to localStorage
                    localStorage.setItem('customerProfiles', JSON.stringify(existingProfiles));
                    
                    // Update dropdown and select the current profile
                    loadSavedProfiles();
                    savedProfilesSelect.value = customerName;
                    
                    // Save as last used profile
                    localStorage.setItem('lastUsedProfile', customerName);
                    
                    showSuccess('Profile saved successfully!');
                } catch (error) {
                    console.error('Error saving profile:', error);
                    showSuccess('Error saving profile. Please try again.');
                }
            }
            
            function loadSavedProfiles() {
                // Clear existing options except the first one
                while (savedProfilesSelect.options.length > 1) {
                    savedProfilesSelect.options.remove(1);
                }
                
                // Get profiles from localStorage
                try {
                    const profiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    
                    // Add options to select
                    Object.keys(profiles).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        savedProfilesSelect.appendChild(option);
                    });
                    
                    // Set the last used profile if available
                    const lastUsedProfile = localStorage.getItem('lastUsedProfile');
                    if (lastUsedProfile && savedProfilesSelect.querySelector(`option[value="${lastUsedProfile}"]`)) {
                        savedProfilesSelect.value = lastUsedProfile;
                    }
                } catch (error) {
                    console.error('Error loading profiles:', error);
                }
            }
            
            function retrieveCustomerProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    showSuccess('Please select a profile to retrieve');
                    return;
                }
                
                try {
                    const profiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    const profileData = profiles[selectedProfile];
                    
                    if (!profileData) {
                        showSuccess('Profile not found');
                        return;
                    }
                    
                    // Reset form first
                    resetBtn.click();
                    
                    // Fill in the data
                    customerNameInput.value = profileData.customerName;
                    salaryInput.value = profileData.salary;
                    loanTypeSelect.value = profileData.loanType;
                    disbursalDateInput.value = profileData.disbursalDate;
                    firstPaymentDateInput.value = profileData.firstPaymentDate;
                    multiplesOfSalaryInput.value = profileData.multiplesOfSalary;
                    tenureMonthsInput.value = profileData.tenureMonths;
                    loanAmountInput.value = profileData.loanAmount;
                    reducingRateInput.value = profileData.reducingRate;
                    specialNote.value = profileData.specialNote;
                    dbrRateToggle.checked = profileData.dbrRateToggle || false;
                    
                    // Handle credit cards
                    if (profileData.creditCards && profileData.creditCards.length > 0) {
                        // First card already exists, so update it
                        const firstCardElement = document.querySelector('.credit-card-entry');
                        firstCardElement.querySelector('.card-bank-select').value = profileData.creditCards[0].bank;
                        firstCardElement.querySelector('.credit-card-amount').value = profileData.creditCards[0].limit;
                        firstCardElement.querySelector('.credit-card-outstanding').value = profileData.creditCards[0].outstanding;
                        
                        // Handle settled state
                        if (profileData.creditCards[0].settled) {
                            settledCards.add(0);
                            firstCardElement.classList.add('card-settled');
                            const settleBtn = firstCardElement.querySelector('.settle-card-btn');
                            settleBtn.textContent = 'Unsettle';
                            settleBtn.classList.remove('bg-primary');
                            settleBtn.classList.add('bg-red-500');
                        }
                        
                        // Add additional cards
                        for (let i = 1; i < profileData.creditCards.length; i++) {
                            addCreditCardBtn.click();
                            
                            const cardElements = document.querySelectorAll('.credit-card-entry');
                            const newCard = cardElements[cardElements.length - 1];
                            
                            newCard.querySelector('.card-bank-select').value = profileData.creditCards[i].bank;
                            newCard.querySelector('.credit-card-amount').value = profileData.creditCards[i].limit;
                            newCard.querySelector('.credit-card-outstanding').value = profileData.creditCards[i].outstanding;
                            
                            // Handle settled state
                            if (profileData.creditCards[i].settled) {
                                settledCards.add(i);
                                newCard.classList.add('card-settled');
                                const settleBtn = newCard.querySelector('.settle-card-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('bg-primary');
                                settleBtn.classList.add('bg-red-500');
                            }
                        }
                    }
                    
                    // Handle existing loans
                    if (profileData.existingLoans && profileData.existingLoans.length > 0) {
                        for (let i = 0; i < profileData.existingLoans.length; i++) {
                            addExistingLoanBtn.click();
                            
                            const loanElements = document.querySelectorAll('.existing-loan-entry');
                            const loan = loanElements[i];
                            
                            loan.querySelector('.loan-type').value = profileData.existingLoans[i].type;
                            loan.querySelector('.loan-installment').value = profileData.existingLoans[i].installment;
                            loan.querySelector('.loan-outstanding').value = profileData.existingLoans[i].outstanding;
                            
                            // Handle settled state
                            if (profileData.existingLoans[i].settled) {
                                settledLoans.add(i);
                                loan.classList.add('loan-settled');
                                const settleBtn = loan.querySelector('.settle-loan-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('bg-primary');
                                settleBtn.classList.add('bg-red-500');
                            }
                        }
                    }
                    
                    // Save as last used profile
                    localStorage.setItem('lastUsedProfile', selectedProfile);
                    
                    // Update calculations
                    updateGrossSalary();
                    updateDBRCalculator();
                    updateEMICalculator();
                    
                    showSuccess('Profile retrieved successfully!');
                } catch (error) {
                    console.error('Error retrieving profile:', error);
                    showSuccess('Error retrieving profile. Please try again.');
                }
            }
            
            function deleteCustomerProfile() {
                const selectedProfile = savedProfilesSelect.value;
                if (!selectedProfile) {
                    showSuccess('Please select a profile to delete');
                    return;
                }
                
                if (!confirm(`Are you sure you want to delete the profile "${selectedProfile}"?`)) {
                    return;
                }
                
                try {
                    // Get existing profiles
                    const existingProfiles = JSON.parse(localStorage.getItem('customerProfiles')) || {};
                    
                    // Delete the selected profile
                    if (existingProfiles[selectedProfile]) {
                        delete existingProfiles[selectedProfile];
                        
                        // Save back to localStorage
                        localStorage.setItem('customerProfiles', JSON.stringify(existingProfiles));
                        
                        // If we deleted the last used profile, remove it
                        if (localStorage.getItem('lastUsedProfile') === selectedProfile) {
                            localStorage.removeItem('lastUsedProfile');
                        }
                        
                        // Update dropdown
                        loadSavedProfiles();
                        
                        // Reset the select to default option
                        savedProfilesSelect.value = '';
                        
                        showSuccess('Profile deleted successfully!');
                    } else {
                        showSuccess('Profile not found');
                    }
                } catch (error) {
                    console.error('Error deleting profile:', error);
                    showSuccess('Error deleting profile. Please try again.');
                }
            }
            
            // Functions to save and load temporary state
            function saveTemporaryState() {
                const tempState = {
                    customerName: customerNameInput.value,
                    salary: salaryInput.value,
                    loanType: loanTypeSelect.value,
                    disbursalDate: disbursalDateInput.value,
                    firstPaymentDate: firstPaymentDateInput.value,
                    multiplesOfSalary: multiplesOfSalaryInput.value,
                    tenureMonths: tenureMonthsInput.value,
                    loanAmount: loanAmountInput.value,
                    reducingRate: reducingRateInput.value,
                    specialNote: specialNote.value,
                    dbrRateToggle: dbrRateToggle.checked,
                    
                    // Credit card data
                    creditCards: Array.from(document.querySelectorAll('.credit-card-entry')).map((entry, index) => {
                        return {
                            bank: entry.querySelector('.card-bank-select').value,
                            limit: entry.querySelector('.credit-card-amount').value,
                            outstanding: entry.querySelector('.credit-card-outstanding').value,
                            settled: settledCards.has(index)
                        };
                    }),
                    
                    // Existing loans data
                    existingLoans: Array.from(document.querySelectorAll('.existing-loan-entry')).map((entry, index) => {
                        return {
                            type: entry.querySelector('.loan-type').value,
                            installment: entry.querySelector('.loan-installment').value,
                            outstanding: entry.querySelector('.loan-outstanding').value,
                            settled: settledLoans.has(index)
                        };
                    }),
                    
                    // Add-back data
                    addbackData: addbackData
                };
                
                localStorage.setItem('tempFormState', JSON.stringify(tempState));
            }
            
            function loadTemporaryState() {
                try {
                    const tempState = JSON.parse(localStorage.getItem('tempFormState'));
                    
                    if (!tempState) return;
                    
                    // Fill form with temporary state
                    customerNameInput.value = tempState.customerName || '';
                    salaryInput.value = tempState.salary || '';
                    loanTypeSelect.value = tempState.loanType || 'fresh-0-30';
                    disbursalDateInput.value = tempState.disbursalDate || today.toISOString().split('T')[0];
                    firstPaymentDateInput.value = tempState.firstPaymentDate || nextMonth.toISOString().split('T')[0];
                    multiplesOfSalaryInput.value = tempState.multiplesOfSalary || '15';
                    tenureMonthsInput.value = tempState.tenureMonths || '48';
                    loanAmountInput.value = tempState.loanAmount || '';
                    reducingRateInput.value = tempState.reducingRate || '10';
                    specialNote.value = tempState.specialNote || '';
                    dbrRateToggle.checked = tempState.dbrRateToggle || false;
                    
                    // Handle credit cards
                    if (tempState.creditCards && tempState.creditCards.length > 0) {
                        // First card already exists, so update it
                        const firstCardElement = document.querySelector('.credit-card-entry');
                        firstCardElement.querySelector('.card-bank-select').value = tempState.creditCards[0].bank || 'ADCB';
                        firstCardElement.querySelector('.credit-card-amount').value = tempState.creditCards[0].limit || '';
                        firstCardElement.querySelector('.credit-card-outstanding').value = tempState.creditCards[0].outstanding || '';
                        
                        // Handle settled state
                        if (tempState.creditCards[0].settled) {
                            settledCards.add(0);
                            firstCardElement.classList.add('card-settled');
                            const settleBtn = firstCardElement.querySelector('.settle-card-btn');
                            settleBtn.textContent = 'Unsettle';
                            settleBtn.classList.remove('bg-primary');
                            settleBtn.classList.add('bg-red-500');
                        }
                        
                        // Add additional cards
                        for (let i = 1; i < tempState.creditCards.length; i++) {
                            addCreditCardBtn.click();
                            
                            const cardElements = document.querySelectorAll('.credit-card-entry');
                            const newCard = cardElements[cardElements.length - 1];
                            
                            newCard.querySelector('.card-bank-select').value = tempState.creditCards[i].bank || 'ADCB';
                            newCard.querySelector('.credit-card-amount').value = tempState.creditCards[i].limit || '';
                            newCard.querySelector('.credit-card-outstanding').value = tempState.creditCards[i].outstanding || '';
                            
                            // Handle settled state
                            if (tempState.creditCards[i].settled) {
                                settledCards.add(i);
                                newCard.classList.add('card-settled');
                                const settleBtn = newCard.querySelector('.settle-card-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('bg-primary');
                                settleBtn.classList.add('bg-red-500');
                            }
                        }
                    }
                    
                    // Handle existing loans
                    if (tempState.existingLoans && tempState.existingLoans.length > 0) {
                        for (let i = 0; i < tempState.existingLoans.length; i++) {
                            addExistingLoanBtn.click();
                            
                            const loanElements = document.querySelectorAll('.existing-loan-entry');
                            const loan = loanElements[i];
                            
                            loan.querySelector('.loan-type').value = tempState.existingLoans[i].type || 'Personal Loan';
                            loan.querySelector('.loan-installment').value = tempState.existingLoans[i].installment || '';
                            loan.querySelector('.loan-outstanding').value = tempState.existingLoans[i].outstanding || '';
                            
                            // Handle settled state
                            if (tempState.existingLoans[i].settled) {
                                settledLoans.add(i);
                                loan.classList.add('loan-settled');
                                const settleBtn = loan.querySelector('.settle-loan-btn');
                                settleBtn.textContent = 'Unsettle';
                                settleBtn.classList.remove('bg-primary');
                                settleBtn.classList.add('bg-red-500');
                            }
                        }
                    }
                    
                    // Update calculations
                    updateGrossSalary();
                    updateDBRCalculator();
                    updateEMICalculator();
                    
                } catch (error) {
                    console.error('Error loading temporary state:', error);
                }
            }
            
            // ==========================================
            // LOAN FUNCTIONALITY
            // ==========================================
            
            // Existing Loans functionality
            addExistingLoanBtn.addEventListener('click', function() {
                existingLoansContainer.classList.remove('hidden');
                addExistingLoan();
            });
            
            function addExistingLoan() {
                existingLoanCount++;
                const loanDiv = document.createElement('div');
                loanDiv.classList.add('grid', 'grid-cols-3', 'gap-3', 'items-center', 'existing-loan-entry');
                
                loanDiv.innerHTML = `
                    <div class="flex justify-between items-center">
                        <select class="loan-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                            <option value="Personal Loan">Personal Loan</option>
                            <option value="Auto Loan">Auto Loan</option>
                            <option value="Mortgage Loan">Mortgage Loan</option>
                        </select>
                    </div>
                    <div class="col-span-2 flex">
                        <input type="number" placeholder="Installment" class="loan-installment border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-1/2 mr-1">
                        <input type="number" placeholder="Outstanding" class="loan-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-1/2 mr-1">
                        <button class="settle-loan-btn ml-1 bg-primary text-white px-3 py-1 rounded hover:bg-opacity-80 text-sm">Settle</button>
                        <button class="remove-loan ml-1 bg-primary text-white p-2 rounded-md hover:bg-opacity-80">×</button>
                    </div>
                `;
                
                existingLoansContainer.appendChild(loanDiv);
                
                // Add event listener to new loan inputs
                const newLoanInstallment = loanDiv.querySelector('.loan-installment');
                newLoanInstallment.addEventListener('input', updateDBRCalculator);
                
                const newLoanOutstanding = loanDiv.querySelector('.loan-outstanding');
                newLoanOutstanding.addEventListener('input', updateDBRCalculator);
                
                // Add event listener to settle loan button
                const settleLoanBtn = loanDiv.querySelector('.settle-loan-btn');
                settleLoanBtn.addEventListener('click', function() {
                    const loanEntry = this.closest('.existing-loan-entry');
                    const loanIndex = Array.from(document.querySelectorAll('.existing-loan-entry')).indexOf(loanEntry);
                    
                    // Toggle settled state
                    if (settledLoans.has(loanIndex)) {
                        settledLoans.delete(loanIndex);
                        loanEntry.classList.remove('loan-settled');
                        this.textContent = 'Settle';
                        this.classList.remove('bg-red-500');
                        this.classList.add('bg-primary');
                    } else {
                        settledLoans.add(loanIndex);
                        loanEntry.classList.add('loan-settled');
                        this.textContent = 'Unsettle';
                        this.classList.remove('bg-primary');
                        this.classList.add('bg-red-500');
                    }
                    
                    // Update calculations
                    updateDBRCalculator();
                });
                
                // Add event listener to remove button
                const removeBtn = loanDiv.querySelector('.remove-loan');
                removeBtn.addEventListener('click', function() {
                    const loanEntry = this.closest('.existing-loan-entry');
                    const loanIndex = Array.from(document.querySelectorAll('.existing-loan-entry')).indexOf(loanEntry);
                    
                    // Remove from settled loans if it was settled
                    if (settledLoans.has(loanIndex)) {
                        settledLoans.delete(loanIndex);
                    }
                    
                    // Remove the element
                    loanEntry.remove();
                    existingLoanCount--;
                    
                    if (existingLoanCount === 0) {
                        existingLoansContainer.classList.add('hidden');
                    }
                    
                    // Recalculate
                    updateDBRCalculator();
                });
            }
            
            // ==========================================
            // ADDBACK FUNCTIONALITY
            // ==========================================
            
            // Function to create the Add-back Type specific fields
            function createAddbackTypeFields(selectElement) {
                const addbackType = selectElement.value;
                const addbackEntry = selectElement.closest('.addback-entry');
                const index = Array.from(addbacksContainer.querySelectorAll('.addback-entry')).indexOf(addbackEntry);
                
                // Clear existing fields for this addback
                const existingFields = document.getElementById(`addback-fields-${index}`);
                if (existingFields) {
                    existingFields.remove();
                    
                    // Clear data for this addback
                    delete addbackData[index];
                }
                
                if (!addbackType) return;
                
                // Create new fields container
                const fieldsContainer = document.createElement('div');
                fieldsContainer.id = `addback-fields-${index}`;
                fieldsContainer.classList.add('mt-2', 'p-4', 'border', 'border-gray-200', 'dark:border-gray-600', 'rounded-lg');
                
                let html = '';
                
                // Initialize data object for this addback
                addbackData[index] = {
                    type: addbackType,
                    values: {}
                };
                
                switch(addbackType) {
                    case 'hra':
                    case 'airfare':
                        html = `
                            <h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-300">${addbackType === 'hra' ? 'HRA' : 'Airfare Allowance'}</h3>
                            <div class="flex items-center gap-4 mb-2">
                                <div class="flex items-center">
                                    <input type="radio" id="${addbackType}Yearly-${index}" name="${addbackType}Period-${index}" value="yearly" class="mr-2">
                                    <label for="${addbackType}Yearly-${index}" class="text-gray-700 dark:text-gray-300">Yearly</label>
                                </div>
                                <div class="flex items-center">
                                    <input type="radio" id="${addbackType}Monthly-${index}" name="${addbackType}Period-${index}" value="monthly" class="mr-2">
                                    <label for="${addbackType}Monthly-${index}" class="text-gray-700 dark:text-gray-300">Monthly</label>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 gap-2">
                                <div class="flex items-center">
                                    <label class="text-gray-700 dark:text-gray-300 w-1/3">Amount:</label>
                                    <input type="number" class="${addbackType}-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-2/3">
                                </div>
                            </div>
                        `;
                        break;
                    case 'overtime':
                    case 'servicecharge':
                    case 'incentives':
                    case 'telephone':
                        const title = {
                            'overtime': 'Over-time',
                            'servicecharge': 'Service Charge',
                            'incentives': 'Incentives',
                            'telephone': 'Telephone Allowance'
                        }[addbackType];
                        
                        html = `<h3 class="font-semibold mb-2 text-gray-700 dark:text-gray-300">${title}</h3>`;
                        
                        // Create 6 input fields for 6 months
                        html += '<div class="grid grid-cols-1 gap-2">';
                        for (let i = 1; i <= 6; i++) {
                            html += `
                                <div class="flex items-center">
                                    <label class="text-gray-700 dark:text-gray-300 w-1/3">Month ${i}:</label>
                                    <input type="number" class="${addbackType}-amount-${i} border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-2/3">
                                </div>
                            `;
                        }
                        html += '</div>';
                        break;
                }
                
                fieldsContainer.innerHTML = html;
                dynamicAddbackFields.appendChild(fieldsContainer);
                
                // Add event listeners to the newly created fields
                if (addbackType === 'hra' || addbackType === 'airfare') {
                    // Radio buttons
                    const yearlyRadio = document.getElementById(`${addbackType}Yearly-${index}`);
                    const monthlyRadio = document.getElementById(`${addbackType}Monthly-${index}`);
                    
                    yearlyRadio.addEventListener('change', updateGrossSalary);
                    monthlyRadio.addEventListener('change', updateGrossSalary);
                    
                    // Amount input
                    const amountInput = fieldsContainer.querySelector(`.${addbackType}-amount`);
                    amountInput.addEventListener('input', updateGrossSalary);
                } else if (['overtime', 'servicecharge', 'incentives', 'telephone'].includes(addbackType)) {
                    // 6 month inputs
                    for (let i = 1; i <= 6; i++) {
                        const amountInput = fieldsContainer.querySelector(`.${addbackType}-amount-${i}`);
                        amountInput.addEventListener('input', updateGrossSalary);
                    }
                }
            }
            
            // Function to calculate gross salary from salary and add-backs
            function updateGrossSalary() {
                const salary = parseFloat(salaryInput.value) || 0;
                let totalAddbacks = 0;
                
                // Process each add-back
                Object.keys(addbackData).forEach(index => {
                    const addback = addbackData[index];
                    const fieldsContainer = document.getElementById(`addback-fields-${index}`);
                    
                    if (fieldsContainer) {
                        if (addback.type === 'hra' || addback.type === 'airfare') {
                            const yearlyRadio = document.getElementById(`${addback.type}Yearly-${index}`);
                            const amountInput = fieldsContainer.querySelector(`.${addback.type}-amount`);
                            const amount = parseFloat(amountInput.value) || 0;
                            
                            if (amount > 0) {
                                if (yearlyRadio && yearlyRadio.checked) {
                                    // Yearly amount / 12
                                    totalAddbacks += amount / 12;
                                } else {
                                    // Monthly amount as is
                                    totalAddbacks += amount;
                                }
                            }
                        } else if (['overtime', 'servicecharge', 'incentives', 'telephone'].includes(addback.type)) {
                            let sixMonthTotal = 0;
                            
                            // Sum up all 6 months
                            for (let i = 1; i <= 6; i++) {
                                const amountInput = fieldsContainer.querySelector(`.${addback.type}-amount-${i}`);
                                sixMonthTotal += parseFloat(amountInput.value) || 0;
                            }
                            
                            // For Telephone Allowance, add directly to calculation
                            if (addback.type === 'telephone') {
                                totalAddbacks += sixMonthTotal;
                            } else {
                                // For others, divide by 6
                                totalAddbacks += sixMonthTotal / 6;
                            }
                        }
                    }
                });
                
                // Calculate gross salary
                const grossSalary = salary + totalAddbacks;
                grossSalaryInput.value = formatNumber(grossSalary.toFixed(2));
                
                // Update other calculations that depend on salary
                updateDBRCalculator();
                updateEMICalculator();
            }
            
            // ==========================================
            // CALCULATION FUNCTIONS
            // ==========================================
            
            // Function to calculate standard EMI
            function calculateStandardEMI(principal, rate, tenure) {
                const monthlyRate = rate / 12 / 100;
                const emi = principal * monthlyRate * Math.pow(1 + monthlyRate, tenure) / (Math.pow(1 + monthlyRate, tenure) - 1);
                return isNaN(emi) || !isFinite(emi) ? 0 : emi;
            }
            
            // Function to get grace period based on loan type
            function getGracePeriodFromLoanType(loanType) {
                switch(loanType) {
                    case 'fresh-0-30':
                    case 'topup-0-30':
                        return 0;
                    case 'fresh-30-60':
                    case 'topup-30-60':
                        return 1;
                    case 'takeover-60-90':
                        return 2;
                    default:
                        return 0;
                }
            }
            
            // Function to calculate EMI with grace period
            function calculateEMIWithGracePeriod(principal, rate, tenure, loanType) {
                if (!principal || !rate || !tenure || !loanType) return 0;
                
                const monthlyRate = rate / 12 / 100;
                const gracePeriodMonths = getGracePeriodFromLoanType(loanType);
                
                if (gracePeriodMonths === 0) {
                    // Standard EMI calculation (0-30 days)
                    return calculateStandardEMI(principal, rate, tenure);
                } else if (gracePeriodMonths === 1) {
                    // 30-60 days (add 1 month of interest to principal)
                    const interest1Month = principal * monthlyRate;
                    const newPrincipal = principal + interest1Month;
                    return calculateStandardEMI(newPrincipal, rate, tenure);
                } else if (gracePeriodMonths === 2) {
                    // 60-90 days (add 2 months of interest to principal)
                    const interest2Months = principal * monthlyRate * 2;
                    const newPrincipal = principal + interest2Months;
                    return calculateStandardEMI(newPrincipal, rate, tenure);
                }
                
                return 0;
            }
            
            // Function to calculate processing fees
            function calculateProcessingFees(loanAmount) {
                // Calculate 1.05% of loan amount
                const processingFeePercent = loanAmount * 0.0105;
                
                if (processingFeePercent > 2625) {
                    return 2625;
                } else if (processingFeePercent < 525) {
                    return 525;
                } else {
                    return processingFeePercent;
                }
            }
            
            // Function to calculate days between two dates
            function calculateDaysBetween(startDate, endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            }
            
            // Function to update days between
            function updateDaysBetween() {
                const disbursalDate = disbursalDateInput.value;
                const firstPaymentDate = firstPaymentDateInput.value;
                
                if (disbursalDate && firstPaymentDate) {
                    const days = calculateDaysBetween(disbursalDate, firstPaymentDate);
                    daysBetweenInput.value = days;
                } else {
                    daysBetweenInput.value = '';
                }
            }
            
            // Function to get day range based on loan type
            function getDayRangeFromLoanType(loanType) {
                switch(loanType) {
                    case 'fresh-0-30':
                    case 'topup-0-30':
                        return [0, 30];
                    case 'fresh-30-60':
                    case 'topup-30-60':
                        return [31, 60];
                    case 'takeover-60-90':
                        return [61, 90];
                    default:
                        return [0, 90];
                }
            }
            
            // Handle settle card button clicks
            creditCardsContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('settle-card-btn')) {
                    const cardEntry = e.target.closest('.credit-card-entry');
                    const cardIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(cardEntry);
                    
                    // Toggle settled state
                    if (settledCards.has(cardIndex)) {
                        settledCards.delete(cardIndex);
                        cardEntry.classList.remove('card-settled');
                        e.target.textContent = 'Settle';
                        e.target.classList.remove('bg-red-500');
                        e.target.classList.add('bg-primary');
                    } else {
                        settledCards.add(cardIndex);
                        cardEntry.classList.add('card-settled');
                        e.target.textContent = 'Unsettle';
                        e.target.classList.remove('bg-primary');
                        e.target.classList.add('bg-red-500');
                    }
                    
                    // Update calculations
                    updateDBRCalculator();
                }
            });
            
            // Handle DBR rate toggle
            dbrRateToggle.addEventListener('change', updateDBRCalculator);
            
            // Function to update DBR calculator
            function updateDBRCalculator() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                
                // Get existing loans installments (only include non-settled loans)
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                // Get existing loans outstanding (not counted in DBR)
                let totalExistingLoansOutstanding = 0;
                document.querySelectorAll('.loan-outstanding').forEach(input => {
                    totalExistingLoansOutstanding += parseFloat(input.value) || 0;
                });
                
                // Calculate total credit card limit and outstanding
                let totalCCLimit = 0;
                let totalCCOutstanding = 0;
                
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    const limitInput = entry.querySelector('.credit-card-amount');
                    const outstandingInput = entry.querySelector('.credit-card-outstanding');
                    const limit = parseFloat(limitInput.value) || 0;
                    const outstanding = parseFloat(outstandingInput.value) || 0;
                    
                    // Only include in Total CC Limit if not settled
                    if (!settledCards.has(index)) {
                        totalCCLimit += limit;
                    }
                    
                    // Always include in outstanding
                    totalCCOutstanding += outstanding;
                });
                
                totalCCLimitInput.value = formatNumber(totalCCLimit.toFixed(2));
                
                // Calculate total outstanding (not counted in DBR)
                const totalOutstanding = totalCCOutstanding + totalExistingLoansOutstanding;
                totalOutstandingInput.value = formatNumber(totalOutstanding.toFixed(2));
                
                // Calculate DBR for credit cards (3% or 5% of total limit based on toggle)
                const dbrRate = dbrRateToggle.checked ? 0.05 : 0.03;
                const dbrCC = totalCCLimit * dbrRate;
                dbrCCInput.value = formatNumber(dbrCC.toFixed(2));
                
                // Calculate allowed liability (50% of gross salary)
                const allowedLiability = grossSalary / 2;
                allowedLiabilityInput.value = formatNumber(allowedLiability.toFixed(2));
                
                // Get EMI from loan amount
                const emi = parseFloat(emiInput.value.replace(/,/g, '')) || 0;
                
                // Calculate total liabilities
                const totalLiabilities = totalExistingLoansInstallments + dbrCC;
                totalLiabilitiesInput.value = formatNumber(totalLiabilities.toFixed(2));
                
                // Calculate new total liabilities (including EMI)
                const newTotalLiabilities = totalLiabilities + emi;
                newTotalLiabilitiesInput.value = formatNumber(newTotalLiabilities.toFixed(2));
                
                // Calculate available liability by subtracting total liabilities from allowed liability
                const availableLiability = allowedLiability - newTotalLiabilities;
                availableLiabilityInput.value = formatNumber(availableLiability.toFixed(2));
                
                // Calculate DBR percentage based on new total liabilities
                const dbrPercentage = (newTotalLiabilities / grossSalary) * 100;
                dbrPercentageInput.value = dbrPercentage.toFixed(2);
                
                // Show warning if DBR is high (49.99% or higher)
                if (dbrPercentage >= 49.99) {
                    // Apply red flash warning to the entire calculator sections
                    dbrCalculatorSection.classList.add('dbr-warning-flash');
                    emiCalculatorSection.classList.add('dbr-warning-flash');
                    
                    // Permanently mark the DBR input field as high
                    dbrPercentageInput.classList.add('dbr-high');
                    
                    // Restore normal appearance after 3 animations (3 seconds)
                    setTimeout(() => {
                        dbrCalculatorSection.classList.remove('dbr-warning-flash');
                        emiCalculatorSection.classList.remove('dbr-warning-flash');
                    }, 3000);
                } else {
                    // Remove high DBR styling if DBR is now below threshold
                    dbrPercentageInput.classList.remove('dbr-high');
                }
                
                // Check if loan amount would exceed DBR limit
                checkLoanAmountWithDBR();
                
                // Suggest optimal credit card limit
                suggestCreditCardLimit();
                
                // Update Cash in Hand calculation
                updateCashInHand();
            }
            
            // Function to update Cash in Hand calculation
            function updateCashInHand() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const totalOutstanding = parseFloat(totalOutstandingInput.value.replace(/,/g, '')) || 0;
                const cashInHand = loanAmount - totalOutstanding;
                cashInHandInput.value = formatNumber(cashInHand.toFixed(2));
            }
            
            // Function to check if loan amount would exceed DBR limit
            function checkLoanAmountWithDBR() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (grossSalary <= 0 || loanAmount <= 0) {
                    loanAmountError.classList.add('hidden');
                    return;
                }
                
                // Calculate EMI for the loan amount
                const emi = calculateEMIWithGracePeriod(loanAmount, reducingRate, tenureMonths, loanType);
                
                // Get existing loans installments (only for non-settled loans)
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                // Calculate credit card DBR
                let totalCCLimit = 0;
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    if (!settledCards.has(index)) {
                        const limitInput = entry.querySelector('.credit-card-amount');
                        totalCCLimit += parseFloat(limitInput.value) || 0;
                    }
                });
                
                const dbrRate = dbrRateToggle.checked ? 0.05 : 0.03;
                const dbrCC = totalCCLimit * dbrRate;
                const currentLiabilities = totalExistingLoansInstallments + dbrCC;
                
                // Calculate total liabilities with EMI
                const totalLiabilitiesWithEMI = currentLiabilities + emi;
                
                // Calculate DBR percentage
                const dbrPercentage = (totalLiabilitiesWithEMI / grossSalary) * 100;
                
                // Calculate the ideal loan amount for 49.95% DBR
                const allowedDBRPercentage = 49.95;
                const allowedLiability = grossSalary * (allowedDBRPercentage / 100);
                const availableForEMI = allowedLiability - currentLiabilities;
                
                // Find the loan amount that would result in this EMI
                // Using binary search
                let low = 0;
                let high = grossSalary * 100; // Setting a high upper bound
                let idealLoanAmount = 0;
                
                while (high - low > 1) {
                    const mid = (low + high) / 2;
                    const testEMI = calculateEMIWithGracePeriod(mid, reducingRate, tenureMonths, loanType);
                    
                    if (testEMI <= availableForEMI) {
                        low = mid;
                        idealLoanAmount = mid;
                    } else {
                        high = mid;
                    }
                }
                
                // Show error if DBR exceeds 49.99% with message including ideal amount
                if (dbrPercentage >= 49.99) {
                    loanAmountError.textContent = `Error: Loan Amount Will Exceed DBR Limit! Ideal amount: AED ${formatNumber(Math.floor(idealLoanAmount))}`;
                    loanAmountError.classList.remove('hidden');
                } else {
                    loanAmountError.classList.add('hidden');
                }
            }
            
            // Function to suggest optimal credit card limit
            function suggestCreditCardLimit() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                if (grossSalary <= 0) {
                    ccSuggestionContainer.classList.add('hidden');
                    return;
                }
                
                // Calculate available liability
                const availableLiability = parseFloat(availableLiabilityInput.value.replace(/,/g, '')) || 0;
                
                // Get current DBR percentage
                const dbrPercentage = parseFloat(dbrPercentageInput.value) || 0;
                
                // Calculate optimal credit card limit by dividing available liability by 3% or 5%
                const dbrRate = dbrRateToggle.checked ? 5 : 3;
                const optimalCCLimit = availableLiability / (dbrRate/100);
                
                if (availableLiability > 0 && dbrPercentage < 49.95) {
                    ccSuggestionContainer.classList.remove('hidden');
                    ccSuggestionText.textContent = (`Based on your available liability of AED ${formatNumber(availableLiability.toFixed(2))} and current DBR of ${dbrPercentage.toFixed(2)}%, the optimal credit card limit for you would be AED ${formatNumber(optimalCCLimit.toFixed(2))}. This would keep your DBR within the 49.95% limit.`);
                } else {
                    ccSuggestionContainer.classList.remove('hidden');
                    ccSuggestionText.textContent = (`Your current liabilities exceed or are close to the 49.95% DBR limit. It is not recommended to apply for any credit cards at this time.`);
                }
            }
            
            // Function to update EMI calculator
            function updateEMICalculator() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const multiplesOfSalary = parseFloat(multiplesOfSalaryInput.value) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                // Calculate max loan eligibility based on gross salary
                const maxLoanEligibility = grossSalary * multiplesOfSalary;
                maxLoanEligibilityInput.value = formatNumber(maxLoanEligibility.toFixed(2));
                
                // Calculate flat rate
                const flatRate = reducingRate / 1.833;
                flatRateInput.value = flatRate.toFixed(2);
                
                if (loanAmount > 0 && reducingRate > 0 && tenureMonths > 0) {
                    // Calculate EMI with grace period 
                    const emi = calculateEMIWithGracePeriod(loanAmount, reducingRate, tenureMonths, loanType);
                    emiInput.value = formatNumber(emi.toFixed(2));
                    
                    // Calculate total payment
                    const totalPayment = emi * tenureMonths;
                    totalPaymentInput.value = formatNumber(totalPayment.toFixed(2));
                    
                    // Calculate total interest
                    const totalInterest = totalPayment - loanAmount;
                    totalInterestInput.value = formatNumber(totalInterest.toFixed(2));
                    
                    // Calculate processing fees
                    const processingFees = calculateProcessingFees(loanAmount);
                    processingFeesInput.value = formatNumber(processingFees.toFixed(2));
                    
                    // Update DBR calculator with new EMI amount
                    updateDBRCalculator();
                } else {
                    // Clear outputs if inputs are missing
                    emiInput.value = '';
                    totalPaymentInput.value = '';
                    totalInterestInput.value = '';
                    processingFeesInput.value = '';
                }
            }
            
            // Function to validate payment date based on loan type
            function validatePaymentDate() {
                const disbursalDate = new Date(disbursalDateInput.value);
                const firstPaymentDate = new Date(firstPaymentDateInput.value);
                const loanType = loanTypeSelect.value;
                
                if (!disbursalDate || !firstPaymentDate) {
                    return true; // Skip validation if dates aren't set
                }
                
                const daysDifference = Math.floor((firstPaymentDate - disbursalDate) / (1000 * 60 * 60 * 24));
                
                // Get day range allowed for this loan type
                const [minDays, maxDays] = getDayRangeFromLoanType(loanType);
                
                if (daysDifference < minDays || daysDifference > maxDays) {
                    dateErrorMsg.textContent = `Error: First Payment Date Must Be Between ${minDays} and ${maxDays} Days After Disbursal Date.`;
                    dateErrorMsg.classList.remove('hidden');
                    return false;
                } else if (firstPaymentDate <= disbursalDate) {
                    dateErrorMsg.textContent = 'Error: First Payment Date Must Be After Disbursal Date.';
                    dateErrorMsg.classList.remove('hidden');
                    return false;
                } else {
                    dateErrorMsg.classList.add('hidden');
                    return true;
                }
            }
            
            // Function to adjust first payment date based on loan type
            function adjustFirstPaymentDate() {
                const disbursalDate = new Date(disbursalDateInput.value);
                if (!disbursalDate) return;
                
                const loanType = loanTypeSelect.value;
                const [minDays, maxDays] = getDayRangeFromLoanType(loanType);
                
                // Set first payment date to middle of the allowed range by default
                const midDays = Math.floor((minDays + maxDays) / 2);
                const newPaymentDate = new Date(disbursalDate);
                newPaymentDate.setDate(disbursalDate.getDate() + midDays);
                
                firstPaymentDateInput.value = newPaymentDate.toISOString().split('T')[0];
                updateDaysBetween();
            }
            
            // ==========================================
            // EMI CHART AND SCHEDULE
            // ==========================================
            
            // Function to generate EMI payment schedule 
            function generateEMISchedule() {
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                
                if (loanAmount <= 0 || tenureMonths <= 0) {
                    return [];
                }
                
                // Determine initial principal based on grace period
                let initialPrincipal = loanAmount;
                const monthlyRate = reducingRate / 12 / 100;
                const gracePeriodMonths = getGracePeriodFromLoanType(loanType);
                
                if (gracePeriodMonths === 1) {
                    // Add 1 month of interest accrual
                    const interest1Month = loanAmount * monthlyRate;
                    initialPrincipal = loanAmount + interest1Month;
                } else if (gracePeriodMonths === 2) {
                    // Add 2 months of interest accrual
                    const interest2Months = loanAmount * monthlyRate * 2;
                    initialPrincipal = loanAmount + interest2Months;
                }
                
                const emi = calculateStandardEMI(initialPrincipal, reducingRate, tenureMonths);
                let remainingPrincipal = initialPrincipal;
                const schedule = [];
                
                for (let month = 1; month <= tenureMonths; month++) {
                    const interestForMonth = remainingPrincipal * monthlyRate;
                    const principalForMonth = emi - interestForMonth;
                    remainingPrincipal -= principalForMonth;
                    
                    schedule.push({
                        month,
                        emi,
                        principal: principalForMonth,
                        interest: interestForMonth,
                        balance: remainingPrincipal < 0 ? 0 : remainingPrincipal
                    });
                }
                
                return schedule;
            }
            
            // Function to display EMI chart
            function displayEMIChart() {
                const schedule = generateEMISchedule();
                if (schedule.length === 0) {
                    showSuccess('Please enter valid loan amount, rate and tenure first.');
                    return;
                }
                
                // Create data for chart
                const months = schedule.map(entry => entry.month);
                const principal = schedule.map(entry => entry.principal);
                const interest = schedule.map(entry => entry.interest);
                
                // Destroy previous chart if exists
                if (emiChart) {
                    emiChart.destroy();
                }
                
                // Create chart
                const ctx = document.getElementById('emiChart').getContext('2d');
                emiChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Principal',
                                data: principal,
                                backgroundColor: '#36c5a1',
                                borderColor: '#2ca88a',
                                borderWidth: 1
                            },
                            {
                                label: 'Interest',
                                data: interest,
                                backgroundColor: '#6F2C4F',
                                borderColor: '#5a2340',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Month'
                                }
                            },
                            y: {
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Amount (AED)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'EMI Breakdown - Principal vs. Interest',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Populate EMI schedule table
                const tableBody = document.getElementById('emiScheduleBody');
                tableBody.innerHTML = '';
                
                // Display all months in the schedule
                for (let i = 0; i < schedule.length; i++) {
                    const entry = schedule[i];
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="border border-gray-300 p-2 text-center">${entry.month}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.emi.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.principal.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.interest.toFixed(2))}</td>
                        <td class="border border-gray-300 p-2 text-right">${formatNumber(entry.balance.toFixed(2))}</td>
                    `;
                    tableBody.appendChild(row);
                }
            }
            
            // Function to find optimal loan amount for 49.95% DBR
            function findOptimalLoanAmount() {
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                if (grossSalary <= 0) {
                    showSuccess('Please Enter A Valid Salary Amount First.');
                    return;
                }
                
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanType = loanTypeSelect.value;
                const allowedLiability = grossSalary * 0.4995; // 49.95% of gross salary
                
                // Get existing loans installments (only for non-settled loans)
                let totalExistingLoansInstallments = 0;
                document.querySelectorAll('.existing-loan-entry').forEach((entry, index) => {
                    if (!settledLoans.has(index)) {
                        const installmentInput = entry.querySelector('.loan-installment');
                        totalExistingLoansInstallments += parseFloat(installmentInput.value) || 0;
                    }
                });
                
                // Calculate credit card DBR
                let totalCCLimit = 0;
                document.querySelectorAll('.credit-card-entry').forEach((entry, index) => {
                    if (!settledCards.has(index)) {
                        const limitInput = entry.querySelector('.credit-card-amount');
                        totalCCLimit += parseFloat(limitInput.value) || 0;
                    }
                });
                const dbrRate = dbrRateToggle.checked ? 0.05 : 0.03;
                const dbrCC = totalCCLimit * dbrRate;
                
                // Current liabilities excluding EMI
                const currentLiabilities = totalExistingLoansInstallments + dbrCC;
                
                // Available amount for EMI
                const availableForEMI = allowedLiability - currentLiabilities;
                
                if (availableForEMI <= 0) {
                    showSuccess('Your Current Liabilities Already Exceed The 49.95% DBR Limit. Cannot Calculate Optimal Loan Amount.');
                    return;
                }
                
                // Now we need to find the loan amount that would result in this EMI
                // Using binary search to find optimal loan amount
                let low = 0;
                let high = grossSalary * 100; // Setting a very high upper bound
                let optimalLoanAmount = 0;
                
                while (high - low > 1) {
                    const mid = (low + high) / 2;
                    const emi = calculateEMIWithGracePeriod(mid, reducingRate, tenureMonths, loanType);
                    
                    if (emi <= availableForEMI) {
                        low = mid;
                        optimalLoanAmount = mid;
                    } else {
                        high = mid;
                    }
                }
                
                // Update loan amount input
                loanAmountInput.value = Math.floor(optimalLoanAmount);
                
                // Recalculate everything
                updateEMICalculator();
            }
            
            // ==========================================
            // BANKING COMPARISON
            // ==========================================
            
            // Function to calculate and update bank comparison
            function updateBankComparison() {
                // Bank 1
                const bank1LoanAmount = parseFloat(bank1LoanAmountInput.value) || 0;
                const bank1Tenure = parseInt(bank1TenureInput.value) || 0;
                const bank1Rate = parseFloat(bank1RateInput.value) || 0;
                
                if (bank1LoanAmount > 0 && bank1Tenure > 0 && bank1Rate > 0) {
                    const bank1EMI = calculateStandardEMI(bank1LoanAmount, bank1Rate, bank1Tenure);
                    bank1EMIInput.value = formatNumber(bank1EMI.toFixed(2));
                    
                    const bank1TotalInterest = (bank1EMI * bank1Tenure) - bank1LoanAmount;
                    bank1TotalInterestInput.value = formatNumber(bank1TotalInterest.toFixed(2));
                }
                
                // Bank 2
                const bank2LoanAmount = parseFloat(bank2LoanAmountInput.value) || 0;
                const bank2Tenure = parseInt(bank2TenureInput.value) || 0;
                const bank2Rate = parseFloat(bank2RateInput.value) || 0;
                
                if (bank2LoanAmount > 0 && bank2Tenure > 0 && bank2Rate > 0) {
                    const bank2EMI = calculateStandardEMI(bank2LoanAmount, bank2Rate, bank2Tenure);
                    bank2EMIInput.value = formatNumber(bank2EMI.toFixed(2));
                    
                    const bank2TotalInterest = (bank2EMI * bank2Tenure) - bank2LoanAmount;
                    bank2TotalInterestInput.value = formatNumber(bank2TotalInterest.toFixed(2));
                }
                
                // Compare banks if both have data
                if (bank1LoanAmount > 0 && bank2LoanAmount > 0) {
                    const bank1Name = bank1NameInput.value || 'Bank 1';
                    const bank2Name = bank2NameInput.value || 'Bank 2';
                    const bank1TotalInterest = parseFloat(bank1TotalInterestInput.value.replace(/,/g, '')) || 0;
                    const bank2TotalInterest = parseFloat(bank2TotalInterestInput.value.replace(/,/g, '')) || 0;
                    
                    if (bank1TotalInterest < bank2TotalInterest) {
                        comparisonResultText.innerHTML = `<span class="font-bold">${bank1Name}</span> Offers The Better Deal With <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span> In Total Interest Compared To <span class="font-bold">AED ${formatNumber(bank2TotalInterest.toFixed(2))}</span> From ${bank2Name}. <span class="font-bold">You Save AED ${formatNumber((bank2TotalInterest - bank1TotalInterest).toFixed(2))}</span> With ${bank1Name}.`;
                    } else if (bank2TotalInterest < bank1TotalInterest) {
                        comparisonResultText.innerHTML = `<span class="font-bold">${bank2Name}</span> Offers The Better Deal With <span class="font-bold">AED ${formatNumber(bank2TotalInterest.toFixed(2))}</span> In Total Interest Compared To <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span> From ${bank1Name}. <span class="font-bold">You Save AED ${formatNumber((bank1TotalInterest - bank2TotalInterest).toFixed(2))}</span> With ${bank2Name}.`;
                    } else {
                        comparisonResultText.innerHTML = `Both Banks Offer The Same Total Interest Of <span class="font-bold">AED ${formatNumber(bank1TotalInterest.toFixed(2))}</span>.`;
                    }
                    
                    // Create visual comparison chart
                    renderComparisonChart();
                }
            }
            
            // Function to render comparison chart
            function renderComparisonChart() {
                const bank1Name = bank1NameInput.value || 'Bank 1';
                const bank2Name = bank2NameInput.value || 'Bank 2';
                const bank1LoanAmount = parseFloat(bank1LoanAmountInput.value) || 0;
                const bank2LoanAmount = parseFloat(bank2LoanAmountInput.value) || 0;
                const bank1TotalInterest = parseFloat(bank1TotalInterestInput.value.replace(/,/g, '')) || 0;
                const bank2TotalInterest = parseFloat(bank2TotalInterestInput.value.replace(/,/g, '')) || 0;
                
                if (bank1LoanAmount <= 0 || bank2LoanAmount <= 0) return;
                
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                // Destroy previous chart if exists
                if (window.comparisonChart) {
                    window.comparisonChart.destroy();
                }
                
                // Create chart
                window.comparisonChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [bank1Name, bank2Name],
                        datasets: [
                            {
                                label: 'Loan Amount',
                                data: [bank1LoanAmount, bank2LoanAmount],
                                backgroundColor: '#36c5a1',
                                borderColor: '#2ca88a',
                                borderWidth: 1
                            },
                            {
                                label: 'Total Interest',
                                data: [bank1TotalInterest, bank2TotalInterest],
                                backgroundColor: '#6F2C4F',
                                borderColor: '#5a2340',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                stacked: false
                            },
                            y: {
                                stacked: false,
                                title: {
                                    display: true,
                                    text: 'Amount (AED)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Loan Comparison',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }
            
            // ==========================================
            // SHARE AND EXPORT FUNCTIONALITY
            // ==========================================
            
            // Update Share Tab
            function updateShareTab() {
                // Format loan type for display
                let loanTypeDisplay = loanTypeSelect.value || '';
                if (loanTypeDisplay) {
                    loanTypeDisplay = loanTypeDisplay.replace(/(fresh|topup|takeover)(-)(\d+)(-)(\d+)/i, (match, p1, p2, p3, p4, p5) => {
                        return p1.charAt(0).toUpperCase() + p1.slice(1) + " (" + p3 + "-" + p5 + " days)";
                    });
                }
                
                // Fill the share tab with current values
                document.getElementById('shareLoanType').textContent = loanTypeDisplay;
                document.getElementById('shareMaxLoanEligibility').textContent = maxLoanEligibilityInput.value;
                document.getElementById('shareTenure').textContent = `${tenureMonthsInput.value} Months`;
                document.getElementById('shareLoanAmount').textContent = loanAmountInput.value;
                document.getElementById('shareReducingRate').textContent = `${reducingRateInput.value}%`;
                document.getElementById('shareFlatRate').textContent = `${flatRateInput.value}%`;
                document.getElementById('shareEmi').textContent = emiInput.value;
                document.getElementById('shareTotalPayment').textContent = totalPaymentInput.value;
                document.getElementById('shareTotalInterest').textContent = totalInterestInput.value;
                document.getElementById('shareProcessingFees').textContent = processingFeesInput.value;
                document.getElementById('shareTotalOutstanding').textContent = totalOutstandingInput.value;
                document.getElementById('shareCashInHand').textContent = cashInHandInput.value;
                
                // Generate EMI schedule
                const schedule = generateEMISchedule();
                const scheduleBody = document.getElementById('shareEmiSchedule');
                scheduleBody.innerHTML = '';
                
                if (schedule.length === 0) {
                    scheduleBody.innerHTML = '<tr><td colspan="5" class="text-center p-2">No schedule data available</td></tr>';
                } else {
                    // Display all months in the schedule
                    for (let i = 0; i < schedule.length; i++) {
                        const entry = schedule[i];
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${entry.month}</td>
                            <td>${formatNumber(entry.emi.toFixed(2))}</td>
                            <td>${formatNumber(entry.principal.toFixed(2))}</td>
                            <td>${formatNumber(entry.interest.toFixed(2))}</td>
                            <td>${formatNumber(entry.balance.toFixed(2))}</td>
                        `;
                        scheduleBody.appendChild(row);
                    }
                }
            }
            
            // Export PDF functionality
            exportPdfBtn.addEventListener('click', function() {
                // Initialize jsPDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Show loading indicator outside the captured content
                const successIndicator = document.getElementById('successIndicator');
                const messageEl = document.getElementById('successMessage');
                messageEl.textContent = 'Generating PDF...';
                successIndicator.classList.remove('hidden');
                
                // Get the loan info container
                const loanInfoContainer = document.querySelector('.loan-info-container');
                
                // Capture the loan info container without modifying it
                html2canvas(loanInfoContainer, { scale: 1.1 }).then(canvas => {
                    // Add image to PDF
                    const imgData = canvas.toDataURL('image/jpeg', 0.95);
                    const imgWidth = 185; // A4 width with margins
                    const imgHeight = Math.min((canvas.height * imgWidth) / canvas.width, 280); // A4 height with margins
                    
                    pdf.addImage(imgData, 'JPEG', 10, 10, imgWidth, imgHeight);
                    
                    // Save the PDF
                    const customerName = customerNameInput.value.trim();
                    const filename = customerName ? 
                        `Loan_Information_${customerName.replace(/\s+/g, '_')}.pdf` : 
                        'Loan_Information.pdf';
                    
                    pdf.save(filename);
                    
                    // Hide the loading indicator
                    setTimeout(() => {
                        successIndicator.classList.add('hidden');
                    }, 1500);
                });
            });
            
            // Copy Link functionality
            document.getElementById('copyLinkBtn').addEventListener('click', function() {
                // Create a shareable URL with loan details as query parameters
                const url = new URL(window.location.href);
                url.search = '';
                
                // Get the loan data to include
                const loanData = {
                    name: customerNameInput.value,
                    loan: loanAmountInput.value,
                    tenure: tenureMonthsInput.value,
                    rate: reducingRateInput.value,
                    emi: emiInput.value.replace(/,/g, ''),
                    type: loanTypeSelect.value
                };
                
                // Add params to URL
                Object.keys(loanData).forEach(key => {
                    if (loanData[key]) {
                        url.searchParams.append(key, loanData[key]);
                    }
                });
                
                // Copy to clipboard
                navigator.clipboard.writeText(url.toString())
                    .then(() => {
                        showSuccess('Link copied to clipboard!');
                    })
                    .catch(err => {
                        showSuccess('Error copying link: ' + err);
                    });
            });
            
            // Email Details functionality
            document.getElementById('emailDetailsBtn').addEventListener('click', function() {
                const customerName = customerNameInput.value.trim() || 'Customer';
                const loanAmount = loanAmountInput.value || '0';
                const tenure = tenureMonthsInput.value || '0';
                const rate = reducingRateInput.value || '0';
                const emi = emiInput.value || '0';
                const totalPayment = totalPaymentInput.value || '0';
                
                const subject = `Loan Details for ${customerName}`;
                const body = `
Dear ${customerName},

Here are the details of your loan:

Loan Amount: AED ${loanAmount}
Tenure: ${tenure} months
Reducing Interest Rate: ${rate}%
Monthly EMI: ${emi}
Total Payment: ${totalPayment}

Please feel free to contact us if you have any questions.

Best regards,
Your Loan Officer
                `.trim();
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.location.href = mailtoLink;
            });
            
            // Print Page functionality
            printPageBtn.addEventListener('click', function() {
                // Create a new window for printing
                const printWindow = window.open('', '_blank');
                
                // Get the loan info container content
                const loanInfoContainer = document.querySelector('.loan-info-container').cloneNode(true);
                
                // Create a style element with necessary CSS
                const styleElement = document.createElement('style');
                styleElement.textContent = `
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    h2 { text-align: center; margin-bottom: 20px; }
                    .grid-cols-2 { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
                    .border { border: 1px solid #ddd; border-radius: 5px; overflow: hidden; flex: 1; min-width: 300px; }
                    table { width: 100%; border-collapse: collapse; }
                    td { padding: 8px; border-bottom: 1px solid #ddd; }
                    td:first-child { background-color: #f5f5f5; font-weight: bold; width: 50%; }
                    h3 { margin-top: 20px; margin-bottom: 10px; }
                    .emi-table { width: 100%; border-collapse: collapse; }
                    .emi-table th { background-color: #158078; color: white; text-align: center; padding: 6px; border: 1px solid #ddd; }
                    .emi-table td { text-align: right; padding: 4px 6px; border: 1px solid #ddd; }
                    .emi-table td:first-child { text-align: center; }
                    @media print { body { margin: 0; } }
                `;
                
                // Set print window content
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Loan Information</title>
                        ${styleElement.outerHTML}
                    </head>
                    <body>
                        <h2>Loan Information</h2>
                        ${loanInfoContainer.outerHTML}
                    </body>
                    </html>
                `);
                
                // Wait for content to load, then print
                printWindow.document.close();
                printWindow.onload = function() {
                    printWindow.print();
                    // Close after printing (optional, can be removed if you want the window to stay open)
                    printWindow.onafterprint = function() {
                        printWindow.close();
                    };
                };
            });
            
            // Function to prepare WhatsApp message
            function prepareWhatsAppMessage() {
                const maxLoanEligibility = parseFloat(maxLoanEligibilityInput.value.replace(/,/g, '')) || 0;
                const tenureMonths = parseInt(tenureMonthsInput.value) || 0;
                const loanAmount = parseFloat(loanAmountInput.value) || 0;
                const reducingRate = parseFloat(reducingRateInput.value) || 0;
                const flatRate = parseFloat(flatRateInput.value) || 0;
                const emi = parseFloat(emiInput.value.replace(/,/g, '')) || 0;
                const totalPayment = parseFloat(totalPaymentInput.value.replace(/,/g, '')) || 0;
                const totalInterest = parseFloat(totalInterestInput.value.replace(/,/g, '')) || 0;
                const processingFees = parseFloat(processingFeesInput.value.replace(/,/g, '')) || 0;
                const cashInHand = parseFloat(cashInHandInput.value.replace(/,/g, '')) || 0;
                const dbrPercentage = parseFloat(dbrPercentageInput.value) || 0;
                const specialNoteText = specialNote.value;
                const totalOutstanding = parseFloat(totalOutstandingInput.value.replace(/,/g, '')) || 0;
                const loanType = loanTypeSelect.value;
                const grossSalary = parseFloat(grossSalaryInput.value.replace(/,/g, '')) || 0;
                const daysBetween = daysBetweenInput.value;
                const customerName = customerNameInput.value.trim();
                
                // Restructured message format based on request
                let message = "";
                
                if (customerName) {
                    message += `*Customer: ${customerName}*\n\n`;
                }
                
                // Heading 1 - Eligibility details
                message += "*Eligibility details*\n";
                message += `Max Loan Eligibity: AED ${formatNumber(maxLoanEligibility.toFixed(2))}\n`;
                message += `Loan Amount: AED ${formatNumber(loanAmount.toFixed(2))}\n`;
                message += `Tenure: ${tenureMonths} Months\n`;
                message += `Reducing Rate: ${reducingRate}%\n`;
                message += `Flat Rate: ${flatRate.toFixed(2)}%\n`;
                message += `EMI: AED ${formatNumber(emi.toFixed(2))}\n\n`;
                
                // Heading 2 - Charges
                message += "*Charges*\n";
                message += `Total Payment: AED ${formatNumber(totalPayment.toFixed(2))}\n`;
                message += `Total Profit/Interest: AED ${formatNumber(totalInterest.toFixed(2))}\n`;
                message += `Processing Fees + VAT: AED ${formatNumber(processingFees.toFixed(2))}\n`;
                message += `Insurance Fees: AED 0\n\n`;
                
                // Heading 3 - Liabilities & Other details
                message += "*Liabilities & Other details*\n";
                message += `Loan type: ${loanType.replace(/(fresh|topup|takeover)(-)(\d+)(-)(\d+)/i, (match, p1, p2, p3, p4, p5) => {
                    return `${p1.toLowerCase()} ${p3}-${p5} days`;
                })}\n`;
                message += `Grace period: ${daysBetween} days\n`;
                message += `Total Outstanding: AED ${formatNumber(totalOutstanding.toFixed(2))}\n`;
                message += `Cash In Hand: AED ${formatNumber(cashInHand.toFixed(2))}\n`;
                message += `Gross Salary: AED ${formatNumber(grossSalary.toFixed(2))}\n`;
                message += `DBR: ${dbrPercentage.toFixed(2)}%\n`;
                
                if (specialNoteText) {
                    message += `\n*Special Note:*\n${specialNoteText}\n`;
                }
                
                message += "\n-------------------------\n";
                message += "The specifics of the installment plan and associated offerings may vary slightly based on the information provided in your profile.";
                
                return encodeURIComponent(message);
            }
            
            // ==========================================
            // BUTTONS AND EVENT LISTENERS
            // ==========================================
            
            // Add Credit Card button
            let cardCount = 1;
            addCreditCardBtn.addEventListener('click', function() {
                cardCount++;
                const creditCardDiv = document.createElement('div');
                creditCardDiv.classList.add('credit-card-entry', 'mb-3');
                creditCardDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-gray-700 dark:text-gray-300 font-medium">Credit Card ${cardCount}:</label>
                        <button class="settle-card-btn bg-primary text-white px-4 py-1 rounded hover:bg-opacity-80">Settle</button>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <select class="card-bank-select border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                            <option value="ADCB">ADCB</option>
                            <option value="ENBD">ENBD</option>
                            <option value="EIB">EIB</option>
                            <option value="FAB">FAB</option>
                            <option value="ADIB">ADIB</option>
                            <option value="CBD">CBD</option>
                            <option value="HSBC">HSBC</option>
                            <option value="CITI">CITI</option>
                            <option value="SCB">SCB</option>
                            <option value="MASHREQ">MASHREQ</option>
                            <option value="DIB">DIB</option>
                            <option value="OTHER">OTHER</option>
                        </select>
                        <input type="number" placeholder="Credit Limit" class="credit-card-amount border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-1">
                        <input type="number" placeholder="Outstanding" class="credit-card-outstanding border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white col-span-2">
                    </div>
                `;
                creditCardsContainer.appendChild(creditCardDiv);
                
                // Enable remove button
                removeCreditCardBtn.disabled = false;
                
                // Add event listener to new credit card inputs
                const newCreditCardInput = creditCardDiv.querySelector('.credit-card-amount');
                newCreditCardInput.addEventListener('input', updateDBRCalculator);
                
                const newOutstandingInput = creditCardDiv.querySelector('.credit-card-outstanding');
                newOutstandingInput.addEventListener('input', updateDBRCalculator);
            });
            
            // Remove Credit Card button
            removeCreditCardBtn.addEventListener('click', function() {
                if (cardCount > 1) {
                    const creditCardEntries = document.querySelectorAll('.credit-card-entry');
                    const lastEntry = creditCardEntries[creditCardEntries.length - 1];
                    const lastEntryIndex = Array.from(document.querySelectorAll('.credit-card-entry')).indexOf(lastEntry);
                    
                    // Remove from settled cards if it was settled
                    if (settledCards.has(lastEntryIndex)) {
                        settledCards.delete(lastEntryIndex);
                    }
                    
                    // Remove the element
                    lastEntry.remove();
                    cardCount--;
                    
                    if (cardCount === 1) {
                        removeCreditCardBtn.disabled = true;
                    }
                    
                    updateDBRCalculator();
                }
            });
            
            // Add-back Type select event listener
            addbacksContainer.addEventListener('change', function(e) {
                if (e.target.classList.contains('addback-type')) {
                    createAddbackTypeFields(e.target);
                }
            });
            
            // Add More Add-back button
            addMoreAddbackBtn.addEventListener('click', function() {
                addbackCount++;
                
                const addbackDiv = document.createElement('div');
                addbackDiv.classList.add('grid', 'grid-cols-3', 'gap-3', 'items-center', 'addback-entry', 'mt-2');
                addbackDiv.innerHTML = `
                    <label class="text-gray-700 dark:text-gray-300 font-medium">Add-back ${addbackCount}:</label>
                    <div class="col-span-2">
                        <select class="addback-type border rounded-md p-2 text-base dark:bg-gray-800 dark:text-white w-full">
                            <option value="">Select Add-back Type</option>
                            <option value="hra">HRA</option>
                            <option value="airfare">Airfare Allowance</option>
                            <option value="overtime">Over-time</option>
                            <option value="servicecharge">Service Charge</option>
                            <option value="incentives">Incentives</option>
                            <option value="telephone">Telephone Allowance</option>
                        </select>
                    </div>
                `;
                
                addbacksContainer.appendChild(addbackDiv);
                
                // Enable remove button once we have more than one addback
                removeAddbackBtn.disabled = false;
            });
            
            // Remove Add-back button
            removeAddbackBtn.addEventListener('click', function() {
                if (addbackCount > 1) {
                    const addbackEntries = addbacksContainer.querySelectorAll('.addback-entry');
                    const lastAddbackEntry = addbackEntries[addbackEntries.length - 1];
                    
                    // Get index of the last entry to remove associated fields
                    const index = Array.from(addbacksContainer.querySelectorAll('.addback-entry')).indexOf(lastAddbackEntry);
                    
                    // Remove the entry
                    lastAddbackEntry.remove();
                    
                    // Remove associated fields if they exist
                    const fieldsContainer = document.getElementById(`addback-fields-${index}`);
                    if (fieldsContainer) {
                        fieldsContainer.remove();
                    }
                    
                    // Delete data for this addback
                    delete addbackData[index];
                    
                    // Decrement counter
                    addbackCount--;
                    
                    // Disable remove button if only one entry remains
                    if (addbackCount === 1) {
                        removeAddbackBtn.disabled = true;
                    }
                    
                    // Update calculations
                    updateGrossSalary();
                }
            });
            
            // Reset button
            resetBtn.addEventListener('click', function() {
                customerNameInput.value = '';
                salaryInput.value = '';
                grossSalaryInput.value = '';
                document.querySelector('.credit-card-amount').value = '';
                document.querySelector('.credit-card-outstanding').value = '';
                loanTypeSelect.value = 'fresh-0-30';
                multiplesOfSalaryInput.value = '15';
                tenureMonthsInput.value = '48';
                loanAmountInput.value = '';
                reducingRateInput.value = '10';
                specialNote.value = '';
                dbrRateToggle.checked = false;
                
                // Clear settled cards and loans set
                settledCards.clear();
                settledLoans.clear();
                
                // Remove extra credit cards
                const creditCardEntries = document.querySelectorAll('.credit-card-entry');
                for (let i = 1; i < creditCardEntries.length; i++) {
                    creditCardEntries[i].remove();
                }
                cardCount = 1;
                removeCreditCardBtn.disabled = true;
                
                // Remove "settled" class from first card
                const firstCardEntry = document.querySelector('.credit-card-entry');
                firstCardEntry.classList.remove('card-settled');
                const firstSettleBtn = firstCardEntry.querySelector('.settle-card-btn');
                firstSettleBtn.textContent = 'Settle';
                firstSettleBtn.classList.remove('bg-red-500');
                firstSettleBtn.classList.add('bg-primary');
                
                // Remove existing loans
                existingLoansContainer.innerHTML = '';
                existingLoansContainer.classList.add('hidden');
                existingLoanCount = 0;
                
                // Remove extra addbacks
                const addbackEntries = document.querySelectorAll('.addback-entry');
                for (let i = 1; i < addbackEntries.length; i++) {
                    addbackEntries[i].remove();
                }
                addbackCount = 1;
                removeAddbackBtn.disabled = true;
                
                // Clear addback fields and data
                dynamicAddbackFields.innerHTML = '';
                addbackData = {};
                
                // Clear first addback dropdown
                const firstAddbackSelect = document.querySelector('.addback-type');
                if (firstAddbackSelect) {
                    firstAddbackSelect.value = '';
                }
                
                // Reset dates
                const today = new Date();
                disbursalDateInput.value = today.toISOString().split('T')[0];
                const nextMonth = new Date(today);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                firstPaymentDateInput.value = nextMonth.toISOString().split('T')[0];
                updateDaysBetween(); // Calculate days between
                
                // Reset saved profiles dropdown
                savedProfilesSelect.value = '';
                
                // Remove lastUsedProfile from localStorage
                localStorage.removeItem('lastUsedProfile');
                
                // Remove any warning flashes
                dbrCalculatorSection.classList.remove('dbr-warning-flash');
                emiCalculatorSection.classList.remove('dbr-warning-flash');
                
                // Remove high DBR styling
                dbrPercentageInput.classList.remove('dbr-high');
                
                // Update calculations
                updateDBRCalculator();
                updateEMICalculator();
            });
            
            // Input event listeners
            salaryInput.addEventListener('input', updateGrossSalary);
            
            // Add event listeners to initial credit card inputs
            document.querySelector('.credit-card-amount').addEventListener('input', updateDBRCalculator);
            document.querySelector('.credit-card-outstanding').addEventListener('input', updateDBRCalculator);
            
            loanTypeSelect.addEventListener('change', function() {
                adjustFirstPaymentDate();
                validatePaymentDate();
                updateDaysBetween();
                updateEMICalculator();
            });
            
            multiplesOfSalaryInput.addEventListener('input', updateEMICalculator);
            tenureMonthsInput.addEventListener('input', updateEMICalculator);
            loanAmountInput.addEventListener('input', function() {
                checkLoanAmountWithDBR();
                updateEMICalculator();
            });
            reducingRateInput.addEventListener('input', updateEMICalculator);
            
            // Date validation and days between calculation
            disbursalDateInput.addEventListener('change', function() {
                validatePaymentDate();
                updateDaysBetween();
                updateEMICalculator();
            });
            
            firstPaymentDateInput.addEventListener('change', function() {
                validatePaymentDate();
                updateDaysBetween();
                updateEMICalculator();
            });
            
            // Bank comparison inputs
            bank1LoanAmountInput.addEventListener('input', updateBankComparison);
            bank1TenureInput.addEventListener('input', updateBankComparison);
            bank1RateInput.addEventListener('input', updateBankComparison);
            bank1NameInput.addEventListener('input', updateBankComparison);
            bank2LoanAmountInput.addEventListener('input', updateBankComparison);
            bank2TenureInput.addEventListener('input', updateBankComparison);
            bank2RateInput.addEventListener('input', updateBankComparison);
            bank2NameInput.addEventListener('input', updateBankComparison);
            
            // Find Optimal Loan button
            findOptimalLoanBtn.addEventListener('click', findOptimalLoanAmount);
            
            // Send to WhatsApp button
            sendWhatsAppBtn.addEventListener('click', function() {
                const phoneNumber = whatsappNumberInput.value.replace(/\D/g, '');
                if (!phoneNumber) {
                    showSuccess('Please Enter A Valid WhatsApp Number');
                    return;
                }
                
                const message = prepareWhatsAppMessage();
                window.open(`https://wa.me/${phoneNumber}?text=${message}`, '_blank');
            });
            
            // Initialize calculations
            updateGrossSalary();
            updateDBRCalculator();
            updateEMICalculator();
            
            // Check if URL has query parameters to load a shared loan
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('loan')) {
                const loanAmount = urlParams.get('loan');
                const tenure = urlParams.get('tenure');
                const rate = urlParams.get('rate');
                const name = urlParams.get('name');
                const type = urlParams.get('type');
                
                // Load values from URL
                if (loanAmount) loanAmountInput.value = loanAmount;
                if (tenure) tenureMonthsInput.value = tenure;
                if (rate) reducingRateInput.value = rate;
                if (name) customerNameInput.value = name;
                if (type) loanTypeSelect.value = type;
                
                // Update calculations
                updateEMICalculator();
                
                // Show success message
                showSuccess('Loan details loaded from shared link');
            }
        });
    </script>
</body>
</html>